

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>forgi.threedee.utilities.pdb &#8212; forgi 2.0.0 documentation</title>
    <link rel="stylesheet" href="../../../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/print.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '2.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../../_static/theme_extras.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../../../../index.html">
          <span>forgi 2.0.0 documentation</span></a></h1>
      </div>
      <div class="topnav">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for forgi.threedee.utilities.pdb</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">zip</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">range</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">Bio.PDB</span> <span class="k">as</span> <span class="nn">bpdb</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>

<span class="kn">import</span> <span class="nn">forgi.utilities.debug</span> <span class="k">as</span> <span class="nn">fud</span>
<span class="kn">import</span> <span class="nn">forgi.threedee.utilities.vector</span> <span class="k">as</span> <span class="nn">ftuv</span>
<span class="kn">from</span> <span class="nn">forgi.threedee.utilities.modified_res</span> <span class="k">import</span> <span class="n">to_4_letter_alphabeth</span>
<span class="kn">import</span> <span class="nn">forgi.graph.residue</span> <span class="k">as</span> <span class="nn">fgr</span>

<span class="kn">from</span> <span class="nn">logging_exceptions</span> <span class="k">import</span> <span class="n">log_to_exception</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="AtomName"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.AtomName">[docs]</a><span class="k">class</span> <span class="nc">AtomName</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Like a string, but &quot;C1&#39;&quot; and &quot;C1*&quot; compare equal</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">):</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">other</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">):</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div>


<span class="n">backbone_atoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">AtomName</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s2">&quot;O5&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C5&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C4&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;O3&#39;&quot;</span><span class="p">]))</span>
<span class="n">ring_atoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">AtomName</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;C4&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;O4&#39;&quot;</span><span class="p">]))</span>

<span class="n">nonsidechain_atoms</span> <span class="o">=</span> <span class="n">backbone_atoms</span> <span class="o">+</span> <span class="n">ring_atoms</span>

<span class="n">chi_torsion_atoms</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">chi_torsion_atoms</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chi_torsion_atoms</span><span class="p">[</span><span class="s1">&#39;G&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
    <span class="nb">map</span><span class="p">(</span><span class="n">AtomName</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;O4&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;N9&quot;</span><span class="p">,</span> <span class="s2">&quot;C4&quot;</span><span class="p">]))</span>
<span class="n">chi_torsion_atoms</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chi_torsion_atoms</span><span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
    <span class="nb">map</span><span class="p">(</span><span class="n">AtomName</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;O4&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;N1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">]))</span>

<span class="n">side_chain_atoms</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">side_chain_atoms</span><span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
    <span class="nb">map</span><span class="p">(</span><span class="n">AtomName</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;N1&#39;</span><span class="p">,</span> <span class="s1">&#39;C2&#39;</span><span class="p">,</span> <span class="s1">&#39;O2&#39;</span><span class="p">,</span> <span class="s1">&#39;N3&#39;</span><span class="p">,</span> <span class="s1">&#39;C4&#39;</span><span class="p">,</span> <span class="s1">&#39;O4&#39;</span><span class="p">,</span> <span class="s1">&#39;C5&#39;</span><span class="p">,</span> <span class="s1">&#39;C6&#39;</span><span class="p">]))</span>
<span class="n">side_chain_atoms</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
    <span class="nb">map</span><span class="p">(</span><span class="n">AtomName</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;N1&#39;</span><span class="p">,</span> <span class="s1">&#39;C2&#39;</span><span class="p">,</span> <span class="s1">&#39;O2&#39;</span><span class="p">,</span> <span class="s1">&#39;N3&#39;</span><span class="p">,</span> <span class="s1">&#39;C4&#39;</span><span class="p">,</span> <span class="s1">&#39;N4&#39;</span><span class="p">,</span> <span class="s1">&#39;C5&#39;</span><span class="p">,</span> <span class="s1">&#39;C6&#39;</span><span class="p">]))</span>

<span class="n">side_chain_atoms</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
    <span class="nb">map</span><span class="p">(</span><span class="n">AtomName</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;N1&#39;</span><span class="p">,</span> <span class="s1">&#39;C2&#39;</span><span class="p">,</span> <span class="s1">&#39;N3&#39;</span><span class="p">,</span> <span class="s1">&#39;C4&#39;</span><span class="p">,</span> <span class="s1">&#39;C5&#39;</span><span class="p">,</span> <span class="s1">&#39;C6&#39;</span><span class="p">,</span> <span class="s1">&#39;N6&#39;</span><span class="p">,</span> <span class="s1">&#39;N7&#39;</span><span class="p">,</span> <span class="s1">&#39;C8&#39;</span><span class="p">,</span> <span class="s1">&#39;N9&#39;</span><span class="p">]))</span>
<span class="n">side_chain_atoms</span><span class="p">[</span><span class="s1">&#39;G&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
    <span class="nb">map</span><span class="p">(</span><span class="n">AtomName</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;N1&#39;</span><span class="p">,</span> <span class="s1">&#39;C2&#39;</span><span class="p">,</span> <span class="s1">&#39;N2&#39;</span><span class="p">,</span> <span class="s1">&#39;N3&#39;</span><span class="p">,</span> <span class="s1">&#39;C4&#39;</span><span class="p">,</span> <span class="s1">&#39;C5&#39;</span><span class="p">,</span> <span class="s1">&#39;C6&#39;</span><span class="p">,</span> <span class="s1">&#39;O6&#39;</span><span class="p">,</span> <span class="s1">&#39;N7&#39;</span><span class="p">,</span> <span class="s1">&#39;C8&#39;</span><span class="p">,</span> <span class="s1">&#39;N9&#39;</span><span class="p">]))</span>

<span class="n">all_side_chains</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
    <span class="n">side_chain_atoms</span><span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">side_chain_atoms</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">side_chain_atoms</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">side_chain_atoms</span><span class="p">[</span><span class="s1">&#39;G&#39;</span><span class="p">])</span>

<span class="n">all_rna_atoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nonsidechain_atoms</span><span class="p">)</span> <span class="o">|</span> <span class="n">all_side_chains</span>

<span class="n">RNA_RESIDUES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s1">&#39;rA&#39;</span><span class="p">,</span> <span class="s1">&#39;rC&#39;</span><span class="p">,</span> <span class="s1">&#39;rG&#39;</span><span class="p">,</span> <span class="s1">&#39;rU&#39;</span><span class="p">,</span> <span class="s1">&#39;DU&#39;</span><span class="p">]</span>

<span class="n">interactions</span> <span class="o">=</span> <span class="p">[(</span><span class="n">AtomName</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">AtomName</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">sorted</span><span class="p">,</span>
                                                           <span class="p">[(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s2">&quot;O5&#39;&quot;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;OP1&#39;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;O1P&#39;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;OP2&#39;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;O2P&#39;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s2">&quot;C2&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;O2&#39;&quot;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s2">&quot;O5&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C5&#39;&quot;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s2">&quot;C5&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C4&#39;&quot;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s2">&quot;C4&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;O4&#39;&quot;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s2">&quot;C4&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&#39;&quot;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s2">&quot;O4&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&#39;&quot;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s2">&quot;C3&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&#39;&quot;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s2">&quot;C3&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;O3&#39;&quot;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s2">&quot;C2&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&#39;&quot;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;N1&quot;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s1">&#39;N1&#39;</span><span class="p">,</span> <span class="s1">&#39;C2&#39;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s1">&#39;N1&#39;</span><span class="p">,</span> <span class="s1">&#39;C6&#39;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s1">&#39;C6&#39;</span><span class="p">,</span> <span class="s1">&#39;C5&#39;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s1">&#39;C5&#39;</span><span class="p">,</span> <span class="s1">&#39;C4&#39;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s1">&#39;C4&#39;</span><span class="p">,</span> <span class="s1">&#39;O4&#39;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s1">&#39;C4&#39;</span><span class="p">,</span> <span class="s1">&#39;N4&#39;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s1">&#39;C4&#39;</span><span class="p">,</span> <span class="s1">&#39;N3&#39;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s1">&#39;N3&#39;</span><span class="p">,</span> <span class="s1">&#39;C2&#39;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s1">&#39;C2&#39;</span><span class="p">,</span> <span class="s1">&#39;O2&#39;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s1">&#39;C2&#39;</span><span class="p">,</span> <span class="s1">&#39;N2&#39;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;N9&quot;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s1">&#39;N9&#39;</span><span class="p">,</span> <span class="s1">&#39;C8&#39;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s1">&#39;N9&#39;</span><span class="p">,</span> <span class="s1">&#39;C4&#39;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s1">&#39;C8&#39;</span><span class="p">,</span> <span class="s1">&#39;N7&#39;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s1">&#39;N7&#39;</span><span class="p">,</span> <span class="s1">&#39;C5&#39;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s1">&#39;C6&#39;</span><span class="p">,</span> <span class="s1">&#39;O6&#39;</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="s1">&#39;C6&#39;</span><span class="p">,</span> <span class="s1">&#39;N6&#39;</span><span class="p">)])]</span>



<div class="viewcode-block" id="trim_chain_between"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.trim_chain_between">[docs]</a><span class="k">def</span> <span class="nf">trim_chain_between</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">start_res</span><span class="p">,</span> <span class="n">end_res</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Remove all nucleotides between start_res and end_res, inclusive.</span>

<span class="sd">    The chain is modified in place so there is no return value.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">to_detach</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">start_res</span> <span class="o">&lt;=</span> <span class="n">res</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">res</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">end_res</span><span class="p">:</span>
            <span class="n">to_detach</span> <span class="o">+=</span> <span class="p">[</span><span class="n">res</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">to_detach</span><span class="p">:</span>
        <span class="n">chain</span><span class="o">.</span><span class="n">detach_child</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></div>


<div class="viewcode-block" id="extract_subchains_from_seq_ids"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.extract_subchains_from_seq_ids">[docs]</a><span class="k">def</span> <span class="nf">extract_subchains_from_seq_ids</span><span class="p">(</span><span class="n">all_chains</span><span class="p">,</span> <span class="n">seq_ids</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Extract a portion of one or more pdb chains.</span>
<span class="sd">    Creates a list of new chains which contain only</span>
<span class="sd">    the specified residues copied from the original chain.</span>

<span class="sd">    The chain ids are not modified.</span>

<span class="sd">    :param all_chains: A dictionary {chainid:chains}.</span>
<span class="sd">    :param seq_ids: An iterable of complete RESIDS.</span>

<span class="sd">    :returns: A dictionary chain-id:Bio.PDB.Chain.Chain objects</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">new_chains</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">all_chains</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">seq_ids</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">chain</span> <span class="ow">in</span> <span class="n">new_chains</span><span class="p">:</span>
            <span class="n">chain</span> <span class="o">=</span> <span class="n">new_chains</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">chain</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chain</span> <span class="o">=</span> <span class="n">new_chains</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">chain</span><span class="p">]</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">Chain</span><span class="o">.</span><span class="n">Chain</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">chain</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">chain</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">all_chains</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">r</span><span class="o">.</span><span class="n">resid</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_chains</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">chain</span><span class="p">]</span><span class="o">.</span><span class="n">child_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
            <span class="k">raise</span>
    <span class="k">return</span> <span class="n">new_chains</span></div>


<div class="viewcode-block" id="is_covalent"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.is_covalent">[docs]</a><span class="k">def</span> <span class="nf">is_covalent</span><span class="p">(</span><span class="n">contact</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Determine if a particular contact is covalent.</span>

<span class="sd">    This does not look at the geometric distance but only at the atom names.</span>

<span class="sd">    :param contact: A pair of two Atom objects</span>
<span class="sd">    :return: `True` if they are covalently bonded</span>
<span class="sd">             `False` otherwise</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="n">contact</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">contact</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span>

    <span class="n">r1a</span> <span class="o">=</span> <span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">contact</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">r2a</span> <span class="o">=</span> <span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">contact</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">contact</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">contact</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="p">((</span><span class="n">r1</span><span class="p">,</span> <span class="n">c1</span><span class="p">),</span> <span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">c2</span><span class="p">))</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">((</span><span class="n">r1a</span><span class="p">,</span> <span class="n">r2a</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">r1</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">r2</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">c1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">c2</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span> <span class="ow">in</span> <span class="n">interactions</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">r2</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">r1</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># neighboring residues</span>
        <span class="k">if</span> <span class="n">c1</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;O3*&#39;</span> <span class="ow">and</span> <span class="n">c2</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="num_noncovalent_clashes"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.num_noncovalent_clashes">[docs]</a><span class="k">def</span> <span class="nf">num_noncovalent_clashes</span><span class="p">(</span><span class="n">chain</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Check if a chain has non-covalent clashes. Non-covalent clashes are found</span>
<span class="sd">    when two atoms that aren&#39;t covalently linked are within 1.8 A of each other.</span>

<span class="sd">    :param chain: The chain to evaluate</span>
<span class="sd">    :param return: The number of non-covalent clashes.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">all_atoms</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">Selection</span><span class="o">.</span><span class="n">unfold_entities</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">NeighborSearch</span><span class="p">(</span><span class="n">all_atoms</span><span class="p">)</span>

    <span class="n">contacts</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">search_all</span><span class="p">(</span><span class="mf">1.9</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">len</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contacts</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_covalent</span><span class="p">(</span><span class="n">c</span><span class="p">)])</span></div>


<div class="viewcode-block" id="noncovalent_distances"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.noncovalent_distances">[docs]</a><span class="k">def</span> <span class="nf">noncovalent_distances</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Print out the distances between all non-covalently bonded atoms</span>
<span class="sd">    which are closer than cutoff to each other.</span>

<span class="sd">    :param chain: The Bio.PDB chain.</span>
<span class="sd">    :param cutoff: The maximum distance</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">all_atoms</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">Selection</span><span class="o">.</span><span class="n">unfold_entities</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">NeighborSearch</span><span class="p">(</span><span class="n">all_atoms</span><span class="p">)</span>

    <span class="n">contacts</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">search_all</span><span class="p">(</span><span class="n">cutoff</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">ftuv</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contacts</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_covalent</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span></div>



<div class="viewcode-block" id="pdb_rmsd"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.pdb_rmsd">[docs]</a><span class="k">def</span> <span class="nf">pdb_rmsd</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">sidechains</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">superimpose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate the all-atom rmsd between two RNA chains.</span>

<span class="sd">    :param c1: A Bio.PDB.Chain</span>
<span class="sd">    :param c2: Another Bio.PDB.Chain</span>
<span class="sd">    :return: The rmsd between the locations of all the atoms in the chains.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">c1_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cr</span> <span class="k">for</span> <span class="n">cr</span> <span class="ow">in</span> <span class="n">c1</span><span class="o">.</span><span class="n">get_list</span><span class="p">()</span> <span class="k">if</span> <span class="n">cr</span><span class="o">.</span><span class="n">resname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
               <span class="ow">in</span> <span class="n">RNA_RESIDUES</span><span class="p">]</span>
    <span class="n">c2_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cr</span> <span class="k">for</span> <span class="n">cr</span> <span class="ow">in</span> <span class="n">c2</span><span class="o">.</span><span class="n">get_list</span><span class="p">()</span> <span class="k">if</span> <span class="n">cr</span><span class="o">.</span><span class="n">resname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
               <span class="ow">in</span> <span class="n">RNA_RESIDUES</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">residuelist_rmsd</span><span class="p">(</span><span class="n">c1_list</span><span class="p">,</span> <span class="n">c2_list</span><span class="p">,</span> <span class="n">sidechains</span><span class="p">,</span> <span class="n">superimpose</span> <span class="p">)</span></div>

<div class="viewcode-block" id="residuelist_rmsd"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.residuelist_rmsd">[docs]</a><span class="k">def</span> <span class="nf">residuelist_rmsd</span><span class="p">(</span><span class="n">c1_list</span><span class="p">,</span> <span class="n">c2_list</span><span class="p">,</span> <span class="n">sidechains</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">superimpose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">forgi.threedee.model.similarity</span> <span class="k">as</span> <span class="nn">ftms</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c1_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c2_list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s2">&quot;Chains of different length. (Maybe an RNA-DNA hybrid?)&quot;</span><span class="p">)</span>

    <span class="c1">#c1_list.sort(key=lambda x: x.id[1])</span>
    <span class="c1">#c2_list.sort(key=lambda x: x.id[1])</span>
    <span class="n">to_residues</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">crds1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">crds2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_atoms1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_atoms2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">c1_list</span><span class="p">,</span> <span class="n">c2_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sidechains</span><span class="p">:</span>
            <span class="n">anames</span> <span class="o">=</span> <span class="n">nonsidechain_atoms</span> <span class="o">+</span> \
                <span class="n">side_chain_atoms</span><span class="p">[</span><span class="n">r1</span><span class="o">.</span><span class="n">resname</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">anames</span> <span class="o">=</span> <span class="n">nonsidechain_atoms</span>
        <span class="c1">#anames = a_5_names + a_3_names</span>

        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">anames</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">at1</span> <span class="o">=</span> <span class="n">r1</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                <span class="n">at2</span> <span class="o">=</span> <span class="n">r2</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_atoms1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">at1</span><span class="p">)</span>
                <span class="n">all_atoms2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">at2</span><span class="p">)</span>
                <span class="n">crds1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">at1</span><span class="o">.</span><span class="n">coord</span><span class="p">)</span>
                <span class="n">crds2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">at2</span><span class="o">.</span><span class="n">coord</span><span class="p">)</span>
                <span class="n">to_residues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>

    <span class="n">diff_vecs</span> <span class="o">=</span> <span class="n">ftms</span><span class="o">.</span><span class="n">_pointwise_deviation</span><span class="p">(</span><span class="n">crds1</span><span class="p">,</span> <span class="n">crds2</span><span class="p">)</span>
    <span class="n">dev_per_res</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">to_residues</span><span class="p">):</span>
        <span class="n">dev_per_res</span><span class="p">[</span><span class="n">res</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diff_vecs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">superimpose</span><span class="p">:</span>
        <span class="n">sup</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">Superimposer</span><span class="p">()</span>
        <span class="n">sup</span><span class="o">.</span><span class="n">set_atoms</span><span class="p">(</span><span class="n">all_atoms1</span><span class="p">,</span> <span class="n">all_atoms2</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_atoms1</span><span class="p">),</span> <span class="n">sup</span><span class="o">.</span><span class="n">rms</span><span class="p">,</span> <span class="n">sup</span><span class="o">.</span><span class="n">rotran</span><span class="p">,</span> <span class="n">dev_per_res</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_atoms1</span><span class="p">),</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">_vector_set_rmsd</span><span class="p">(</span><span class="n">crds1</span><span class="p">,</span> <span class="n">crds2</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dev_per_res</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_first_chain"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.get_first_chain">[docs]</a><span class="k">def</span> <span class="nf">get_first_chain</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Load a PDB file using the Bio.PDB module and return the first chain.</span>

<span class="sd">    :param filename: The path to the pdb file</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">PDBParser</span><span class="p">(</span><span class="n">PERMISSIVE</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">get_structure</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">get_chains</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="pdb_file_rmsd"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.pdb_file_rmsd">[docs]</a><span class="k">def</span> <span class="nf">pdb_file_rmsd</span><span class="p">(</span><span class="n">fn1</span><span class="p">,</span> <span class="n">fn2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate the RMSD of all the atoms in two pdb structures.</span>

<span class="sd">    :param fn1: The first filename.</span>
<span class="sd">    :param fn2: The second filename.</span>
<span class="sd">    :return: The rmsd between the two structures.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

        <span class="n">s1</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">PDBParser</span><span class="p">()</span><span class="o">.</span><span class="n">get_structure</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">fn1</span><span class="p">)</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">PDBParser</span><span class="p">()</span><span class="o">.</span><span class="n">get_structure</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">fn2</span><span class="p">)</span>

    <span class="n">c1</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_biggest_chain</span><span class="p">(</span><span class="n">fn1</span><span class="p">)</span>
    <span class="n">c2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_biggest_chain</span><span class="p">(</span><span class="n">fn2</span><span class="p">)</span>

    <span class="n">rmsd</span> <span class="o">=</span> <span class="n">pdb_rmsd</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rmsd</span></div>


<div class="viewcode-block" id="renumber_chain"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.renumber_chain">[docs]</a><span class="k">def</span> <span class="nf">renumber_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">resids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Renumber all the residues in this chain so that they start at 1 and end at</span>
<span class="sd">    len(chain)</span>

<span class="sd">    :param chain: A Bio.PDB.Chain object</span>
<span class="sd">    :return: The same chain, but with renamed nucleotides</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">resids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">resids</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="p">))]</span>

    <span class="n">new_child_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">new_child_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">res</span><span class="p">,</span> <span class="n">r_new</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">resids</span><span class="p">):</span>
        <span class="n">res</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">r_new</span>
        <span class="n">new_child_dict</span><span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
        <span class="n">new_child_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="n">chain</span><span class="o">.</span><span class="n">child_dict</span> <span class="o">=</span> <span class="n">new_child_dict</span>
    <span class="n">chain</span><span class="o">.</span><span class="n">child_list</span> <span class="o">=</span> <span class="n">new_child_list</span>

    <span class="k">return</span> <span class="n">chain</span></div>


<div class="viewcode-block" id="output_chain"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.output_chain">[docs]</a><span class="k">def</span> <span class="nf">output_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">fr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Dump a chain to an output file. Remove the hydrogen atoms.</span>

<span class="sd">    :param chain: The Bio.PDB.Chain to dump.</span>
<span class="sd">    :param filename: The place to dump it.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">class</span> <span class="nc">HSelect</span><span class="p">(</span><span class="n">bpdb</span><span class="o">.</span><span class="n">Select</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">accept_atom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">Structure</span><span class="o">.</span><span class="n">Structure</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

    <span class="n">m</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="n">io</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">PDBIO</span><span class="p">()</span>
    <span class="n">io</span><span class="o">.</span><span class="n">set_structure</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">HSelect</span><span class="p">())</span></div>


<div class="viewcode-block" id="output_multiple_chains"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.output_multiple_chains">[docs]</a><span class="k">def</span> <span class="nf">output_multiple_chains</span><span class="p">(</span><span class="n">chains</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">file_type</span><span class="o">=</span><span class="s2">&quot;pdb&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Dump multiple chains to an output file. Remove the hydrogen atoms.</span>

<span class="sd">    :param chains: An iterable of Bio.PDB.Chain to dump.</span>
<span class="sd">    :param filename: The place to dump it.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">class</span> <span class="nc">HSelect</span><span class="p">(</span><span class="n">bpdb</span><span class="o">.</span><span class="n">Select</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">accept_atom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">Structure</span><span class="o">.</span><span class="n">Structure</span><span class="p">(</span><span class="s1">&#39;stru&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding chain </span><span class="si">%s</span><span class="s2"> with </span><span class="si">%s</span><span class="s2"> residues&quot;</span><span class="p">,</span> <span class="n">chain</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="p">))</span>
        <span class="n">m</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_type</span><span class="o">==</span><span class="s2">&quot;pdb&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot save chain with name </span><span class="si">%s</span><span class="s2"> (not a single character) &quot;</span>
                             <span class="s2">&quot;in PDB format. Use cif format instead!&quot;</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;pdb&quot;</span><span class="p">:</span>
        <span class="n">io</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">PDBIO</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">io</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">MMCIFIO</span><span class="p">()</span>
    <span class="n">io</span><span class="o">.</span><span class="n">set_structure</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">HSelect</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">log_to_exception</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not output PDB with chains and residues:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">chain</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">])</span>
        <span class="k">raise</span></div>


<div class="viewcode-block" id="get_particular_chain"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.get_particular_chain">[docs]</a><span class="k">def</span> <span class="nf">get_particular_chain</span><span class="p">(</span><span class="n">in_filename</span><span class="p">,</span> <span class="n">chain_id</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Load a PDB file and return a particular chain.</span>

<span class="sd">    :param in_filename: The name of the pdb file.</span>
<span class="sd">    :param chain_id: The id of the chain.</span>
<span class="sd">    :return: A Bio.PDB.Chain object containing that particular chain.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">chains</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">ir</span> <span class="o">=</span> <span class="n">get_all_chains</span><span class="p">(</span><span class="n">in_filename</span><span class="p">,</span> <span class="n">parser</span><span class="p">)</span>
    <span class="n">chain</span><span class="p">,</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chains</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">chain_id</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">chain</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">ir</span></div>


<div class="viewcode-block" id="get_biggest_chain"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.get_biggest_chain">[docs]</a><span class="k">def</span> <span class="nf">get_biggest_chain</span><span class="p">(</span><span class="n">in_filename</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Load the PDB file located at filename, select the longest</span>
<span class="sd">    chain and return it.</span>

<span class="sd">    :param in_filename: The location of the original file.</span>
<span class="sd">    :return: A Bio.PDB chain structure corresponding to the longest</span>
<span class="sd">             chain in the structure stored in in_filename</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">chains</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">ir</span> <span class="o">=</span> <span class="n">get_all_chains</span><span class="p">(</span><span class="n">in_filename</span><span class="p">,</span> <span class="n">parser</span><span class="p">)</span>
    <span class="n">biggest</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">biggest_len</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chains</span><span class="p">)):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">chains</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Only count RNA residues</span>
        <span class="n">num_residues</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">resname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span> <span class="ow">or</span>
                <span class="n">res</span><span class="o">.</span><span class="n">resname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span> <span class="ow">or</span>
                <span class="n">res</span><span class="o">.</span><span class="n">resname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;G&#39;</span> <span class="ow">or</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">resname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">):</span>
                <span class="n">num_residues</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">num_residues</span> <span class="o">&gt;</span> <span class="n">biggest_len</span><span class="p">:</span>
            <span class="n">biggest</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">biggest_len</span> <span class="o">=</span> <span class="n">num_residues</span>

    <span class="c1"># sys.exit(1)</span>

    <span class="n">orig_chain</span> <span class="o">=</span> <span class="n">chains</span><span class="p">[</span><span class="n">biggest</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">orig_chain</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">ir</span></div>

<span class="k">def</span> <span class="nf">_extract_symmetrymatrices_from_cif_dict</span><span class="p">(</span><span class="n">cif_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Code originally by G. Entzian, modified</span>

<span class="sd">    Extract matrices for symmetry operations from the cif-dict to</span>
<span class="sd">    convert the assymetric unit to the biological unit</span>

<span class="sd">    :returns: A tuple matrices, vectors.</span>
<span class="sd">              matrices is a dictionary {operation_id: rot_matrix}</span>
<span class="sd">              vectors a dictionary {operation_id: vector}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">symmetry_ids</span> <span class="o">=</span> <span class="n">cif_dict</span><span class="p">[</span><span class="s2">&quot;_pdbx_struct_oper_list.id&quot;</span><span class="p">]</span>
    <span class="n">matrices</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="n">vectors</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">v_key</span> <span class="o">=</span> <span class="s1">&#39;_pdbx_struct_oper_list.vector[&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span>
        <span class="n">value_vectors</span> <span class="o">=</span> <span class="n">cif_dict</span><span class="p">[</span><span class="n">v_key</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value_vectors</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">value_vectors</span> <span class="o">=</span> <span class="p">[</span><span class="n">value_vectors</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value_vectors</span><span class="p">):</span>
            <span class="n">vectors</span><span class="p">[</span><span class="n">symmetry_ids</span><span class="p">[</span><span class="n">k</span><span class="p">]][</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;_pdbx_struct_oper_list.matrix[&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;][&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span>
            <span class="n">value_per_matrix</span> <span class="o">=</span> <span class="n">cif_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value_per_matrix</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">value_per_matrix</span> <span class="o">=</span> <span class="p">[</span><span class="n">value_per_matrix</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value_per_matrix</span><span class="p">):</span>
                <span class="n">matrices</span><span class="p">[</span><span class="n">symmetry_ids</span><span class="p">[</span><span class="n">k</span><span class="p">]][</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">matrices</span><span class="p">,</span> <span class="n">vectors</span>

<span class="k">def</span> <span class="nf">_convert_cif_operation_id_expression</span><span class="p">(</span><span class="n">expression</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    By Gregor Entzian</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tmp_expr</span> <span class="o">=</span> <span class="n">expression</span>
    <span class="n">op_id_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;\([\w\-\,\d]+\)&quot;</span><span class="p">,</span> <span class="n">tmp_expr</span><span class="p">)</span><span class="c1">#(&quot;(\d+)\-(\d+)&quot;, id)</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">match_s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;\((\d+)\-(\d+)\)&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match_s</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">match_s</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">match_s</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">t</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">op_id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
                <span class="n">tmp_expr</span> <span class="o">=</span> <span class="n">tmp_expr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#split &#39;,&#39; in case of more entries. In case of one entry use the same code.</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># remove parentheses</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
                    <span class="n">op_id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                <span class="n">tmp_expr</span> <span class="o">=</span> <span class="n">tmp_expr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
    <span class="k">if</span> <span class="n">tmp_expr</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tmp_expr</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">tmp_expr</span> <span class="o">=</span> <span class="n">tmp_expr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">tmp_expr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">match_s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;(\d+)\-(\d+)&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match_s</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">match_s</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">match_s</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">op_id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
                    <span class="k">continue</span>
                <span class="n">op_id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">op_id_list</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_extract_assembly_gen</span><span class="p">(</span><span class="n">cif_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts the information, how assemblies are generated out</span>
<span class="sd">    of the chains and symmetry operations, from the cifdict.</span>

<span class="sd">    :returns: A dictionary {assembly_id: [(chainid, operationids)...]}</span>
<span class="sd">              Where operation_ids is a list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">assembly_ids</span> <span class="o">=</span> <span class="n">cif_dict</span><span class="p">[</span><span class="s1">&#39;_pdbx_struct_assembly_gen.assembly_id&#39;</span><span class="p">]</span>       <span class="c1">#1</span>
    <span class="n">operation_ids</span> <span class="o">=</span> <span class="n">cif_dict</span><span class="p">[</span><span class="s1">&#39;_pdbx_struct_assembly_gen.oper_expression&#39;</span><span class="p">]</span>   <span class="c1">#1,2</span>
    <span class="n">chain_id_lists</span> <span class="o">=</span> <span class="n">cif_dict</span><span class="p">[</span><span class="s1">&#39;_pdbx_struct_assembly_gen.asym_id_list&#39;</span><span class="p">]</span>      <span class="c1">#A,B</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">assembly_ids</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">assembly_ids</span><span class="o">=</span><span class="p">[</span><span class="n">assembly_ids</span><span class="p">]</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operation_ids</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="n">operation_ids</span><span class="o">=</span><span class="p">[</span><span class="n">operation_ids</span><span class="p">]</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chain_id_lists</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="n">chain_id_lists</span><span class="o">=</span><span class="p">[</span><span class="n">chain_id_lists</span><span class="p">]</span>

    <span class="n">assembly_components</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span> <span class="c1"># assembly: operation-lists: chains</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">aid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">assembly_ids</span><span class="p">):</span>
        <span class="n">op_ids</span><span class="o">=</span><span class="n">_convert_cif_operation_id_expression</span><span class="p">(</span><span class="n">operation_ids</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">chain_ids</span><span class="o">=</span><span class="n">chain_id_lists</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">assembly_components</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">operation_ids</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">chain_id_lists</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">assembly_components</span>

<span class="k">def</span> <span class="nf">_get_new_chainid</span><span class="p">(</span><span class="n">chain_id</span><span class="p">,</span> <span class="n">op_id</span><span class="p">,</span> <span class="n">taken_ids</span><span class="p">):</span>
    <span class="n">new_id</span><span class="o">=</span> <span class="n">chain_id</span><span class="o">+</span><span class="s2">&quot;op&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">op_id</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">new_id</span> <span class="ow">in</span> <span class="n">taken_ids</span><span class="p">:</span>
        <span class="n">new_id</span><span class="o">+=</span><span class="s2">&quot;a&quot;</span>
    <span class="k">return</span> <span class="n">new_id</span>

<span class="k">def</span> <span class="nf">_extract_asym_auth_id_map</span><span class="p">(</span><span class="n">cif_dict</span><span class="p">):</span>
    <span class="n">label_ids</span> <span class="o">=</span> <span class="n">cif_dict</span><span class="p">[</span><span class="s1">&#39;_atom_site.label_asym_id&#39;</span><span class="p">]</span>
    <span class="n">auth_ids</span> <span class="o">=</span> <span class="n">cif_dict</span><span class="p">[</span><span class="s1">&#39;_atom_site.auth_asym_id&#39;</span><span class="p">]</span>
    <span class="n">l2a</span><span class="o">=</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">a2l</span><span class="o">=</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">label_ids</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lid</span> <span class="ow">in</span> <span class="n">l2a</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">l2a</span><span class="p">[</span><span class="n">lid</span><span class="p">]</span><span class="o">!=</span><span class="n">auth_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;lid </span><span class="si">%s</span><span class="s2">, authid </span><span class="si">%s</span><span class="s2"> but before </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">auth_ids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">l2a</span><span class="p">[</span><span class="n">lid</span><span class="p">])</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inconsistent cif.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l2a</span><span class="p">[</span><span class="n">lid</span><span class="p">]</span><span class="o">=</span><span class="n">auth_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">a2l</span><span class="p">[</span><span class="n">auth_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">l2a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">l2a</span><span class="p">,</span> <span class="n">a2l</span>

<span class="k">def</span> <span class="nf">_get_assemblies</span><span class="p">(</span><span class="n">chains</span><span class="p">,</span> <span class="n">cifdict</span><span class="p">):</span>
    <span class="n">assemblies</span> <span class="o">=</span> <span class="n">_extract_assembly_gen</span><span class="p">(</span><span class="n">cifdict</span><span class="p">)</span>
    <span class="n">id2chainid</span><span class="p">,</span> <span class="n">chainid2ids</span> <span class="o">=</span> <span class="n">_extract_asym_auth_id_map</span><span class="p">(</span><span class="n">cifdict</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">assembly_nr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">assembly_nr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">assemblies</span><span class="o">.</span><span class="n">keys</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">assembly_gen</span> <span class="o">=</span> <span class="n">assemblies</span><span class="p">[</span><span class="n">assembly_nr</span><span class="p">]</span>
    <span class="n">old_chains</span> <span class="o">=</span> <span class="p">{</span> <span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">:</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">}</span>
    <span class="n">new_chains</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Original chains are </span><span class="si">%s</span><span class="s2">. Now performing symmetry &quot;</span>
              <span class="s2">&quot;for assembly </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">old_chains</span><span class="p">,</span> <span class="n">assembly_nr</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;AG: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">assembly_gen</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">operations</span><span class="p">,</span> <span class="n">labelids</span> <span class="ow">in</span> <span class="n">assembly_gen</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">chainids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">id2chainid</span><span class="p">[</span><span class="n">lid</span><span class="p">]</span> <span class="k">for</span> <span class="n">lid</span> <span class="ow">in</span> <span class="n">labelids</span><span class="p">)</span>
        <span class="n">lids_back</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">a2l</span> <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">chainids</span> <span class="k">for</span> <span class="n">a2l</span> <span class="ow">in</span> <span class="n">chainid2ids</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">lids_back</span><span class="o">!=</span><span class="nb">set</span><span class="p">(</span><span class="n">labelids</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, extra: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lids_back</span><span class="p">,</span> <span class="n">labelids</span><span class="p">,</span> <span class="n">lids_back</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">labelids</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Operation on part of an author designated assymetric unit &quot;</span>
                             <span class="s2">&quot;(auth_asym_id) nt supported.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">chain_id</span> <span class="ow">in</span> <span class="n">chainids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">chain_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">old_chains</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span> <span class="p">(</span><span class="s2">&quot;Skipping chain </span><span class="si">%s</span><span class="s2">: not RNA? chains: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">chain_id</span><span class="p">,</span> <span class="n">old_chains</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">op_id</span> <span class="ow">in</span> <span class="n">op_ids</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Applying op </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">op_id</span><span class="p">,</span> <span class="n">chain_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">chain_id</span> <span class="ow">in</span> <span class="n">new_chains</span><span class="p">:</span>
                    <span class="n">chain</span> <span class="o">=</span> <span class="n">old_chains</span><span class="p">[</span><span class="n">chain_id</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">newid</span> <span class="o">=</span> <span class="n">_get_new_chainid</span><span class="p">(</span><span class="n">chain_id</span><span class="p">,</span> <span class="n">op_id</span><span class="p">,</span>
                                             <span class="nb">set</span><span class="p">(</span><span class="n">old_chains</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_chains</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting id </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">newid</span><span class="p">)</span>
                    <span class="n">chain</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">newid</span>
                    <span class="n">chain</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">operation_mat</span><span class="p">[</span><span class="n">op_id</span><span class="p">],</span> <span class="n">operation_vec</span><span class="p">[</span><span class="n">op_id</span><span class="p">])</span>
                <span class="n">new_chains</span><span class="p">[</span><span class="n">chain</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">=</span><span class="n">chain</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;new_chains: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">new_chains</span><span class="p">)</span>
    <span class="n">chains</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_chains</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">chains</span>

<div class="viewcode-block" id="get_all_chains"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.get_all_chains">[docs]</a><span class="k">def</span> <span class="nf">get_all_chains</span><span class="p">(</span><span class="n">in_filename</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">no_annotation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">assembly_nr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Load the PDB file located at filename, read all chains and return them.</span>

<span class="sd">    :param in_filename: The location of the original file.</span>
<span class="sd">    :param assembly_nr: Which assembly to return. Default: The first.</span>
<span class="sd">    :return: a tuple chains, missing_residues</span>

<span class="sd">             * chains: A list of Bio.PDB chain structures corresponding to all</span>
<span class="sd">                       RNA structures stored in in_filename</span>
<span class="sd">             * missing_residues: A list of dictionaries, describing the missing residues.</span>
<span class="sd">             * interacting residues: A list of residues</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">parser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">in_filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pdb&quot;</span><span class="p">):</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">PDBParser</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">in_filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.cif&quot;</span><span class="p">):</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">MMCIFParser</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Cannot determine filetype by extention. Try to read first line.</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">in_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdbfile</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">pdbfile</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
                <span class="c1"># According to</span>
                <span class="c1"># page 10 of ftp://ftp.wwpdb.org/pub/pdb/doc/format_descriptions/Format_v33_A4.pdf</span>
                <span class="c1"># a HEADER entry is mandatory. Biopython sometime starts directly with ATOM</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;HEADER&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ATOM&quot;</span><span class="p">):</span>
                    <span class="n">parser</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">PDBParser</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">parser</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">MMCIFParser</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_structure</span><span class="p">(</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="n">in_filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Multiple models in file. Using only the first model&quot;</span><span class="p">)</span>

    <span class="c1"># Let&#39;s detach all H2O, to speed up processing.</span>
    <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Before detaching water from </span><span class="si">%s</span><span class="s2">: chain has </span><span class="si">%s</span><span class="s2"> residues&quot;</span><span class="p">,</span> <span class="n">chain</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">chain</span><span class="o">.</span><span class="n">child_list</span><span class="p">[:]:</span> <span class="c1"># We need a copy here, because we are modifying it during iteration</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">resname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;HOH&quot;</span><span class="p">:</span>
                <span class="n">chain</span><span class="o">.</span><span class="n">detach_child</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;After detaching water from </span><span class="si">%s</span><span class="s2">: chain has </span><span class="si">%s</span><span class="s2"> residues&quot;</span><span class="p">,</span> <span class="n">chain</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">chain</span><span class="o">.</span><span class="n">id</span><span class="p">]))</span>

    <span class="c1"># Rename residues from other programs</span>
    <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">:</span>
            <span class="c1"># rename rosetta-generated structures</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">resname</span> <span class="o">==</span> <span class="s1">&#39; rA&#39;</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">resname</span> <span class="o">=</span> <span class="s1">&#39;  A&#39;</span>
            <span class="k">elif</span> <span class="n">r</span><span class="o">.</span><span class="n">resname</span> <span class="o">==</span> <span class="s1">&#39; rC&#39;</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">resname</span> <span class="o">=</span> <span class="s1">&#39;  C&#39;</span>
            <span class="k">elif</span> <span class="n">r</span><span class="o">.</span><span class="n">resname</span> <span class="o">==</span> <span class="s1">&#39; rG&#39;</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">resname</span> <span class="o">=</span> <span class="s1">&#39;  G&#39;</span>
            <span class="k">elif</span> <span class="n">r</span><span class="o">.</span><span class="n">resname</span> <span class="o">==</span> <span class="s1">&#39; rU&#39;</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">resname</span> <span class="o">=</span> <span class="s1">&#39;  U&#39;</span>

            <span class="c1"># rename iFoldRNA-generated structures</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">resname</span> <span class="o">==</span> <span class="s1">&#39;ADE&#39;</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">resname</span> <span class="o">=</span> <span class="s1">&#39;  A&#39;</span>
            <span class="k">elif</span> <span class="n">r</span><span class="o">.</span><span class="n">resname</span> <span class="o">==</span> <span class="s1">&#39;CYT&#39;</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">resname</span> <span class="o">=</span> <span class="s1">&#39;  C&#39;</span>
            <span class="k">elif</span> <span class="n">r</span><span class="o">.</span><span class="n">resname</span> <span class="o">==</span> <span class="s1">&#39;GUA&#39;</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">resname</span> <span class="o">=</span> <span class="s1">&#39;  G&#39;</span>
            <span class="k">elif</span> <span class="n">r</span><span class="o">.</span><span class="n">resname</span> <span class="o">==</span> <span class="s1">&#39;URI&#39;</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">resname</span> <span class="o">=</span> <span class="s1">&#39;  U&#39;</span>
    <span class="c1"># Now search for protein interactions.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">no_annotation</span><span class="p">:</span>
        <span class="n">interacting_residues</span> <span class="o">=</span> <span class="n">enumerate_interactions_kdtree</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">interacting_residues</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># The chains containing RNA</span>
    <span class="n">chains</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">contains_rna</span><span class="p">(</span><span class="n">chain</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PDB header </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parser</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
        <span class="n">mr</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;missing_residues&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">assembly_nr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Getting an assembly is not supported for the old PDB format.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c1"># A mmCIF parser</span>
        <span class="n">cifdict</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_mmcif_dict</span> <span class="c1"># We read a private attribute here, because parsing the mmcif dictionary a second time would cause a performance penalty.</span>
        <span class="c1"># Generate an assembly</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">operation_mat</span><span class="p">,</span> <span class="n">operation_vec</span> <span class="o">=</span> <span class="n">_extract_symmetrymatrices_from_cif_dict</span><span class="p">(</span><span class="n">cifdict</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span> <span class="c1"># Still experimental and not working correctly.</span>
                <span class="n">chains</span> <span class="o">=</span> <span class="n">_get_assemblies</span><span class="p">(</span><span class="n">chains</span><span class="p">,</span> <span class="n">cifdict</span><span class="p">)</span>
        <span class="n">mr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">cifdict</span><span class="p">[</span><span class="s2">&quot;_pdbx_poly_seq_scheme.pdb_mon_id&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;?&quot;</span>
            <span class="n">int_seq_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">cifdict</span><span class="p">[</span><span class="s2">&quot;_pdbx_poly_seq_scheme.pdb_seq_num&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">cifdict</span><span class="p">[</span><span class="s2">&quot;_pdbx_poly_seq_scheme.pdb_strand_id&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">insertions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">cifdict</span><span class="p">[</span><span class="s2">&quot;_pdbx_poly_seq_scheme.pdb_ins_code&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">insertions</span><span class="p">[</span><span class="n">insertions</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
            <span class="n">symbol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">cifdict</span><span class="p">[</span><span class="s2">&quot;_pdbx_poly_seq_scheme.mon_id&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)[</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">no_annotation</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sseq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">int_seq_ids</span><span class="p">):</span>
                    <span class="n">mr</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s2">&quot;res_name&quot;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="s2">&quot;chain&quot;</span><span class="p">:</span> <span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="s2">&quot;ssseq&quot;</span><span class="p">:</span> <span class="n">sseq</span><span class="p">,</span>
                        <span class="s2">&quot;insertion&quot;</span><span class="p">:</span> <span class="n">insertions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="p">})</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">mr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">in_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">wholeline</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">wholeline</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;REMARK 465&quot;</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">wholeline</span><span class="p">[</span><span class="mi">10</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">mr_info</span> <span class="o">=</span> <span class="n">_parse_remark_465</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mr_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">mr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mr_info</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mr</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;This PDB has missing residues&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">no_annotation</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;This PDB has no missing residues&quot;</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;for res1, res2 in itertools.combinations(s[0].get_residues(), 2):</span>
<span class="sd">        rna_res=None</span>
<span class="sd">        other_res=None</span>
<span class="sd">        if res1.resname.strip() in RNA_RESIDUES:</span>
<span class="sd">            rna_res=res1</span>
<span class="sd">        else:</span>
<span class="sd">            other_res=res1</span>
<span class="sd">        if res2.resname.strip() in RNA_RESIDUES:</span>
<span class="sd">            rna_res=res2</span>
<span class="sd">        else:</span>
<span class="sd">            other_res=res2</span>
<span class="sd">        if rna_res is None or other_res is None:</span>
<span class="sd">            continue</span>
<span class="sd">        if other_res.resname.strip()==&quot;HOH&quot;:</span>
<span class="sd">            continue</span>
<span class="sd">        if residues_interact(rna_res, other_res):</span>
<span class="sd">            log.error(&quot;%s and %s interact&quot;, rna_res, other_res)</span>
<span class="sd">            interacting_residues.add(rna_res)&#39;&#39;&#39;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;LOADING DONE: chains </span><span class="si">%s</span><span class="s2">, mr </span><span class="si">%s</span><span class="s2">, ir: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
             <span class="n">chains</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">interacting_residues</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chains</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">interacting_residues</span></div>



<span class="k">def</span> <span class="nf">_parse_remark_465</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse missing residue remarks.</span>
<span class="sd">    Returns a dictionary describing the missing residue.</span>
<span class="sd">    The specification for REMARK 465 at</span>
<span class="sd">    http://www.wwpdb.org/documentation/file-format-content/format33/remarks2.html#REMARK%20465</span>
<span class="sd">    only gives templates, but does not say they have to be followed.</span>
<span class="sd">    So we assume that not all pdb-files with a REMARK 465 can be understood.</span>
<span class="sd">    Returns a dictionary with the following keys:</span>
<span class="sd">    &quot;model&quot;, &quot;res_name&quot;, &quot;chain&quot;, &quot;ssseq&quot;, &quot;insertion&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
        <span class="c1"># Note that line has been stripped.</span>
        <span class="k">assert</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="s2">&quot;line has to be stripped&quot;</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                (\d+\s[\sA-Z][\sA-Z][A-Z] |   # Either model number + residue name</span>
<span class="s2">                 [A-Z]?[A-Z]?[A-Z])           # Or only residue name with</span>
<span class="s2">                                              # 1 (RNA) to 3 letters</span>
<span class="s2">                \s ([A-Za-z0-9])              # A single character chain</span>
<span class="s2">                \s+(\d+[A-Za-z]?)$            # Residue number: A digit followed</span>
<span class="s2">                                              # by an optional insertion code</span>
<span class="s2">                                              # (Hetero-flags make no sense in</span>
<span class="s2">                                              # context with missing res)</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">residue</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s2">&quot; &quot;</span> <span class="ow">in</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">residue</span><span class="p">[</span><span class="s2">&quot;res_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">residue</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">residue</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">residue</span><span class="p">[</span><span class="s2">&quot;res_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">residue</span><span class="p">[</span><span class="s2">&quot;chain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">residue</span><span class="p">[</span><span class="s2">&quot;ssseq&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">residue</span><span class="p">[</span><span class="s2">&quot;insertion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">residue</span><span class="p">[</span><span class="s2">&quot;ssseq&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">residue</span><span class="p">[</span><span class="s2">&quot;insertion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">residue</span>
    <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="enumerate_interactions_kdtree"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.enumerate_interactions_kdtree">[docs]</a><span class="k">def</span> <span class="nf">enumerate_interactions_kdtree</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="n">relevant_atoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">get_atoms</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;O&quot;</span><span class="p">]]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">relevant_atoms</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">kdtree</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">NeighborSearch</span><span class="p">(</span><span class="n">relevant_atoms</span><span class="p">)</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="n">kdtree</span><span class="o">.</span><span class="n">search_all</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">)</span>
    <span class="n">res_pair_list</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">a1</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_side_chains</span> <span class="ow">and</span> <span class="n">a2</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_side_chains</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">a1</span><span class="o">.</span><span class="n">get_parent</span><span class="p">()</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">a2</span><span class="o">.</span><span class="n">get_parent</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">p1</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">p2</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">p1</span> <span class="o">&lt;</span> <span class="n">p2</span><span class="p">:</span>
            <span class="n">res_pair_list</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res_pair_list</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">p2</span><span class="p">,</span> <span class="n">p1</span><span class="p">))</span>
    <span class="n">interacting_residues</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">res1</span><span class="p">,</span> <span class="n">res2</span> <span class="ow">in</span> <span class="n">res_pair_list</span><span class="p">:</span>
        <span class="n">rna_res</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">other_res</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">res1</span><span class="o">.</span><span class="n">resname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="n">RNA_RESIDUES</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">res1</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;H_&quot;</span><span class="p">):</span>
            <span class="n">rna_res</span> <span class="o">=</span> <span class="n">res1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">other_res</span> <span class="o">=</span> <span class="n">res1</span>
        <span class="k">if</span> <span class="n">res2</span><span class="o">.</span><span class="n">resname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="n">RNA_RESIDUES</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">res2</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;H_&quot;</span><span class="p">):</span>
            <span class="n">rna_res</span> <span class="o">=</span> <span class="n">res2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">other_res</span> <span class="o">=</span> <span class="n">res2</span>
        <span class="k">if</span> <span class="n">rna_res</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">other_res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(chain </span><span class="si">%s</span><span class="s2">) and </span><span class="si">%s</span><span class="s2">(chain </span><span class="si">%s</span><span class="s2">, resname </span><span class="si">%s</span><span class="s2">) are close&quot;</span><span class="p">,</span> <span class="n">rna_res</span><span class="p">,</span><span class="n">rna_res</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">other_res</span><span class="p">,</span> <span class="n">other_res</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">other_res</span><span class="o">.</span><span class="n">resname</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="c1"># Only consider C and N. So no ions etc</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">other_res</span><span class="o">.</span><span class="n">get_atoms</span><span class="p">()):</span>
            <span class="n">interacting_residues</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rna_res</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;but </span><span class="si">%s</span><span class="s2"> has wrong atoms </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">other_res</span><span class="p">,</span>
                      <span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">other_res</span><span class="o">.</span><span class="n">get_atoms</span><span class="p">()))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Interacting: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">interacting_residues</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">interacting_residues</span></div>


<span class="sd">&quot;&quot;&quot;def residues_interact(rna_res, other_res):</span>
<span class="sd">    for rna_atom in rna_res:</span>
<span class="sd">        if rna_atom.get_name() in all_side_chains:</span>
<span class="sd">            for other_atom in other_res:</span>
<span class="sd">                atom_symbol=&quot;&quot;.join(s for s in other_atom.get_name() if not s.isdigit())</span>
<span class="sd">                if atom_symbol in [&quot;C&quot;, &quot;N&quot;]:</span>
<span class="sd">                    d=ftuv.vec_distance(rna_atom.coord, other_atom.coord)</span>
<span class="sd">                    if d&lt;6:</span>
<span class="sd">                        return True</span>
<span class="sd">    return False&quot;&quot;&quot;</span>

<span class="n">HBOND_CUTOFF</span> <span class="o">=</span> <span class="mf">4.5</span>  <span class="c1"># 4.5 and 0.9 are values optimized against DSSR for 5T5H_A-B-C</span>
<span class="n">OOP_CUTOFF</span> <span class="o">=</span> <span class="mf">0.9</span>


<span class="k">def</span> <span class="nf">_get_points</span><span class="p">(</span><span class="n">res1</span><span class="p">,</span> <span class="n">res2</span><span class="p">):</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">res1</span><span class="o">.</span><span class="n">resname</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">res2</span><span class="o">.</span><span class="n">resname</span><span class="o">.</span><span class="n">strip</span><span class="p">()}</span>
    <span class="k">if</span> <span class="n">labels</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">}:</span>
        <span class="k">return</span> <span class="n">_points_AU</span><span class="p">(</span><span class="n">res1</span><span class="p">,</span> <span class="n">res2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">labels</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">}:</span>
        <span class="k">return</span> <span class="n">_points_GC</span><span class="p">(</span><span class="n">res1</span><span class="p">,</span> <span class="n">res2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">labels</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">}:</span>
        <span class="k">return</span> <span class="n">_points_GC</span><span class="p">(</span><span class="n">res1</span><span class="p">,</span> <span class="n">res2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_points_AU</span><span class="p">(</span><span class="n">res1</span><span class="p">,</span> <span class="n">res2</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">res1</span><span class="o">.</span><span class="n">resname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;A&quot;</span><span class="p">:</span>
        <span class="n">resA</span> <span class="o">=</span> <span class="n">res1</span>
        <span class="n">resU</span> <span class="o">=</span> <span class="n">res2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">resA</span> <span class="o">=</span> <span class="n">res2</span>
        <span class="n">resU</span> <span class="o">=</span> <span class="n">res1</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">resA</span><span class="p">[</span><span class="s2">&quot;N6&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">resU</span><span class="p">[</span><span class="s2">&quot;O4&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">resA</span><span class="p">[</span><span class="s2">&quot;N1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">resU</span><span class="p">[</span><span class="s2">&quot;N3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">resA</span><span class="p">[</span><span class="s2">&quot;C8&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span><span class="p">,</span> <span class="n">resU</span><span class="p">[</span><span class="s2">&quot;C6&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span><span class="p">),</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_points_GU</span><span class="p">(</span><span class="n">res1</span><span class="p">,</span> <span class="n">res2</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">res1</span><span class="o">.</span><span class="n">resname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;G&quot;</span><span class="p">:</span>
        <span class="n">resG</span> <span class="o">=</span> <span class="n">res1</span>
        <span class="n">resU</span> <span class="o">=</span> <span class="n">res2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">resG</span> <span class="o">=</span> <span class="n">res2</span>
        <span class="n">resU</span> <span class="o">=</span> <span class="n">res1</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">resG</span><span class="p">[</span><span class="s2">&quot;O6&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">resU</span><span class="p">[</span><span class="s2">&quot;N3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">resG</span><span class="p">[</span><span class="s2">&quot;N1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">resU</span><span class="p">[</span><span class="s2">&quot;O2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">resG</span><span class="p">[</span><span class="s2">&quot;C8&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span><span class="p">,</span> <span class="n">resU</span><span class="p">[</span><span class="s2">&quot;C6&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span><span class="p">),</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_points_GC</span><span class="p">(</span><span class="n">res1</span><span class="p">,</span> <span class="n">res2</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">res1</span><span class="o">.</span><span class="n">resname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;G&quot;</span><span class="p">:</span>
        <span class="n">resG</span> <span class="o">=</span> <span class="n">res1</span>
        <span class="n">resC</span> <span class="o">=</span> <span class="n">res2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">resG</span> <span class="o">=</span> <span class="n">res2</span>
        <span class="n">resC</span> <span class="o">=</span> <span class="n">res1</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">resG</span><span class="p">[</span><span class="s2">&quot;O6&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">resG</span><span class="p">[</span><span class="s2">&quot;N1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">resG</span><span class="p">[</span><span class="s2">&quot;N2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">resC</span><span class="p">[</span><span class="s2">&quot;N4&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">resC</span><span class="p">[</span><span class="s2">&quot;N3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">resC</span><span class="p">[</span><span class="s2">&quot;O2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">resC</span><span class="p">[</span><span class="s2">&quot;C6&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span><span class="p">,</span> <span class="n">resG</span><span class="p">[</span><span class="s2">&quot;C8&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span><span class="p">),</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">),</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<div class="viewcode-block" id="is_basepair_pair"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.is_basepair_pair">[docs]</a><span class="k">def</span> <span class="nf">is_basepair_pair</span><span class="p">(</span><span class="n">res1</span><span class="p">,</span> <span class="n">res2</span><span class="p">):</span>

    <span class="n">pairs</span> <span class="o">=</span> <span class="n">_get_points</span><span class="p">(</span><span class="n">res1</span><span class="p">,</span> <span class="n">res2</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pairs</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>  <span class="c1"># pairs[0] is only for coplanarity]]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">vec_distance</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;=</span> <span class="n">HBOND_CUTOFF</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">is_almost_coplanar</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">point</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pairs</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">]):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>


<span class="k">def</span> <span class="nf">_coplanar_point_indices</span><span class="p">(</span><span class="o">*</span><span class="n">points</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Thanks to https://stackoverflow.com/a/18968498&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">svd</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">assert</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;There are only </span><span class="si">{}</span><span class="s2"> points in </span><span class="si">{}</span><span class="s2"> dimensions.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ctr</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">points</span> <span class="o">-</span> <span class="n">ctr</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>  <span class="c1"># Could also use np.cov(x) here.</span>
    <span class="n">normal</span> <span class="o">=</span> <span class="n">svd</span><span class="p">(</span><span class="n">M</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">T</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">ctr</span>
        <span class="n">oop_distance</span> <span class="o">=</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">normal</span><span class="p">))</span> <span class="o">/</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">normal</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">oop_distance</span> <span class="o">&lt;=</span> <span class="n">OOP_CUTOFF</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">ctr</span><span class="p">,</span> <span class="n">normal</span>


<div class="viewcode-block" id="is_almost_coplanar"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.is_almost_coplanar">[docs]</a><span class="k">def</span> <span class="nf">is_almost_coplanar</span><span class="p">(</span><span class="o">*</span><span class="n">points</span><span class="p">):</span>
    <span class="n">indices</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">_coplanar_point_indices</span><span class="p">(</span><span class="o">*</span><span class="n">points</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span></div>


<div class="viewcode-block" id="annotate_fallback"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.annotate_fallback">[docs]</a><span class="k">def</span> <span class="nf">annotate_fallback</span><span class="p">(</span><span class="n">chain_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If neither DSSR nor MC-Annotate are available, we use an ad-hoc implementation of canonical</span>
<span class="sd">    basepair detection as fallback.</span>
<span class="sd">    This does not work well for missing atoms or modified residues.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kdtree</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">NeighborSearch</span><span class="p">(</span>
        <span class="p">[</span><span class="n">atom</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chain_list</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">chain</span><span class="o">.</span><span class="n">get_atoms</span><span class="p">()])</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="n">kdtree</span><span class="o">.</span><span class="n">search_all</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;R&quot;</span><span class="p">)</span>
    <span class="n">basepairs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Sorted, so conflicting basepairs are deterministically solved</span>
    <span class="k">for</span> <span class="n">res1</span><span class="p">,</span> <span class="n">res2</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pairs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">res1</span><span class="o">.</span><span class="n">resname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">RNA_RESIDUES</span> <span class="ow">or</span> <span class="n">res1</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;H_&quot;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">res2</span><span class="o">.</span><span class="n">resname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">RNA_RESIDUES</span> <span class="ow">or</span> <span class="n">res2</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;H_&quot;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">res1</span><span class="o">.</span><span class="n">resname</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">res2</span><span class="o">.</span><span class="n">resname</span><span class="o">.</span><span class="n">strip</span><span class="p">()}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">is_bp</span> <span class="o">=</span> <span class="n">is_basepair_pair</span><span class="p">(</span><span class="n">res1</span><span class="p">,</span> <span class="n">res2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_bp</span><span class="p">:</span>
                <span class="n">res1_id</span> <span class="o">=</span> <span class="n">fgr</span><span class="o">.</span><span class="n">resid_from_biopython</span><span class="p">(</span><span class="n">res1</span><span class="p">)</span>
                <span class="n">res2_id</span> <span class="o">=</span> <span class="n">fgr</span><span class="o">.</span><span class="n">resid_from_biopython</span><span class="p">(</span><span class="n">res2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">res1_id</span> <span class="ow">in</span> <span class="n">basepairs</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;More than one basepair detected for </span><span class="si">{}</span><span class="s2">.&quot;</span>
                                  <span class="s2">&quot; Ignoring </span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> because </span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> is already&quot;</span>
                                  <span class="s2">&quot; part of the structure&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res1_id</span><span class="p">,</span> <span class="n">res1_id</span><span class="p">,</span> <span class="n">res2_id</span><span class="p">,</span> <span class="n">res1_id</span><span class="p">,</span> <span class="n">basepairs</span><span class="p">[</span><span class="n">res1_id</span><span class="p">]))</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">res2_id</span> <span class="ow">in</span> <span class="n">basepairs</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;More than one basepair detected for </span><span class="si">{}</span><span class="s2">.&quot;</span>
                                  <span class="s2">&quot; Ignoring </span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> because </span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> is already&quot;</span>
                                  <span class="s2">&quot; part of the structure&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res2_id</span><span class="p">,</span> <span class="n">res2_id</span><span class="p">,</span> <span class="n">res1_id</span><span class="p">,</span> <span class="n">res2_id</span><span class="p">,</span> <span class="n">basepairs</span><span class="p">[</span><span class="n">res2_id</span><span class="p">]))</span>
                    <span class="k">continue</span>
                <span class="n">basepairs</span><span class="p">[</span><span class="n">res1_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">res2_id</span>
                <span class="n">basepairs</span><span class="p">[</span><span class="n">res2_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">res1_id</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Missing atom </span><span class="si">%s</span><span class="s2">. </span><span class="si">%s</span><span class="s2"> has atoms </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2"> has atoms </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                      <span class="n">e</span><span class="p">,</span> <span class="n">res1</span><span class="p">,</span> <span class="n">res1</span><span class="o">.</span><span class="n">child_dict</span><span class="p">,</span> <span class="n">res2</span><span class="p">,</span> <span class="n">res2</span><span class="o">.</span><span class="n">child_dict</span><span class="p">)</span>
            <span class="k">pass</span>

    <span class="n">seq_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">chain_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">:</span>
            <span class="n">seq_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fgr</span><span class="o">.</span><span class="n">resid_from_biopython</span><span class="p">(</span><span class="n">residue</span><span class="p">))</span>
    <span class="n">bpseq</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">chain_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chain_list</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">seqid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seq_ids</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">seqid</span> <span class="ow">in</span> <span class="n">basepairs</span><span class="p">:</span>
            <span class="n">bp</span> <span class="o">=</span> <span class="n">seq_ids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">basepairs</span><span class="p">[</span><span class="n">seqid</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bp</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">bpseq</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                     <span class="n">chain_dict</span><span class="p">[</span><span class="n">seqid</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">seqid</span><span class="o">.</span><span class="n">resid</span><span class="p">]</span><span class="o">.</span><span class="n">resname</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span>
                                     <span class="p">),</span>
                                     <span class="n">bp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bpseq</span><span class="p">,</span> <span class="n">seq_ids</span></div>


<div class="viewcode-block" id="rename_rosetta_atoms"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.rename_rosetta_atoms">[docs]</a><span class="k">def</span> <span class="nf">rename_rosetta_atoms</span><span class="p">(</span><span class="n">chain</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Rosetta names all the backbone atoms with an asterisk rather than an</span>
<span class="sd">    apostrophe. All that needs to be reversed.</span>

<span class="sd">    :param chain. A Bio.PDB.Chain structure generated by Rosetta</span>
<span class="sd">    :return: The same chain with renamed atoms</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">Selection</span><span class="o">.</span><span class="n">unfold_entities</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">):</span>
        <span class="n">oldid</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span>
        <span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">fullname</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
        <span class="c1">#: Not needed with newer biopython versions</span>
        <span class="c1">#: Seems to be needed again?</span>
        <span class="k">del</span> <span class="n">a</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">child_dict</span><span class="p">[</span><span class="n">oldid</span><span class="p">]</span>
        <span class="n">a</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">child_dict</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
    <span class="c1"># log.debug(&quot;Replaced rosetta atoms. \n%s\n%s&quot;,</span>
    <span class="c1">#                    chain.child_list[0].child_list,</span>
    <span class="c1">#                    chain.child_list[0].child_dict</span>
    <span class="c1">#                    )</span>

    <span class="k">return</span> <span class="n">chain</span></div>


<div class="viewcode-block" id="remove_disordered"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.remove_disordered">[docs]</a><span class="k">def</span> <span class="nf">remove_disordered</span><span class="p">(</span><span class="n">chain</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">residue</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chain</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">residue</span><span class="p">,</span> <span class="s2">&quot;selected_child&quot;</span><span class="p">):</span>
            <span class="n">new_res</span> <span class="o">=</span> <span class="n">residue</span><span class="o">.</span><span class="n">selected_child</span>
            <span class="n">chain</span><span class="o">.</span><span class="n">detach_child</span><span class="p">(</span><span class="n">residue</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">chain</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">new_res</span><span class="p">)</span>
            <span class="n">residue</span> <span class="o">=</span> <span class="n">new_res</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">residue</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="s2">&quot;selected_child&quot;</span><span class="p">):</span>
                <span class="n">new_atom</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">selected_child</span>
                <span class="n">new_atom</span><span class="o">.</span><span class="n">altloc</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
                <span class="n">new_atom</span><span class="o">.</span><span class="n">occupancy</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">new_atom</span><span class="o">.</span><span class="n">disordered_flag</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">residue</span><span class="o">.</span><span class="n">detach_child</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">residue</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">new_atom</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chain</span></div>


<div class="viewcode-block" id="load_structure"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.load_structure">[docs]</a><span class="k">def</span> <span class="nf">load_structure</span><span class="p">(</span><span class="n">pdb_filename</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Load a Bio.PDB.Structure object and return the largest chain.</span>
<span class="sd">    This chain will be modified so that all hetatms are removed, modified</span>
<span class="sd">    residues will be renamed to regular residues, etc...</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">chain</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">ir</span> <span class="o">=</span> <span class="n">get_biggest_chain</span><span class="p">(</span><span class="n">pdb_filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">clean_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="clean_chain"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.clean_chain">[docs]</a><span class="k">def</span> <span class="nf">clean_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">query_PDBeChem</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clean a pdb chain for further use with forgi.</span>

<span class="sd">    It will be modified so that all hetatms are removed, modified</span>
<span class="sd">    residues will be renamed to regular residues, residue ids will be positive integers, ...</span>

<span class="sd">    :param chain: A Bio.PDB.Chain object</span>
<span class="sd">    :param query_PDBeChem: If true, query the PDBeChem database whenever a</span>
<span class="sd">                          modified residue with unknown 3-letter code</span>
<span class="sd">                          is encountered.</span>

<span class="sd">    :returns: A modified version of this chain</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chain</span><span class="p">,</span> <span class="n">modifications</span> <span class="o">=</span> <span class="n">to_4_letter_alphabeth</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">query_PDBeChem</span><span class="p">)</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="n">rename_rosetta_atoms</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="n">remove_disordered</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chain</span><span class="p">,</span> <span class="n">modifications</span></div>


<div class="viewcode-block" id="interchain_contacts"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.interchain_contacts">[docs]</a><span class="k">def</span> <span class="nf">interchain_contacts</span><span class="p">(</span><span class="n">struct</span><span class="p">):</span>
    <span class="n">all_atoms</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">Selection</span><span class="o">.</span><span class="n">unfold_entities</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>

    <span class="n">ns</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">NeighborSearch</span><span class="p">(</span><span class="n">all_atoms</span><span class="p">)</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">search_all</span><span class="p">(</span><span class="mf">2.8</span><span class="p">)</span>

    <span class="n">ic_pairs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">a1</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span> <span class="o">!=</span> <span class="n">a2</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="n">ic_pairs</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">ic_pairs</span></div>


<div class="viewcode-block" id="contains_rna"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.contains_rna">[docs]</a><span class="k">def</span> <span class="nf">contains_rna</span><span class="p">(</span><span class="n">chain</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Determine if a Bio.PDB.Chain structure corresponds to an RNA</span>
<span class="sd">    molecule.</span>

<span class="sd">    :param chain: A Bio.PDB.Chain molecule</span>
<span class="sd">    :return: True if it is an RNA molecule, False if at least one residue is not an RNA.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">resname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="n">RNA_RESIDUES</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="is_protein"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.pdb.html#forgi.threedee.utilities.pdb.is_protein">[docs]</a><span class="k">def</span> <span class="nf">is_protein</span><span class="p">(</span><span class="n">chain</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Determine if a Bio.PDB.Chain structure corresponds to an protein</span>
<span class="sd">    molecule.</span>

<span class="sd">    :param chain: A Bio.PDB.Chain molecule</span>
<span class="sd">    :return: True if it is a protein molecule, False otherwise</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">resname</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ALA&#39;</span><span class="p">,</span> <span class="s1">&#39;ARG&#39;</span><span class="p">,</span> <span class="s1">&#39;ASN&#39;</span><span class="p">,</span> <span class="s1">&#39;ASP&#39;</span><span class="p">,</span> <span class="s1">&#39;CYS&#39;</span><span class="p">,</span> <span class="s1">&#39;GLN&#39;</span><span class="p">,</span> <span class="s1">&#39;GLU&#39;</span><span class="p">,</span> <span class="s1">&#39;HIS&#39;</span><span class="p">,</span> <span class="s1">&#39;ILE&#39;</span><span class="p">,</span> <span class="s1">&#39;LEU&#39;</span><span class="p">,</span> <span class="s1">&#39;LYS&#39;</span><span class="p">,</span> <span class="s1">&#39;MET&#39;</span><span class="p">,</span> <span class="s1">&#39;PHE&#39;</span><span class="p">,</span> <span class="s1">&#39;PRO&#39;</span><span class="p">,</span> <span class="s1">&#39;SER&#39;</span><span class="p">,</span> <span class="s1">&#39;THR&#39;</span><span class="p">,</span> <span class="s1">&#39;TRP&#39;</span><span class="p">,</span> <span class="s1">&#39;TYR&#39;</span><span class="p">,</span> <span class="s1">&#39;VAL&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>
</pre></div>

      </div>
      <div class="bottomnav">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2016 Peter Kerpedjiev &lt;pkerp@tbi.univie.ac.at&gt;; 2015-2018 Bernhard Thiel &lt;thiel@tbi.univie.ac.at&gt;.
      Last updated on Feb 25, 2019.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.7.
    </div>
  </body>
</html>