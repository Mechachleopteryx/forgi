
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>forgi.threedee.utilities.graph_pdb &mdash; forgi 0.4 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '0.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../../_static/theme_extras.js"></script>
    <link rel="top" title="forgi 0.4 documentation" href="../../../../index.html" />
    <link rel="up" title="forgi.threedee" href="../../threedee.html" /> 
  </head>
  <body role="document">
      <div class="header"><h1 class="heading"><a href="../../../../index.html">
          <span>forgi 0.4 documentation</span></a></h1>
      </div>
      <div class="topnav">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for forgi.threedee.utilities.graph_pdb</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python</span>

<span class="kn">import</span> <span class="nn">Bio.PDB</span> <span class="kn">as</span> <span class="nn">bp</span>
<span class="kn">import</span> <span class="nn">Bio.PDB</span> <span class="kn">as</span> <span class="nn">bpdb</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">itertools</span> <span class="kn">as</span> <span class="nn">it</span>
<span class="kn">import</span> <span class="nn">collections</span> <span class="kn">as</span> <span class="nn">col</span>

<span class="kn">import</span> <span class="nn">os.path</span> <span class="kn">as</span> <span class="nn">op</span>
<span class="kn">import</span> <span class="nn">forgi.config</span> <span class="kn">as</span> <span class="nn">cc</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">math</span> <span class="kn">as</span> <span class="nn">m</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.linalg</span> <span class="kn">as</span> <span class="nn">nl</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">forgi.threedee.utilities.average_stem_vres_atom_positions</span> <span class="kn">as</span> <span class="nn">ftus</span> 
<span class="kn">import</span> <span class="nn">forgi.utilities.debug</span> <span class="kn">as</span> <span class="nn">fud</span>
<span class="kn">import</span> <span class="nn">forgi.threedee.utilities.my_math</span> <span class="kn">as</span> <span class="nn">ftum</span>
<span class="kn">import</span> <span class="nn">forgi.threedee.utilities.pdb</span> <span class="kn">as</span> <span class="nn">ftup</span>
<span class="kn">import</span> <span class="nn">forgi.threedee.utilities.vector</span> <span class="kn">as</span> <span class="nn">cuv</span>
<span class="kn">import</span> <span class="nn">forgi.threedee.utilities.vector</span> <span class="kn">as</span> <span class="nn">ftuv</span>
<span class="kn">import</span> <span class="nn">forgi</span>

<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="kn">as</span> <span class="nn">so</span>

<span class="n">catom_name</span> <span class="o">=</span> <span class="s2">&quot;C1&#39;&quot;</span>


<span class="k">try</span><span class="p">:</span>
  <span class="n">profile</span>  <span class="c1">#The @profile decorator from line_profiler (kernprof)</span>
<span class="k">except</span><span class="p">:</span>
<div class="viewcode-block" id="profile"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.profile">[docs]</a>  <span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> 
    <span class="k">return</span> <span class="n">x</span></div>
<span class="k">else</span><span class="p">:</span>
  <span class="kn">import</span> <span class="nn">forgi.threedee.utilities.average_atom_positions</span> <span class="kn">as</span> <span class="nn">ftua</span> <span class="c1">#Takes forever if executed within a decorated method.</span>

<div class="viewcode-block" id="stem_stem_orientation"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.stem_stem_orientation">[docs]</a><span class="k">def</span> <span class="nf">stem_stem_orientation</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate the orientation of stem s2 in relation to stem s1</span>
<span class="sd">    as described by 3 parameters:</span>

<span class="sd">    1. The distance between the closest points of the two stems.</span>
<span class="sd">    2. The angle between s1 and s2 in the plane formed by the axis of</span>
<span class="sd">       the first stem and the vector between the two points closest</span>
<span class="sd">       to each on both stems.</span>
<span class="sd">    3. The angle of s2 out of the plane formed by their axes.</span>

<span class="sd">    :param bg: The BulgeGraph containing the stems.</span>
<span class="sd">    :param s1: The name of the first stem</span>
<span class="sd">    :param s2: The name of the second stem</span>
<span class="sd">    :return: (x,y,z) where x,y and z are the parameters described in</span>
<span class="sd">        the description above.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># shorten the names a little bit</span>
    <span class="n">s1_p0</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">s1_p1</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">s2_p0</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">s2_p1</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># The vectors of the axes of the cylinders</span>
    <span class="n">s1_vec</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">s2_vec</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># the minimum distance between the two stems, which are represented</span>
    <span class="c1"># as line segments</span>
    <span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">)</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">line_segment_distance</span><span class="p">(</span><span class="n">s1_p0</span><span class="p">,</span> <span class="n">s1_p1</span><span class="p">,</span> <span class="n">s2_p0</span><span class="p">,</span> <span class="n">s2_p1</span><span class="p">)</span>
    <span class="n">i_vec</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">-</span> <span class="n">i1</span>

    <span class="n">i_rej</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">vector_rejection</span><span class="p">(</span><span class="n">i_vec</span><span class="p">,</span> <span class="n">s1_vec</span><span class="p">)</span>
    <span class="n">plane_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">i_rej</span><span class="p">,</span> <span class="n">s1_vec</span><span class="p">)</span>
    <span class="c1"># s2_proj is in the intersection plane</span>
    <span class="n">s2_proj_in</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">vector_rejection</span><span class="p">(</span><span class="n">s2_vec</span><span class="p">,</span> <span class="n">plane_vec</span><span class="p">)</span>
    <span class="c1"># s2 proj_out is out of the intersection plane</span>
    <span class="n">s2_proj_out</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">vector_rejection</span><span class="p">(</span><span class="n">s2_vec</span><span class="p">,</span> <span class="n">i_rej</span><span class="p">)</span>
    <span class="c1"># the normal of the plane defined by the two stem vectors</span>

    <span class="c1">#ang1 = cuv.vec_angle(s1_vec, s2_proj_out)</span>
    <span class="c1">#ang2 = cuv.vec_angle(s1_vec, s2_proj_in)</span>
    <span class="n">ang1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span><span class="n">s2_proj_in</span><span class="p">,</span> <span class="n">s1_vec</span><span class="p">)</span>
    <span class="n">ang2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span><span class="n">s2_proj_out</span><span class="p">,</span> <span class="n">s1_vec</span><span class="p">)</span>

    <span class="c1">#ang3 = cuv.vec_angle(s1_vec, s2_proj_in)</span>
    <span class="c1">#ang4 = cuv.vec_angle(s1_vec, s2_proj_out)</span>

    <span class="c1"># ever so slightly increased to prevent domain errors</span>
    <span class="c1"># in the lateral_offset calculation below</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">i_vec</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.0001</span>

    <span class="n">ortho_offset</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">i_rej</span><span class="p">)</span>
    <span class="n">lateral_offset</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dist</span> <span class="o">*</span> <span class="n">dist</span> <span class="o">-</span> <span class="n">ortho_offset</span> <span class="o">*</span> <span class="n">ortho_offset</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">cuv</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">i_vec</span><span class="p">),</span> <span class="n">ang1</span><span class="p">,</span>
            <span class="n">ang2</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span><span class="n">s1_vec</span><span class="p">,</span> <span class="n">s2_vec</span><span class="p">),</span> <span class="n">lateral_offset</span><span class="p">,</span> <span class="n">ortho_offset</span><span class="p">)</span></div>


<div class="viewcode-block" id="base_normals"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.base_normals">[docs]</a><span class="k">def</span> <span class="nf">base_normals</span><span class="p">(</span><span class="n">pdb_filename</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Return a list of the normals for each base in the structure.</span>

<span class="sd">    As defined by the average of the cross products between the C2-C5</span>
<span class="sd">    and C2-C6 vectors and the N3-C6 and N3-C5 vectors. The origin of</span>
<span class="sd">    the vector will be the centroid of these four atoms.</span>

<span class="sd">    :param pdb_filename: The name of the pdb file containing the structure</span>
<span class="sd">    :return: A list of pairs containing the origin the normal as well as the</span>
<span class="sd">        normal itself.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">struct</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">PDBParser</span><span class="p">()</span><span class="o">.</span><span class="n">get_structure</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">pdb_filename</span><span class="p">)</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">get_chains</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">origin_norms</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">:</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;C2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span>
        <span class="n">c5</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;C5&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span>
        <span class="n">c6</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;C6&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span>
        <span class="n">n3</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;N3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span>

        <span class="n">v1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">c6</span> <span class="o">-</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c5</span> <span class="o">-</span> <span class="n">c2</span><span class="p">))</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">c6</span> <span class="o">-</span> <span class="n">n3</span><span class="p">,</span> <span class="n">c5</span> <span class="o">-</span> <span class="n">n3</span><span class="p">))</span>

        <span class="c1"># take the average of the two, for accuracy or something</span>
        <span class="n">v_norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">v1</span> <span class="o">+</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">origin</span> <span class="o">=</span> <span class="p">(</span><span class="n">c2</span> <span class="o">+</span> <span class="n">c5</span> <span class="o">+</span> <span class="n">c6</span> <span class="o">+</span> <span class="n">n3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span>
        <span class="n">origin_norms</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">origin</span><span class="p">,</span> <span class="n">v_norm</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">origin_norms</span></div>


<div class="viewcode-block" id="get_twist_angle"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_twist_angle">[docs]</a><span class="k">def</span> <span class="nf">get_twist_angle</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">twists</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get the angle of the twists with respect to each other.</span>

<span class="sd">    :param coords: The coordinates of the ends of the stem.</span>
<span class="sd">    :param twists: The two twist vectors.</span>
<span class="sd">    :return angle: The angle between the two twist vectors.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">stem_vec</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">stem_vec</span><span class="p">,</span> <span class="n">twists</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">twist2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">twists</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">basis</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span>
    <span class="c1">#assert_allclose(twist2[0], 0., rtol=1e-7, atol=1e-7)</span>

    <span class="n">angle</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">twist2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">twist2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">angle</span></div>


<div class="viewcode-block" id="twist2_from_twist1"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.twist2_from_twist1">[docs]</a><span class="k">def</span> <span class="nf">twist2_from_twist1</span><span class="p">(</span><span class="n">stem_vec</span><span class="p">,</span> <span class="n">twist1</span><span class="p">,</span> <span class="n">angle</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get an orientation for the second twist which will place it an</span>
<span class="sd">    angle of angle from the first twist.</span>

<span class="sd">    :param stem_vec: The vector of the stem.</span>
<span class="sd">    :param twist1: The vector of the first twist.</span>
<span class="sd">    :param angle: The angular difference between the two twists.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">stem_vec</span><span class="p">,</span> <span class="n">twist1</span><span class="p">)</span>

    <span class="n">twist2_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)])</span>
    <span class="n">twist2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">twist2_new</span><span class="p">)</span>
    <span class="c1">#twist2 = cuv.change_basis(twist2_new, cuv.standard_basis, basis)</span>

    <span class="k">return</span> <span class="n">twist2</span></div>


<div class="viewcode-block" id="get_twist_parameter"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_twist_parameter">[docs]</a><span class="k">def</span> <span class="nf">get_twist_parameter</span><span class="p">(</span><span class="n">twist1</span><span class="p">,</span> <span class="n">twist2</span><span class="p">,</span> <span class="n">u_v</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate how much stem1 must be twisted for its twist vector</span>
<span class="sd">    to coincide with that of stem2.</span>

<span class="sd">    :param twist1: The twist notator of stem1</span>
<span class="sd">    :param twist2: The twist notator of stem2</span>
<span class="sd">    :param u_v: The parameters u and v for rotating stem2 onto stem1</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">u</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">u_v</span>
    <span class="n">rot_mat1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">(</span><span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">rot_mat2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">(</span><span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">u</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">twist2_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot_mat1</span><span class="p">,</span> <span class="n">twist2</span><span class="p">)</span>
    <span class="n">twist2_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot_mat2</span><span class="p">,</span> <span class="n">twist2_new</span><span class="p">)</span>

    <span class="c1">#print &quot;get_twist_parameter twist2:&quot;, twist2_new</span>

    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">twist2_new</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">twist2_new</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="get_stem_orientation_parameters"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_stem_orientation_parameters">[docs]</a><span class="k">def</span> <span class="nf">get_stem_orientation_parameters</span><span class="p">(</span><span class="n">stem1_vec</span><span class="p">,</span> <span class="n">twist1</span><span class="p">,</span> <span class="n">stem2_vec</span><span class="p">,</span> <span class="n">twist2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Return a parameterization of the orientation of stem2 with respect to</span>
<span class="sd">    stem1.</span>

<span class="sd">    stem1 -&gt; bulge -&gt; stem2</span>

<span class="sd">    :param stem1_vec: The vector representing the axis of stem1</span>
<span class="sd">    :param twist1: The twist of stem1 closest to the bulge</span>
<span class="sd">    :param stem2_vec: The vector representing teh axis of stem2</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># Since we will denote the orientation of stem2 with respect to stem1</span>
    <span class="c1"># We first need to define a new coordinate system based on stem1</span>

    <span class="n">stem1_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">stem1_vec</span><span class="p">,</span> <span class="n">twist1</span><span class="p">)</span>

    <span class="c1"># Transform the vector of stem2 to the new coordinate system</span>
    <span class="n">stem2_new_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">stem2_vec</span><span class="p">,</span> <span class="n">stem1_basis</span><span class="p">,</span>
                                       <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span>
    <span class="n">twist2_new_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">twist2</span><span class="p">,</span> <span class="n">stem1_basis</span><span class="p">,</span>
                                        <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span>

    <span class="c1"># Convert the cartesian coordinates to polar coordinates</span>
    <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">spherical_cartesian_to_polar</span><span class="p">(</span><span class="n">stem2_new_basis</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">get_twist_parameter</span><span class="p">(</span><span class="n">twist1</span><span class="p">,</span> <span class="n">twist2_new_basis</span><span class="p">,</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_stem_separation_parameters"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_stem_separation_parameters">[docs]</a><span class="k">def</span> <span class="nf">get_stem_separation_parameters</span><span class="p">(</span><span class="n">stem</span><span class="p">,</span> <span class="n">twist</span><span class="p">,</span> <span class="n">bulge</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Parameterize the location of the bulge with respect to the stem.</span>

<span class="sd">    :param stem: The stem vector.</span>
<span class="sd">    :param bulge: the bulge vector.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">stem_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">stem</span><span class="p">,</span> <span class="n">twist</span><span class="p">)</span>
    <span class="n">bulge_new_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">bulge</span><span class="p">,</span> <span class="n">stem_basis</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cuv</span><span class="o">.</span><span class="n">spherical_cartesian_to_polar</span><span class="p">(</span><span class="n">bulge_new_basis</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_stem_twist_and_bulge_vecs"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_stem_twist_and_bulge_vecs">[docs]</a><span class="k">def</span> <span class="nf">get_stem_twist_and_bulge_vecs</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">bulge</span><span class="p">,</span> <span class="n">connections</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Return the vectors of the stems and of the twists between which</span>
<span class="sd">    we want to calculate angles.</span>

<span class="sd">    The two vectors will be defined as follows:</span>

<span class="sd">    s1e -&gt; s1b -&gt; b -&gt; s2b -&gt; s2e</span>

<span class="sd">    The twists will be the two closest to the bulge.</span>

<span class="sd">    :param bulge: The name of the bulge separating the two helices.</span>
<span class="sd">    :param connections: The two stems that are connected to this bulge.</span>
<span class="sd">    :return: (stem1, twist1, stem2, twist2, bulge)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">s1</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1">#s1d = bg.defines[s1]</span>
    <span class="c1">#s2d = bg.defines[s2]</span>

    <span class="n">mids1</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s1</span><span class="p">]</span>
    <span class="n">twists1</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">twists</span><span class="p">[</span><span class="n">s1</span><span class="p">]</span>

    <span class="n">mids2</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s2</span><span class="p">]</span>
    <span class="n">twists2</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">twists</span><span class="p">[</span><span class="n">s2</span><span class="p">]</span>

    <span class="c1"># find out which sides of the stems are closest to the bulge</span>
    <span class="c1"># the results will be indexes into the mids array</span>
    <span class="p">(</span><span class="n">s1b</span><span class="p">,</span> <span class="n">s1e</span><span class="p">)</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">get_sides</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">bulge</span><span class="p">)</span>
    <span class="p">(</span><span class="n">s2b</span><span class="p">,</span> <span class="n">s2e</span><span class="p">)</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">get_sides</span><span class="p">(</span><span class="n">s2</span><span class="p">,</span> <span class="n">bulge</span><span class="p">)</span>

    <span class="c1"># Create directional vectors for the stems</span>
    <span class="n">stem1_vec</span> <span class="o">=</span> <span class="n">mids1</span><span class="p">[</span><span class="n">s1b</span><span class="p">]</span> <span class="o">-</span> <span class="n">mids1</span><span class="p">[</span><span class="n">s1e</span><span class="p">]</span>
    <span class="n">bulge_vec</span> <span class="o">=</span> <span class="n">mids2</span><span class="p">[</span><span class="n">s2b</span><span class="p">]</span> <span class="o">-</span> <span class="n">mids1</span><span class="p">[</span><span class="n">s1b</span><span class="p">]</span>
    <span class="n">stem2_vec</span> <span class="o">=</span> <span class="n">mids2</span><span class="p">[</span><span class="n">s2e</span><span class="p">]</span> <span class="o">-</span> <span class="n">mids2</span><span class="p">[</span><span class="n">s2b</span><span class="p">]</span>

    <span class="c1">#twists1_vec = [twists1[s1b], twists1[s1e]]</span>
    <span class="c1">#twists2_vec = [twists2[s2e], twists2[s2b]]</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">stem1_vec</span><span class="p">,</span> <span class="n">twists1</span><span class="p">[</span><span class="n">s1b</span><span class="p">],</span> <span class="n">stem2_vec</span><span class="p">,</span> <span class="n">twists2</span><span class="p">[</span><span class="n">s2b</span><span class="p">],</span> <span class="n">bulge_vec</span><span class="p">)</span></div>

<div class="viewcode-block" id="stem2_pos_from_stem1"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.stem2_pos_from_stem1">[docs]</a><span class="k">def</span> <span class="nf">stem2_pos_from_stem1</span><span class="p">(</span><span class="n">stem1</span><span class="p">,</span> <span class="n">twist1</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get the starting point of a second stem, given the parameters</span>
<span class="sd">    about where it&#39;s located with respect to stem1</span>

<span class="sd">    :param stem1: The vector representing the axis of stem1&#39;s cylinder</span>
<span class="sd">    :param twist1: The twist parameter of stem1</span>
<span class="sd">    :param params: The parameters describing the orientaiton of stem2 wrt stem1</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="n">params</span>
    <span class="n">stem2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">spherical_polar_to_cartesian</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

    <span class="n">stem1_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">stem1</span><span class="p">,</span> <span class="n">twist1</span><span class="p">)</span>
    <span class="n">stem2_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">stem1_basis</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">stem2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stem2_start</span></div>


<div class="viewcode-block" id="stem2_pos_from_stem1_1"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.stem2_pos_from_stem1_1">[docs]</a><span class="k">def</span> <span class="nf">stem2_pos_from_stem1_1</span><span class="p">(</span><span class="n">stem1_basis</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get the starting point of a second stem, given the parameters</span>
<span class="sd">    about where it&#39;s located with respect to stem1</span>

<span class="sd">    :param stem1: The vector representing the axis of stem1&#39;s cylinder</span>
<span class="sd">    :param twist1: The twist parameter of stem1</span>
<span class="sd">    :param params: The parameters describing the orientaiton of stem2 wrt stem1</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="n">params</span>
    <span class="n">stem2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">spherical_polar_to_cartesian</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
    <span class="n">stem2_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">stem1_basis</span><span class="p">,</span> <span class="n">stem2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stem2_start</span></div>

<span class="c1">#Seems to be unused!</span>
<div class="viewcode-block" id="twist2_orient_from_stem1"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.twist2_orient_from_stem1">[docs]</a><span class="k">def</span> <span class="nf">twist2_orient_from_stem1</span><span class="p">(</span><span class="n">stem1</span><span class="p">,</span> <span class="n">twist1</span><span class="p">,</span> <span class="n">u_v_t</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate the position of the twist factor of the 2nd stem from its</span>
<span class="sd">    parameters and the first stem.</span>

<span class="sd">    :param stem1: The vector representing the axis of stem1&#39;s cylinder</span>
<span class="sd">    :param twist1: The twist factor of stem1.</span>
<span class="sd">    :param u_v_t: The parameters describing how the twist of stem2 is</span>
<span class="sd">                      oriented with respect to stem1. A triple `(u, v, t)`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">u_v_t</span>
    <span class="n">twist2_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="p">)])</span>

    <span class="n">rot_mat1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">(</span><span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">rot_mat2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">(</span><span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">u</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">rot_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot_mat2</span><span class="p">,</span> <span class="n">rot_mat1</span><span class="p">)</span>
    <span class="n">twist2_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">nl</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">rot_mat</span><span class="p">),</span> <span class="n">twist2_new</span><span class="p">)</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    twist2_new = dot(inv(rot_mat2), twist2_new)</span>
<span class="sd">    twist2_new = dot(inv(rot_mat1), twist2_new)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">stem1_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">stem1</span><span class="p">,</span> <span class="n">twist1</span><span class="p">)</span>
    <span class="n">twist2_new_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">twist2_new</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">,</span>
                                        <span class="n">stem1_basis</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">twist2_new_basis</span></div>


<div class="viewcode-block" id="twist2_orient_from_stem1_1"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.twist2_orient_from_stem1_1">[docs]</a><span class="k">def</span> <span class="nf">twist2_orient_from_stem1_1</span><span class="p">(</span><span class="n">stem1_basis</span><span class="p">,</span> <span class="n">u_v_t</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate the position of the twist factor of the 2nd stem from its</span>
<span class="sd">    parameters and the first stem.</span>

<span class="sd">    :param stem1: The vector representing the axis of stem1&#39;s cylinder</span>
<span class="sd">    :param twist1: The twist factor of stem1.</span>
<span class="sd">    :param u_v_t: The parameters describing how the twist of stem2 is</span>
<span class="sd">                      oriented with respect to stem1. A triple `(u, v, t)`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">u_v_t</span>
    <span class="n">twist2_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="p">)])</span>

    <span class="n">rot_mat1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">(</span><span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">rot_mat2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">(</span><span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">u</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">rot_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot_mat2</span><span class="p">,</span> <span class="n">rot_mat1</span><span class="p">)</span>
    <span class="n">twist2_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">nl</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">rot_mat</span><span class="p">),</span> <span class="n">twist2_new</span><span class="p">)</span>

    <span class="n">twist2_new_basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">stem1_basis</span><span class="p">,</span> <span class="n">twist2_new</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">twist2_new_basis</span></div>

<span class="c1">#Seems to be unused!</span>
<div class="viewcode-block" id="stem2_orient_from_stem1"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.stem2_orient_from_stem1">[docs]</a><span class="k">def</span> <span class="nf">stem2_orient_from_stem1</span><span class="p">(</span><span class="n">stem1</span><span class="p">,</span> <span class="n">twist1</span><span class="p">,</span> <span class="n">r_u_v</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate the orientation of the second stem, given its parameterization</span>
<span class="sd">    and the parameterization of stem1</span>

<span class="sd">    :param stem1: The vector representing the axis of stem1&#39;s cylinder</span>
<span class="sd">    :param twist1: The twist factor of stem1.</span>
<span class="sd">    :param r_u_v: The orientation of stem2 wrt stem1, a triple `(r, u, v)`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">r</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">r_u_v</span>
    <span class="n">stem2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">spherical_polar_to_cartesian</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
    <span class="n">stem1_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">stem1</span><span class="p">,</span> <span class="n">twist1</span><span class="p">)</span>
    <span class="n">stem2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">stem2</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">,</span> <span class="n">stem1_basis</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stem2</span></div>


<div class="viewcode-block" id="stem2_orient_from_stem1_1"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.stem2_orient_from_stem1_1">[docs]</a><span class="k">def</span> <span class="nf">stem2_orient_from_stem1_1</span><span class="p">(</span><span class="n">stem1_basis</span><span class="p">,</span> <span class="n">r_u_v</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate the orientation of the second stem, given its parameterization</span>
<span class="sd">    and the parameterization of stem1</span>

<span class="sd">    :param stem1: The vector representing the axis of stem1&#39;s cylinder</span>
<span class="sd">    :param twist1: The twist factor of stem1.</span>
<span class="sd">    :param r_u_v: The orientation of stem2 wrt stem1, a triple `(r, u, v)`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">r</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">r_u_v</span>
    <span class="n">stem2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">spherical_polar_to_cartesian</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
    <span class="c1">#stem1_basis = cuv.create_orthonormal_basis(stem1, twist1)</span>
    <span class="c1">#stem2 = cuv.change_basis(stem2, cuv.standard_basis, stem1_basis)</span>
    <span class="n">stem2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">stem1_basis</span><span class="p">,</span> <span class="n">stem2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stem2</span></div>


<div class="viewcode-block" id="get_centroid"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_centroid">[docs]</a><span class="k">def</span> <span class="nf">get_centroid</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">residue_num</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param residue_num: A list of integers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">residue_num</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">residue_num</span><span class="p">]</span>
    <span class="c1">#print &gt;&gt;sys.stderr, &quot;residue_num:&quot;, residue_num</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">residue_num</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">atoms</span> <span class="o">+=</span> <span class="p">[</span><span class="n">chain</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">catom_name</span><span class="p">]]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># the C1* atom probably doesn&#39;t exist</span>
            <span class="k">continue</span>

    <span class="n">vectors</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">cuv</span><span class="o">.</span><span class="n">get_vector_centroid</span><span class="p">(</span><span class="n">vectors</span><span class="p">)</span></div>

<span class="c1">#Seems to be unused!</span>
<div class="viewcode-block" id="get_bulge_centroid"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_bulge_centroid">[docs]</a><span class="k">def</span> <span class="nf">get_bulge_centroid</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">define</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">res_nums</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">define</span><span class="p">):</span>
        <span class="n">res_nums</span> <span class="o">+=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">define</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">define</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>

    <span class="c1">#print &gt;&gt;sys.stderr, &quot;res_nums:&quot;, res_nums</span>
    <span class="k">return</span> <span class="n">get_centroid</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">res_nums</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_furthest_c_alpha"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_furthest_c_alpha">[docs]</a><span class="k">def</span> <span class="nf">get_furthest_c_alpha</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">stem_end</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">seq_ids</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get the position of the c-alpha atom furthest from the end of the stem.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">max_dist</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">furthest_pos</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">res_ids</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">cg</span><span class="o">.</span><span class="n">get_resseqs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">seq_ids</span><span class="o">=</span><span class="n">seq_ids</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">res_ids</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">c_apos</span> <span class="o">=</span> <span class="n">chain</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">catom_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ke</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;Nucleotide </span><span class="si">%s</span><span class="s2"> missing in element </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">d</span> <span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">dist</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">stem_end</span> <span class="o">-</span> <span class="n">c_apos</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dist</span> <span class="o">&gt;=</span> <span class="n">max_dist</span><span class="p">:</span>
            <span class="n">max_dist</span> <span class="o">=</span> <span class="n">dist</span>
            <span class="n">furthest_pos</span> <span class="o">=</span> <span class="n">c_apos</span>

    <span class="k">return</span> <span class="n">furthest_pos</span></div>


<div class="viewcode-block" id="estimate_mids_core"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.estimate_mids_core">[docs]</a><span class="k">def</span> <span class="nf">estimate_mids_core</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">start1</span><span class="p">,</span> <span class="n">start2</span><span class="p">,</span> <span class="n">end1</span><span class="p">,</span> <span class="n">end2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get the start and end points of a helix.</span>

<span class="sd">    Presume that start1, start2, end1 and end2 are</span>
<span class="sd">    integers. This may not working with the resname mapping</span>
<span class="sd">    where there are missing nucleotides and such.</span>

<span class="sd">    Otherwise, it should only be called with the ideal stems</span>
<span class="sd">    which are numbered in a very orderely manner.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">start1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start1</span><span class="p">)</span>
    <span class="n">start2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start2</span><span class="p">)</span>

    <span class="n">end1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">end1</span><span class="p">)</span>
    <span class="n">end2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">end2</span><span class="p">)</span>
    <span class="c1">#assert(abs(end1 - start1) == abs(end2 - start2))</span>

    <span class="n">fragment_length</span> <span class="o">=</span> <span class="n">end1</span> <span class="o">-</span> <span class="n">start1</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">fragment_length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">error_str</span> <span class="o">=</span> <span class="s2">&quot;Helix shorter than 1 nucleotide: &quot;</span>
        <span class="n">error_str</span> <span class="o">+=</span> <span class="s2">&quot;start1: </span><span class="si">%d</span><span class="s2"> start2: </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">start1</span><span class="p">,</span> <span class="n">start2</span><span class="p">)</span>
        <span class="n">error_str</span> <span class="o">+=</span> <span class="s2">&quot;end1: </span><span class="si">%d</span><span class="s2"> end2: </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end1</span><span class="p">,</span> <span class="n">end2</span><span class="p">)</span>
        <span class="n">error_str</span> <span class="o">+=</span> <span class="s2">&quot;fragment_length: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fragment_length</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_str</span><span class="p">)</span>

    <span class="c1"># get the vector between the CA atoms of the two starting residues</span>
    <span class="c1"># as well as for the two next residues</span>
    <span class="n">start_vec1</span> <span class="o">=</span> <span class="p">(</span><span class="n">chain</span><span class="p">[</span><span class="n">start1</span><span class="p">][</span><span class="n">catom_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span> <span class="o">-</span>
                  <span class="n">chain</span><span class="p">[</span><span class="n">start2</span><span class="p">][</span><span class="n">catom_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">())</span>
    <span class="n">end_vec1</span> <span class="o">=</span> <span class="p">(</span><span class="n">chain</span><span class="p">[</span><span class="n">end1</span><span class="p">][</span><span class="n">catom_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span> <span class="o">-</span>
                <span class="n">chain</span><span class="p">[</span><span class="n">end2</span><span class="p">][</span><span class="n">catom_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">())</span>

    <span class="c1"># get the vector between the CA atoms of the two ending residues</span>
    <span class="c1"># as  well as for the two previous residues</span>
    <span class="n">start_vec2</span> <span class="o">=</span> <span class="p">(</span><span class="n">chain</span><span class="p">[</span><span class="n">start1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">catom_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span> <span class="o">-</span>
                  <span class="n">chain</span><span class="p">[</span><span class="n">start2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">catom_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">())</span>
    <span class="n">end_vec2</span> <span class="o">=</span> <span class="p">(</span><span class="n">chain</span><span class="p">[</span><span class="n">end1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">catom_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span> <span class="o">-</span>
                <span class="n">chain</span><span class="p">[</span><span class="n">end2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">catom_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">())</span>

    <span class="c1"># a vector kind of pointing in the direction of the helix</span>
    <span class="n">start_norm_vec</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">start_vec1</span><span class="o">.</span><span class="n">get_array</span><span class="p">(),</span>
                                        <span class="n">start_vec2</span><span class="o">.</span><span class="n">get_array</span><span class="p">()))</span>
    <span class="n">start_norm_vec</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>

    <span class="c1"># another vector kind of pointing in the directions of the helix</span>
    <span class="n">end_norm_vec</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">end_vec2</span><span class="o">.</span><span class="n">get_array</span><span class="p">(),</span>
                                      <span class="n">end_vec1</span><span class="o">.</span><span class="n">get_array</span><span class="p">()))</span>
    <span class="n">end_norm_vec</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>

    <span class="n">start_vec1</span> <span class="o">=</span> <span class="o">-</span><span class="n">start_vec1</span>
    <span class="n">end_vec1</span> <span class="o">=</span> <span class="o">-</span><span class="n">end_vec1</span>

    <span class="c1"># I guess we&#39;re converting them to Vector format in a weird sort of way...</span>
    <span class="c1"># otherwise these steps don&#39;t really make sense</span>
    <span class="n">start_axis_vec</span> <span class="o">=</span> <span class="n">start_vec1</span> <span class="o">+</span> <span class="n">bp</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
    <span class="n">start_axis_vec</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>

    <span class="n">end_axis_vec</span> <span class="o">=</span> <span class="n">end_vec1</span> <span class="o">+</span> <span class="n">bp</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
    <span class="n">end_axis_vec</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>

    <span class="n">start_origin</span> <span class="o">=</span> <span class="n">chain</span><span class="p">[</span><span class="n">start1</span><span class="p">][</span><span class="n">catom_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span>
    <span class="n">end_origin</span> <span class="o">=</span> <span class="n">chain</span><span class="p">[</span><span class="n">end1</span><span class="p">][</span><span class="n">catom_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span>

    <span class="n">start_y_vec</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">start_norm_vec</span><span class="o">.</span><span class="n">get_array</span><span class="p">(),</span>
                                     <span class="n">start_axis_vec</span><span class="o">.</span><span class="n">get_array</span><span class="p">()))</span>
    <span class="n">start_y_vec</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
    <span class="n">start_c_vec</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_axis_vec</span> <span class="o">+</span> <span class="n">start_y_vec</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">start_c_vec</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
    <span class="n">start_c_norm</span> <span class="o">=</span> <span class="n">start_origin</span> <span class="o">+</span> <span class="n">start_c_vec</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mf">8.4</span><span class="p">)</span>

    <span class="n">end_y_vec</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">end_norm_vec</span><span class="o">.</span><span class="n">get_array</span><span class="p">(),</span>
                                   <span class="n">end_axis_vec</span><span class="o">.</span><span class="n">get_array</span><span class="p">()))</span>
    <span class="n">end_y_vec</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
    <span class="n">end_c_vec</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_axis_vec</span> <span class="o">+</span> <span class="n">end_y_vec</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">end_c_vec</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
    <span class="n">end_c_norm</span> <span class="o">=</span> <span class="n">end_origin</span> <span class="o">+</span> <span class="n">end_c_vec</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mf">8.4</span><span class="p">)</span>

    <span class="n">mid1</span> <span class="o">=</span> <span class="n">start_c_norm</span>
    <span class="n">mid2</span> <span class="o">=</span> <span class="n">end_c_norm</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">mid1</span><span class="p">,</span> <span class="n">mid2</span><span class="p">)</span></div>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">#The implementation of this is incomplete!</span>
<span class="sd">def basenormals_mids(chain, start1, start2, end1, end2):</span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="sd">    Calculate a helix axis based on the base normal vectors.</span>

<span class="sd">    See Laederach et al., RNA 2007.</span>
<span class="sd">    &#39;&#39;&#39;</span>

<span class="sd">    # calculate the scatter matrix using the base normal vectors</span>
<span class="sd">    scatter = np.zeros((3, 3))</span>
<span class="sd">    base_normals = np.array([0., 0., 0.])</span>

<span class="sd">    residue_numbers = [i for i in range(start1, end1 + 1)]</span>
<span class="sd">    residue_numbers += [i for i in range(end2, start2 + 1)]</span>

<span class="sd">    for r in residue_numbers:</span>
<span class="sd">        c2 = chain[r][&#39;C2&#39;].get_vector().get_array()</span>
<span class="sd">        c4 = chain[r][&#39;C4&#39;].get_vector().get_array()</span>
<span class="sd">        c6 = chain[r][&#39;C6&#39;].get_vector().get_array()</span>

<span class="sd">        xi = cuv.normalize(np.cross(c2 - c4, c4 - c6))</span>
<span class="sd">        base_normals += xi</span>
<span class="sd">        scatter += np.dot(xi, xi.T)</span>

<span class="sd">    scatter /= float(len(residue_numbers))</span>
<span class="sd">    base_normals /= float(len(residue_numbers))</span>

<span class="sd">    # compute the eigenvalues and eigenvectors</span>
<span class="sd">    w, v = np.linalg.eig(scatter)</span>
<span class="sd">    index, value = max(enumerate(w), key=operator.itemgetter(1))</span>

<span class="sd">    # estimate the start and end position, which will be converted scaled</span>
<span class="sd">    # to the position of the helix axis</span>
<span class="sd">    &#39;&#39;&#39;&#39;</span>
<span class="sd">    start_pos = (chain[start1][catom_name].get_vector().get_array() +</span>
<span class="sd">                 chain[start2][catom_name].get_vector().get_array()) / 2.</span>


<span class="sd">    start1_catom = chain[start1 + real_stem_length][catom_name]</span>
<span class="sd">    start2_catom = chain[start2 + real_stem_length][catom_name]</span>
<span class="sd">    end_pos = (chain[start1 + start1_catom.get_vector().get_array() +</span>
<span class="sd">                 chain[start2 - start2_catom.get_vector().get_array()) / 2.</span>

<span class="sd">    print start_pos, end_pos</span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="get_mids_core_a"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_mids_core_a">[docs]</a><span class="k">def</span> <span class="nf">get_mids_core_a</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">start1</span><span class="p">,</span> <span class="n">start2</span><span class="p">,</span> <span class="n">end1</span><span class="p">,</span> <span class="n">end2</span><span class="p">,</span> 
                    <span class="n">use_template</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Estimate the stem cylinder using the old method and then refine it</span>
<span class="sd">    using fitted parameters.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;This is deprecated and will be removed in the future!&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_template</span><span class="p">:</span>
        <span class="n">template_stem_length</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">template_stem_length</span> <span class="o">=</span> <span class="n">end1</span> <span class="o">-</span> <span class="n">start1</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">real_stem_length</span> <span class="o">=</span> <span class="n">end1</span> <span class="o">-</span> <span class="n">start1</span>

    <span class="n">tstart1</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">tstart2</span> <span class="o">=</span> <span class="n">template_stem_length</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">tend1</span> <span class="o">=</span> <span class="n">template_stem_length</span>
    <span class="n">tend2</span> <span class="o">=</span> <span class="n">template_stem_length</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">template_filename</span> <span class="o">=</span> <span class="s1">&#39;ideal_1_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">.pdb&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tend1</span><span class="p">,</span> <span class="n">tend2</span><span class="p">,</span> <span class="n">tstart2</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">forgi</span><span class="o">.</span><span class="n">threedee</span><span class="o">.</span><span class="n">data_file</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                       <span class="n">template_filename</span><span class="p">))</span>
    <span class="n">ideal_chain</span> <span class="o">=</span> <span class="n">ftup</span><span class="o">.</span><span class="n">get_first_chain</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="n">est_mids</span> <span class="o">=</span> <span class="n">estimate_mids_core</span><span class="p">(</span><span class="n">ideal_chain</span><span class="p">,</span> <span class="n">tstart1</span><span class="p">,</span> <span class="n">tstart2</span><span class="p">,</span> <span class="n">tend1</span><span class="p">,</span> <span class="n">tend2</span><span class="p">)</span>
    <span class="n">est_mids</span> <span class="o">=</span> <span class="p">[</span><span class="n">est_mids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_array</span><span class="p">(),</span> <span class="n">est_mids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_array</span><span class="p">()]</span>

    <span class="n">start_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">chain</span><span class="p">[</span><span class="n">start1</span><span class="p">][</span><span class="n">catom_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span> <span class="o">+</span>
                 <span class="n">chain</span><span class="p">[</span><span class="n">start2</span><span class="p">][</span><span class="n">catom_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">())</span> <span class="o">/</span> <span class="mf">2.</span>

    <span class="n">start1_catom</span> <span class="o">=</span> <span class="n">chain</span><span class="p">[</span><span class="n">start1</span> <span class="o">+</span> <span class="n">real_stem_length</span><span class="p">][</span><span class="n">catom_name</span><span class="p">]</span>
    <span class="n">start2_catom</span> <span class="o">=</span> <span class="n">chain</span><span class="p">[</span><span class="n">start2</span> <span class="o">-</span> <span class="n">real_stem_length</span><span class="p">][</span><span class="n">catom_name</span><span class="p">]</span>

    <span class="n">end_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">start1_catom</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span> <span class="o">+</span>
               <span class="n">start2_catom</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">())</span> <span class="o">/</span> <span class="mf">2.</span>

    <span class="n">atom_poss</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">residue_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tstart1</span><span class="p">,</span> <span class="n">tend1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="n">residue_numbers</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tend2</span><span class="p">,</span> <span class="n">tstart2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">rn</span> <span class="ow">in</span> <span class="n">residue_numbers</span><span class="p">:</span>
        <span class="c1">#atom_poss += [chain[rn][&#39;C1*&#39;].get_vector().get_array()]</span>
        <span class="n">pot_atoms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;O3*&#39;</span><span class="p">,</span> <span class="s1">&#39;C3*&#39;</span><span class="p">,</span> <span class="s1">&#39;C4*&#39;</span><span class="p">,</span> <span class="s1">&#39;C5*&#39;</span><span class="p">,</span> <span class="s1">&#39;O5*&#39;</span><span class="p">,</span> <span class="s1">&#39;C1*&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">pot_atoms</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">atom_poss</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ideal_chain</span><span class="p">[</span><span class="n">rn</span><span class="p">][</span><span class="n">atom</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="n">mids</span> <span class="o">=</span> <span class="n">fit_circle</span><span class="p">(</span><span class="n">est_mids</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atom_poss</span><span class="p">),</span> <span class="n">start_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mids</span></div>


<div class="viewcode-block" id="get_mids_core"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_mids_core">[docs]</a><span class="k">def</span> <span class="nf">get_mids_core</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">define</span><span class="p">,</span>
                  <span class="n">use_template</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">seq_ids</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
    <span class="c1">######## Debug function</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    vec = mids[1] - mids[0]</span>
<span class="sd">    n1 = []</span>
<span class="sd">    n2 = []</span>
<span class="sd">    for i in range(0, end1-start1+1):</span>
<span class="sd">        notch1 = chain[start1+i][catom_name].get_vector().get_array()</span>
<span class="sd">        notch2 = chain[start2-i][catom_name].get_vector().get_array()</span>
<span class="sd">        basis = cuv.create_orthonormal_basis(vec)</span>
<span class="sd">        notch1_n = cuv.change_basis(notch1, basis, cuv.standard_basis)</span>
<span class="sd">        notch2_n = cuv.change_basis(notch2, basis, cuv.standard_basis)</span>

<span class="sd">        n1 += [notch1_n[0]]</span>
<span class="sd">        n2 += [notch2_n[0]]</span>
<span class="sd">    dists1 = [j-i for i,j in zip(n1[:-1], n1[1:])]</span>
<span class="sd">    dists2 = [j-i for i,j in zip(n2[:-1], n2[1:])]</span>

<span class="sd">    for dist in dists1 + dists2:</span>
<span class="sd">        print &quot;ladder&quot;, dist</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">######## End debug</span>

    <span class="n">stem_length</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">stem_length</span><span class="p">(</span><span class="n">define</span><span class="p">)</span>

    <span class="c1">#filename =</span>
    <span class="n">template_filename</span> <span class="o">=</span> <span class="s1">&#39;ideal_1_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">.pdb&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stem_length</span><span class="p">,</span> <span class="n">stem_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                                  <span class="n">stem_length</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">forgi</span><span class="o">.</span><span class="n">threedee</span><span class="o">.</span><span class="n">data_file</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">template_filename</span><span class="p">))</span>
    <span class="n">ideal_chain</span> <span class="o">=</span> <span class="n">ftup</span><span class="o">.</span><span class="n">get_first_chain</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># extract the coordinates of the stem from the input chain</span>
    <span class="c1"># and place them into a new chain</span>
    <span class="n">stem_chain</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">Chain</span><span class="o">.</span><span class="n">Chain</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="n">resnames</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">get_resseqs</span><span class="p">(</span><span class="n">define</span><span class="p">,</span> <span class="n">seq_ids</span><span class="o">=</span><span class="n">seq_ids</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">strand</span> <span class="ow">in</span> <span class="n">resnames</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">resname</span> <span class="ow">in</span> <span class="n">strand</span><span class="p">:</span>
            <span class="n">stem_chain</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">chain</span><span class="p">[</span><span class="n">resname</span><span class="p">])</span>


    <span class="c1"># get the rotation and translation to rotate the ideal chain onto</span>
    <span class="c1"># the stem chain</span>
    <span class="n">rotran</span> <span class="o">=</span> <span class="n">ftup</span><span class="o">.</span><span class="n">pdb_rmsd</span><span class="p">(</span><span class="n">stem_chain</span><span class="p">,</span> <span class="n">ideal_chain</span><span class="p">,</span> <span class="n">sidechains</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                          <span class="n">superimpose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">apply_sup</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># get the mids of the ideal chain using the fit method</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    ideal_mids = get_mids_core_a(ideal_chain, 1, stem_length * 2,</span>
<span class="sd">                                 stem_length, stem_length + 1,</span>
<span class="sd">                                 use_template=use_template)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># average length of a base-pair: 2.547</span>
    <span class="n">mult</span><span class="o">=</span><span class="mf">0.1</span>
    <span class="n">ideal_mids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">mult</span><span class="p">],</span> 
                  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="n">mult</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">stem_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.547</span><span class="p">])])</span>

    <span class="c1"># apply the rotation and translation to get the mids of the</span>
    <span class="c1"># target chain</span>
    <span class="c1">#chain_new_mids[0] = </span>

    <span class="n">chain_new_mids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ideal_mids</span><span class="p">,</span> <span class="n">rotran</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">rotran</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1">#chain_new_mids = [chain_new_mids[0] + mult * stem_vec, chain_new_mids[1] - mult * stem_vec]</span>

    <span class="c1"># return it as a Bio.PDB.Vector for some strange reason</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">bpdb</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="n">chain_new_mids</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="n">chain_new_mids</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span></div>


<div class="viewcode-block" id="get_twists_core"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_twists_core">[docs]</a><span class="k">def</span> <span class="nf">get_twists_core</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">define</span><span class="p">,</span>
                    <span class="n">mids</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">cc</span><span class="o">.</span><span class="n">Configuration</span><span class="o">.</span><span class="n">mids_method</span><span class="p">,</span>
                   <span class="n">seq_ids</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get the vectors indicating the twist of the cylinder. In actuality,</span>
<span class="sd">    this will be the projection of the (ca_start1 - mid1) onto the plane</span>
<span class="sd">    defined by (mid2 - mid1).</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">mids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">mids</span> <span class="o">=</span> <span class="n">get_mids</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">define</span><span class="p">,</span>
                        <span class="n">method</span><span class="o">=</span><span class="n">cc</span><span class="o">.</span><span class="n">Configuration</span><span class="o">.</span><span class="n">mids_method</span><span class="p">,</span> 
                        <span class="n">seq_ids</span><span class="o">=</span><span class="n">seq_ids</span><span class="p">)</span>

    <span class="n">resnames</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">get_resseqs</span><span class="p">(</span><span class="n">define</span><span class="p">,</span> <span class="n">seq_ids</span><span class="p">)</span>

    <span class="c1"># the first nucleotide of the first strand</span>
    <span class="c1"># and the last nucleotide of the second strand</span>
    <span class="n">start_vec1</span> <span class="o">=</span> <span class="n">chain</span><span class="p">[</span><span class="n">resnames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]][</span><span class="n">catom_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span> <span class="o">-</span> <span class="n">mids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">end_vec1</span> <span class="o">=</span> <span class="n">chain</span><span class="p">[</span><span class="n">resnames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]][</span><span class="n">catom_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span> <span class="o">-</span> <span class="n">mids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># the last nucleotide of the first strand</span>
    <span class="c1"># and the first nucleotide of the second strand</span>
    <span class="n">start_vec1a</span> <span class="o">=</span> <span class="n">chain</span><span class="p">[</span><span class="n">resnames</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]][</span><span class="n">catom_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span> <span class="o">-</span> <span class="n">mids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">end_vec1a</span> <span class="o">=</span> <span class="n">chain</span><span class="p">[</span><span class="n">resnames</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]][</span><span class="n">catom_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span> <span class="o">-</span> <span class="n">mids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">notch1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">vector_rejection</span><span class="p">(</span><span class="n">start_vec1</span><span class="o">.</span><span class="n">get_array</span><span class="p">(),</span>
                                  <span class="p">(</span><span class="n">mids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">mids</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">get_array</span><span class="p">())</span>
    <span class="n">notch2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">vector_rejection</span><span class="p">(</span><span class="n">end_vec1</span><span class="o">.</span><span class="n">get_array</span><span class="p">(),</span>
                                  <span class="p">(</span><span class="n">mids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">get_array</span><span class="p">())</span>

    <span class="n">notch1a</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">vector_rejection</span><span class="p">(</span><span class="n">start_vec1a</span><span class="o">.</span><span class="n">get_array</span><span class="p">(),</span>
                                   <span class="p">(</span><span class="n">mids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">mids</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">get_array</span><span class="p">())</span>
    <span class="n">notch2a</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">vector_rejection</span><span class="p">(</span><span class="n">end_vec1a</span><span class="o">.</span><span class="n">get_array</span><span class="p">(),</span>
                                   <span class="p">(</span><span class="n">mids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">get_array</span><span class="p">())</span>

    <span class="c1">#print &gt;&gt;sys.stderr, &quot;twist_angle_1:&quot;, cuv.vec_angle(notch1, notch1a)</span>
    <span class="c1">#print &gt;&gt;sys.stderr, &quot;twist_angle_2:&quot;, cuv.vec_angle(notch2, notch2a)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">cuv</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">notch1</span> <span class="o">+</span> <span class="n">notch1a</span><span class="p">),</span> <span class="n">cuv</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">notch2</span> <span class="o">+</span> <span class="n">notch2a</span><span class="p">))</span></div>
    <span class="c1">#return (normalize(notch1), normalize(notch2))</span>


<div class="viewcode-block" id="get_mids"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_mids">[docs]</a><span class="k">def</span> <span class="nf">get_mids</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">define</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">cc</span><span class="o">.</span><span class="n">Configuration</span><span class="o">.</span><span class="n">mids_method</span><span class="p">,</span> <span class="n">seq_ids</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get the mid points of the abstract cylinder which represents a helix.</span>

<span class="sd">    :param chain: The Bio.PDB representation of the 3D structure.</span>
<span class="sd">    :param define: The define of the helix, as per the BulgeGraph</span>
<span class="sd">                   definition standard.</span>
<span class="sd">    :return: An array of two vectors representing the two endpoints of the</span>
<span class="sd">             helix.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;template&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_mids_core</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">define</span><span class="p">,</span> <span class="n">seq_ids</span><span class="o">=</span><span class="n">seq_ids</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;fit&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_mids_fit_method</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">define</span><span class="p">,</span> <span class="n">seq_ids</span><span class="o">=</span><span class="n">seq_ids</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;superimpose&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_mids_core</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">define</span><span class="p">,</span> 
                             <span class="n">use_template</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">seq_ids</span><span class="o">=</span><span class="n">seq_ids</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;Unknown mids method:&quot;</span><span class="p">,</span> <span class="n">method</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    elif method == &#39;estimate&#39;:</span>
<span class="sd">        return estimate_mids_core(cg, chain, define,</span>
<span class="sd">                                  stem_length=stem_length)</span>
<span class="sd">    elif method == &#39;basenormals&#39;:</span>
<span class="sd">        return basenormals_mids(cg, chain, define,</span>
<span class="sd">                                stem_length=stem_length)</span>
<span class="sd">    &#39;&#39;&#39;</span></div>

<div class="viewcode-block" id="get_twists"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_twists">[docs]</a><span class="k">def</span> <span class="nf">get_twists</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">define</span><span class="p">,</span> <span class="n">mids</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">cc</span><span class="o">.</span><span class="n">Configuration</span><span class="o">.</span><span class="n">mids_method</span><span class="p">,</span>
              <span class="n">seq_ids</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get the projection of the (ca - mids) vectors onto the helix axis. This,</span>
<span class="sd">    in a sense will define how much the helix twists.</span>

<span class="sd">    :param cg: The CoarseGrainRNA representation</span>
<span class="sd">    :param chain: The Bio.PDB representation of the 3D structure.</span>
<span class="sd">    :param define: The name of the define</span>
<span class="sd">    :return: Two vectors which represent the twist of the helix.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="n">get_twists_core</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">define</span><span class="p">,</span> <span class="n">mids</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">seq_ids</span><span class="p">)</span></div>


<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">def get_helix_vector(chain, start1, start2, end1, end2):</span>
<span class="sd">    (mid1, mid2) = get_mids(chain, start1, start2, end1, end2)</span>
<span class="sd">    return mid2 - mid1</span>
<span class="sd">&#39;&#39;&#39;</span>


<div class="viewcode-block" id="virtual_res_3d_pos_core"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.virtual_res_3d_pos_core">[docs]</a><span class="k">def</span> <span class="nf">virtual_res_3d_pos_core</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">twists</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">stem_len</span><span class="p">,</span> <span class="n">stem_inv</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate the virtual position of the i&#39;th nucleotide in the stem.</span>

<span class="sd">    The virtual position extrapolates the position of the residues based</span>
<span class="sd">    on the twists of the helix.</span>

<span class="sd">    :return: A tuple containing the point located on the axis of the stem</span>
<span class="sd">             and a vector away from that point in the direction of the</span>
<span class="sd">             residue.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#stem_len = bg.defines[stem][1] - bg.defines[stem][0] + 1</span>
    <span class="n">stem_vec</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># the position of the virtual residue along the axis of</span>
    <span class="c1"># the stem</span>
    <span class="k">if</span> <span class="n">stem_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">vres_stem_pos</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vres_stem_pos</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">stem_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">stem_vec</span>

    <span class="c1"># the angle of the second twist with respect to the first</span>
    <span class="k">if</span> <span class="n">stem_inv</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">stem_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">stem_vec</span><span class="p">,</span> <span class="n">twists</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">twists</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">stem_basis</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">stem_inv</span><span class="p">,</span> <span class="n">twists</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">ang</span> <span class="o">=</span> <span class="n">ftum</span><span class="o">.</span><span class="n">atan3</span><span class="p">(</span><span class="n">t2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">t2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># calculated from an ideal length 30 helix</span>
    <span class="n">average_ang_per_nt</span> <span class="o">=</span> <span class="mf">0.636738030735</span>
    <span class="n">expected_ang</span> <span class="o">=</span> <span class="p">(</span><span class="n">stem_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">average_ang_per_nt</span>
    <span class="n">expected_dev</span> <span class="o">=</span> <span class="n">expected_ang</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">expected_dev</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">expected_dev</span> <span class="o">-=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">pi</span>

    <span class="k">if</span> <span class="n">ang</span> <span class="o">&lt;</span> <span class="n">expected_dev</span><span class="p">:</span>
        <span class="n">forward</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="n">ang</span> <span class="o">-</span> <span class="n">expected_dev</span>
        <span class="n">backward</span> <span class="o">=</span> <span class="n">expected_dev</span> <span class="o">-</span> <span class="n">ang</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">forward</span> <span class="o">=</span> <span class="n">ang</span> <span class="o">-</span> <span class="n">expected_dev</span>
        <span class="n">backward</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="n">expected_dev</span> <span class="o">-</span> <span class="n">ang</span>

    <span class="k">if</span> <span class="n">forward</span> <span class="o">&lt;</span> <span class="n">backward</span><span class="p">:</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="n">expected_ang</span> <span class="o">+</span> <span class="n">forward</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="n">expected_ang</span> <span class="o">-</span> <span class="n">backward</span>

    <span class="k">if</span> <span class="n">stem_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ang_per_nt</span> <span class="o">=</span> <span class="n">ang</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">stem_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="n">ang_per_nt</span> <span class="o">*</span> <span class="n">i</span>

    <span class="c1"># the basis vectors for the helix along which the</span>
    <span class="c1"># virtual residues will residue</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">twists</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">stem_vec</span><span class="p">,</span> <span class="n">twists</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="n">ang_offset</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="c1"># equation for a circle in 3-space</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">vres_stem_pos</span><span class="p">,</span>
            <span class="n">u</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang</span><span class="p">)</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span><span class="p">),</span>
            <span class="n">u</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang</span> <span class="o">+</span> <span class="n">ang_offset</span><span class="p">)</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span> <span class="o">+</span> <span class="n">ang_offset</span><span class="p">),</span>
            <span class="n">u</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang</span> <span class="o">-</span> <span class="n">ang_offset</span><span class="p">)</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span> <span class="o">-</span> <span class="n">ang_offset</span><span class="p">))</span></div>


<div class="viewcode-block" id="virtual_res_3d_pos"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.virtual_res_3d_pos">[docs]</a><span class="k">def</span> <span class="nf">virtual_res_3d_pos</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">stem</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">stem_inv</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stem_length</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">stem_length</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">virtual_res_3d_pos_core</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem</span><span class="p">],</span> <span class="n">bg</span><span class="o">.</span><span class="n">twists</span><span class="p">[</span><span class="n">stem</span><span class="p">],</span> <span class="n">i</span><span class="p">,</span>
                                       <span class="n">bg</span><span class="o">.</span><span class="n">stem_length</span><span class="p">(</span><span class="n">stem</span><span class="p">),</span> <span class="n">stem_inv</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">virtual_res_3d_pos_core</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem</span><span class="p">],</span> <span class="n">bg</span><span class="o">.</span><span class="n">twists</span><span class="p">[</span><span class="n">stem</span><span class="p">],</span> <span class="n">i</span><span class="p">,</span>
                                       <span class="n">stem_length</span><span class="p">,</span> <span class="n">stem_inv</span><span class="p">)</span></div>

<div class="viewcode-block" id="bg_virtual_residues"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.bg_virtual_residues">[docs]</a><span class="k">def</span> <span class="nf">bg_virtual_residues</span><span class="p">(</span><span class="n">bg</span><span class="p">):</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;ftug.bg_virtual_residues will be removed in the future.&quot;</span>
                  <span class="s2">&quot;Use cg.add_virtual_residues instead to store the virtual &quot;</span>
                  <span class="s2">&quot;residues directly to the CoarseGrainRNA and cg.get_ordered_virtual_residue_poss&quot;</span>
                  <span class="s2">&quot;to retrieve the virtual residue positions.&quot;</span> <span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">vress</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">bg</span><span class="o">.</span><span class="n">sorted_stem_iterator</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">stem_length</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
            <span class="n">vres</span> <span class="o">=</span> <span class="n">virtual_res_3d_pos</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">vress</span> <span class="o">+=</span> <span class="p">[</span><span class="n">vres</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">vres</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">vres</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">vres</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vress</span><span class="p">)</span></div>

<span class="c1">#Seems to be unused!</span>
<div class="viewcode-block" id="numbered_virtual_residues"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.numbered_virtual_residues">[docs]</a><span class="k">def</span> <span class="nf">numbered_virtual_residues</span><span class="p">(</span><span class="n">bg</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Return a list of virtual residues, along with their</span>
<span class="sd">    nucleotide positions.</span>

<span class="sd">    :param bg: A coarse grain RNA</span>
<span class="sd">    :return: A list of tuples containing nucleotides numbers and coordinates.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">vress</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">bg</span><span class="o">.</span><span class="n">sorted_stem_iterator</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">stem_length</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
            <span class="n">vres</span> <span class="o">=</span> <span class="n">virtual_res_3d_pos</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">vress</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">bg</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">vres</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">vres</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">vres</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">vres</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span>

    <span class="k">return</span> <span class="n">vress</span></div>

<div class="viewcode-block" id="virtual_res_basis_core"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.virtual_res_basis_core">[docs]</a><span class="k">def</span> <span class="nf">virtual_res_basis_core</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">twists</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">stem_len</span><span class="p">,</span> <span class="n">vec</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Define a basis based on the location of a virtual stem residue.</span>

<span class="sd">    The basis will be defined by the direction of the stem, the direction</span>
<span class="sd">    of the virtual residue.</span>

<span class="sd">    :param bg: The BulgeGraph structure</span>
<span class="sd">    :param stem: The name of the stem</span>
<span class="sd">    :param i: The i&#39;th residue of the stem</span>

<span class="sd">    :return: A 3x3 matrix defining the coordinate system above.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">vec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">vec_l</span><span class="p">,</span> <span class="n">vec_r</span><span class="p">)</span> <span class="o">=</span> <span class="n">virtual_res_3d_pos_core</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">twists</span><span class="p">,</span>
                                                           <span class="n">i</span><span class="p">,</span> <span class="n">stem_len</span><span class="p">)</span>

    <span class="n">stem_vec</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">stem_vec</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span></div>


<div class="viewcode-block" id="virtual_res_basis"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.virtual_res_basis">[docs]</a><span class="k">def</span> <span class="nf">virtual_res_basis</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">stem</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">vec</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">virtual_res_basis_core</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem</span><span class="p">],</span> <span class="n">bg</span><span class="o">.</span><span class="n">twists</span><span class="p">[</span><span class="n">stem</span><span class="p">],</span> <span class="n">i</span><span class="p">,</span>
                                  <span class="n">bg</span><span class="o">.</span><span class="n">stem_length</span><span class="p">(</span><span class="n">stem</span><span class="p">),</span> <span class="n">vec</span><span class="p">)</span></div>


<div class="viewcode-block" id="pos_to_spos"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.pos_to_spos">[docs]</a><span class="k">def</span> <span class="nf">pos_to_spos</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">i2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convert the location of s2, i2 into the coordinate system</span>
<span class="sd">    defined by (s1, i1)</span>

<span class="sd">    :param bg: The BulgeGraph containing the stems</span>
<span class="sd">    :param s1: The basis stem name</span>
<span class="sd">    :param i1: The basis res position</span>
<span class="sd">    :param s2: The stem containing the nucleotide to be converted</span>
<span class="sd">    :param i2: The nucleotide to be converted position</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">sbasis</span> <span class="o">=</span> <span class="n">virtual_res_basis</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">i1</span><span class="p">)</span>
    <span class="p">(</span><span class="n">s1_pos</span><span class="p">,</span> <span class="n">s1_vec</span><span class="p">,</span> <span class="n">s1_vec_l</span><span class="p">,</span> <span class="n">s1_vec_r</span><span class="p">)</span> <span class="o">=</span> <span class="n">virtual_res_3d_pos</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">i1</span><span class="p">)</span>
    <span class="p">(</span><span class="n">s2_pos</span><span class="p">,</span> <span class="n">s2_vec</span><span class="p">,</span> <span class="n">s2_vec_l</span><span class="p">,</span> <span class="n">s2_vec_r</span><span class="p">)</span> <span class="o">=</span> <span class="n">virtual_res_3d_pos</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">i2</span><span class="p">)</span>

    <span class="c1">#rpos = (s2_pos + 7. * s2_vec) - (s1_pos + 7 * s1_vec)</span>
    <span class="n">rpos</span> <span class="o">=</span> <span class="p">(</span><span class="n">s2_pos</span> <span class="o">+</span> <span class="mf">7.</span> <span class="o">*</span> <span class="n">s2_vec</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">s1_pos</span><span class="p">)</span>
    <span class="c1">#print &quot;sbasis:&quot;, sbasis</span>

    <span class="n">spos</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">rpos</span><span class="p">,</span> <span class="n">sbasis</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    if spos[1] ** 2 + spos[2] ** 2 &lt; 5 and spos[0] &gt; -5 and spos[0] &lt; 5:</span>
<span class="sd">        print &gt;&gt;sys.stderr, &quot;spos:&quot;, spos, s1, i1, s2, i2</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">spos</span></div>


<div class="viewcode-block" id="spos_to_pos"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.spos_to_pos">[docs]</a><span class="k">def</span> <span class="nf">spos_to_pos</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">stem</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">spos</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convert the location of spos from the coordinate system</span>
<span class="sd">    of (stem, i) into the standard coordinate system.</span>

<span class="sd">    :param bg: The BulgeGraph</span>
<span class="sd">    :param stem: The name of the stem in the BulgeGraph</span>
<span class="sd">    :param i: The i&#39;th residue in &#39;stem&#39; which will define the coordinate</span>
<span class="sd">              system</span>
<span class="sd">    :param spos: The position in the alternate coordinate system</span>

<span class="sd">    :return: The coordinates in the cartesian coordinate system of the</span>
<span class="sd">        rest of the model.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">stem</span> <span class="ow">in</span> <span class="n">bg</span><span class="o">.</span><span class="n">vbases</span> <span class="ow">and</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bg</span><span class="o">.</span><span class="n">vbases</span><span class="p">[</span><span class="n">stem</span><span class="p">]:</span>
        <span class="n">sbasis</span><span class="o">=</span><span class="n">bg</span><span class="o">.</span><span class="n">vbases</span><span class="p">[</span><span class="n">stem</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sbasis</span> <span class="o">=</span> <span class="n">virtual_res_basis</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">stem</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">spos</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">,</span> <span class="n">sbasis</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="p">(</span><span class="n">s1_pos</span><span class="p">,</span> <span class="n">s1_vec</span><span class="p">,</span> <span class="n">s1_vec_l</span><span class="p">,</span> <span class="n">s1_vec_r</span><span class="p">)</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">v3dposs</span><span class="p">[</span><span class="n">stem</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">add_virtual_residues</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">stem</span><span class="p">)</span>
        <span class="p">(</span><span class="n">s1_pos</span><span class="p">,</span> <span class="n">s1_vec</span><span class="p">,</span> <span class="n">s1_vec_l</span><span class="p">,</span> <span class="n">s1_vec_r</span><span class="p">)</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">v3dposs</span><span class="p">[</span><span class="n">stem</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">pos</span> <span class="o">+</span> <span class="p">(</span><span class="n">s1_pos</span> <span class="o">+</span> <span class="n">s1_vec</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_residue_type"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_residue_type">[docs]</a><span class="k">def</span> <span class="nf">get_residue_type</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">stem_len</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Each nucleotide will be classified according to its position</span>
<span class="sd">    within the stem. That way, the distribution of surrounding</span>
<span class="sd">    nucleotides will be conditioned on the type of nucleotides.</span>

<span class="sd">    This is important due to the fact that nucleotides at the end</span>
<span class="sd">    of a stem may have other stem nucleotides in the direction</span>
<span class="sd">    of the stem vector. Nucleotides, in the middle shoubulge not due</span>
<span class="sd">    to the excluded volume of the stem they occupy.</span>

<span class="sd">    :param i: The position of the nucleotide.</span>
<span class="sd">    :param stem_len: The length of the stem.</span>

<span class="sd">    :return: The type of nucleotide position.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">stem_len</span><span class="p">)</span>

    <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="junction_virtual_res_distance"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.junction_virtual_res_distance">[docs]</a><span class="k">def</span> <span class="nf">junction_virtual_res_distance</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">bulge</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Compute the distance between the two virtual residues flanking</span>
<span class="sd">    a bulge region.</span>

<span class="sd">    :param bg: The BulgeGraph containing the bulge.</span>
<span class="sd">    :param bulge: The name of the bulge.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">cs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">bulge</span><span class="p">])</span>

    <span class="p">(</span><span class="n">s1b</span><span class="p">,</span> <span class="n">s1e</span><span class="p">)</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">get_sides</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bulge</span><span class="p">)</span>
    <span class="p">(</span><span class="n">s2b</span><span class="p">,</span> <span class="n">s2e</span><span class="p">)</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">get_sides</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bulge</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">s1b</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">v3dposs</span><span class="p">[</span><span class="n">cs</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">bg</span><span class="o">.</span><span class="n">stem_length</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">v3dposs</span><span class="p">[</span><span class="n">cs</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">(</span><span class="n">vr1_p</span><span class="p">,</span> <span class="n">vr1_v</span><span class="p">,</span> <span class="n">vr1_v_l</span><span class="p">,</span> <span class="n">vr1_v_r</span><span class="p">)</span> <span class="o">=</span> <span class="n">res</span>

    <span class="k">if</span> <span class="n">s2b</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">v3dposs</span><span class="p">[</span><span class="n">cs</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">bg</span><span class="o">.</span><span class="n">stem_length</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">v3dposs</span><span class="p">[</span><span class="n">cs</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>

    <span class="p">(</span><span class="n">vr2_p</span><span class="p">,</span> <span class="n">vr2_v</span><span class="p">,</span> <span class="n">vr2_v_l</span><span class="p">,</span> <span class="n">vr2_v_r</span><span class="p">)</span> <span class="o">=</span> <span class="n">res</span>

    <span class="n">dist2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">vec_distance</span><span class="p">((</span><span class="n">vr1_p</span> <span class="o">+</span> <span class="mf">7.</span> <span class="o">*</span> <span class="n">vr1_v</span><span class="p">),</span> <span class="p">(</span><span class="n">vr2_p</span> <span class="o">+</span> <span class="mf">7.</span> <span class="o">*</span> <span class="n">vr2_v</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dist2</span></div>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">def get_strand_atom_vrn(bg, s, i):</span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="sd">    Return the strand and which atom to use for the adjacent</span>
<span class="sd">    nucleotide distance calculation.</span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="sd">    if i == 0:</span>
<span class="sd">        return (0, &#39;P&#39;, 0)</span>

<span class="sd">    # this might have to just be bg.stem_length(s)</span>
<span class="sd">    if i == 1:</span>
<span class="sd">        return (0, &#39;O3*&#39;, bg.stem_length(s) - 1)</span>
<span class="sd">    if i == 2:</span>
<span class="sd">        return (1, &#39;P&#39;, bg.stem_length(s) - 1)</span>
<span class="sd">    if i == 3:</span>
<span class="sd">        return (1, &#39;O3*&#39;, 0)</span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="junction_virtual_atom_distance"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.junction_virtual_atom_distance">[docs]</a><span class="k">def</span> <span class="nf">junction_virtual_atom_distance</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">bulge</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Compute the distance between the O3&#39; atom and P&#39; atom</span>
<span class="sd">    of the two residues that flank the junction segment.</span>

<span class="sd">    :param bg: The BulgeGraph containing the bulge.</span>
<span class="sd">    :param bulge: The name of the bulge</span>

<span class="sd">    :return: A single number corresponding to the distance above.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">connecting_stems</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">connections</span><span class="p">(</span><span class="n">bulge</span><span class="p">)</span>    
    <span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">k1</span><span class="p">)</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">get_sides_plus</span><span class="p">(</span><span class="n">connecting_stems</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bulge</span><span class="p">)</span>
    <span class="p">(</span><span class="n">i2</span><span class="p">,</span> <span class="n">k2</span><span class="p">)</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">get_sides_plus</span><span class="p">(</span><span class="n">connecting_stems</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bulge</span><span class="p">)</span>
    <span class="n">pos1</span><span class="o">=</span><span class="n">bg</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">connecting_stems</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">i1</span><span class="p">]</span>
    <span class="n">pos2</span><span class="o">=</span><span class="n">bg</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">connecting_stems</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">i2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">i1</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">i1</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">a1</span><span class="o">=</span><span class="s2">&quot;P&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a1</span><span class="o">=</span><span class="s2">&quot;O3&#39;&quot;</span>
    <span class="k">if</span> <span class="n">i2</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">i2</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">a2</span><span class="o">=</span><span class="s2">&quot;P&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a2</span><span class="o">=</span><span class="s2">&quot;O3&#39;&quot;</span>
    <span class="k">assert</span> <span class="n">a1</span><span class="o">!=</span><span class="n">a2</span>
    <span class="k">return</span> <span class="n">cuv</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">virtual_atoms</span><span class="p">(</span><span class="n">pos1</span><span class="p">)[</span><span class="n">a1</span><span class="p">]</span><span class="o">-</span><span class="n">bg</span><span class="o">.</span><span class="n">virtual_atoms</span><span class="p">(</span><span class="n">pos2</span><span class="p">)[</span><span class="n">a2</span><span class="p">])</span></div>


<div class="viewcode-block" id="add_virtual_residues"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.add_virtual_residues">[docs]</a><span class="k">def</span> <span class="nf">add_virtual_residues</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">stem</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create all of the virtual residues and the associated</span>
<span class="sd">    bases and inverses for the given stem.</span>

<span class="sd">    .. note::</span>
<span class="sd">       This is a low-level function used if only the virtual residues of a single </span>
<span class="sd">       stems should be added. To add the virtual residues for all stems, use</span>
<span class="sd">       `cg.add_all_virtual_residues`</span>

<span class="sd">    :param bg: The CoarseGrainRNA bulge graph containing the stem</span>
<span class="sd">    :param stem: The name of the stem to be included</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">stem_vec</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">stem_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">stem_vec</span><span class="p">,</span> <span class="n">bg</span><span class="o">.</span><span class="n">get_twists</span><span class="p">(</span><span class="n">stem</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">stem_inv</span> <span class="o">=</span> <span class="n">nl</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">stem_basis</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>

    <span class="n">bg</span><span class="o">.</span><span class="n">bases</span><span class="p">[</span><span class="n">stem</span><span class="p">]</span> <span class="o">=</span> <span class="n">stem_basis</span>
    <span class="n">bg</span><span class="o">.</span><span class="n">stem_invs</span><span class="p">[</span><span class="n">stem</span><span class="p">]</span> <span class="o">=</span> <span class="n">stem_inv</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">stem_length</span><span class="p">(</span><span class="n">stem</span><span class="p">)):</span>
        <span class="n">vpos</span> <span class="o">=</span> <span class="n">virtual_res_3d_pos</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">stem</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">stem_inv</span><span class="o">=</span><span class="n">stem_inv</span><span class="p">)</span>
        <span class="n">vbasis</span> <span class="o">=</span> <span class="n">virtual_res_basis</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">stem</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">vec</span><span class="o">=</span><span class="n">vpos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">vinv</span> <span class="o">=</span> <span class="n">nl</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">vbasis</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>

        <span class="n">bg</span><span class="o">.</span><span class="n">vposs</span><span class="p">[</span><span class="n">stem</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vpos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">bg</span><span class="o">.</span><span class="n">vvecs</span><span class="p">[</span><span class="n">stem</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vpos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">bg</span><span class="o">.</span><span class="n">v3dposs</span><span class="p">[</span><span class="n">stem</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vpos</span>
        <span class="n">bg</span><span class="o">.</span><span class="n">vbases</span><span class="p">[</span><span class="n">stem</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vbasis</span>
        <span class="n">bg</span><span class="o">.</span><span class="n">vinvs</span><span class="p">[</span><span class="n">stem</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vinv</span></div>


<span class="c1"># TODO: This should probably use pos_to_spos to reduce code duplication.</span>
<div class="viewcode-block" id="stem_vres_reference_atoms"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.stem_vres_reference_atoms">[docs]</a><span class="k">def</span> <span class="nf">stem_vres_reference_atoms</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate the position of each atom in the reference of the</span>
<span class="sd">    stem and virtual residue.</span>

<span class="sd">    :param bg: The BulgeGraph</span>
<span class="sd">    :param chain: The PDB representation of the chain</span>
<span class="sd">    :param s: The stem identifier</span>
<span class="sd">    :param i: The i&#39;th base-pair in the stem</span>

<span class="sd">    :return (origin, bases, [dict(atoms), dict(atoms)])</span>
<span class="sd">        The origin of the coordinate system (vpos)</span>
<span class="sd">        The basises (one for each nucleotide)</span>
<span class="sd">        Two dictionaries containing the positions of each atom in its</span>
<span class="sd">        respective coordinate system.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(),</span> <span class="nb">dict</span><span class="p">()]</span>
    <span class="p">(</span><span class="n">vpos</span><span class="p">,</span> <span class="n">vvec</span><span class="p">,</span> <span class="n">vvec_l</span><span class="p">,</span> <span class="n">vvec_r</span><span class="p">)</span> <span class="o">=</span> <span class="n">virtual_res_3d_pos</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">vec1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">vec2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">vvec</span><span class="p">)</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">vec1</span><span class="p">,</span> <span class="n">vec2</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span>

        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">ftup</span><span class="o">.</span><span class="n">all_rna_atoms</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">chain</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">atom</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span>
                <span class="n">new_c</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">vpos</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span>
                <span class="n">coords</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_c</span>

            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">continue</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">vpos</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span></div>


<div class="viewcode-block" id="bounding_boxes"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.bounding_boxes">[docs]</a><span class="k">def</span> <span class="nf">bounding_boxes</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Return the bounding boxes of the two nucleotides at the</span>
<span class="sd">    i&#39;th position on the stem.</span>

<span class="sd">    :param bg: The BulgeGraph</span>
<span class="sd">    :param chain: The PDB representation of the chain</span>
<span class="sd">    :param s: The stem identifier</span>
<span class="sd">    :param i: The i&#39;th base-pair in the stem</span>

<span class="sd">    :return: (origin, bases, [(c1, c2), (c1, c2)]) The bases</span>
<span class="sd">            (one for each nucleotide) and the corners defining the bounding box</span>
<span class="sd">            of the two nucleotides</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="p">(</span><span class="n">vpos</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">atoms</span><span class="p">)</span> <span class="o">=</span> <span class="n">stem_vres_reference_atoms</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">corners</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">min_c</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10000.</span><span class="p">,</span> <span class="mf">10000.</span><span class="p">,</span> <span class="mf">10000.</span><span class="p">]</span>
        <span class="n">max_c</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">10000.</span><span class="p">,</span> <span class="o">-</span><span class="mf">10000.</span><span class="p">,</span> <span class="o">-</span><span class="mf">10000.</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">min_c</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">min_c</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">atom</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">max_c</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_c</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">atom</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">min_c</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">max_c</span>
        <span class="n">corners</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">)]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">vpos</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">corners</span><span class="p">)</span></div>


<div class="viewcode-block" id="virtual_residue_atoms"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.virtual_residue_atoms">[docs]</a><span class="k">def</span> <span class="nf">virtual_residue_atoms</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">strand</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Return the atoms for the virtual residue. </span>

<span class="sd">    :param bg: The BulgeGraph</span>
<span class="sd">    :param s: The stem</span>
<span class="sd">    :param i: The virtual residue number</span>
<span class="sd">    :param strand: The strand for which to get the virtual atoms</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    if vpos == None or vvec == None:</span>
<span class="sd">        (vpos, vvec, vvec_l, vvec_r) = virtual_res_3d_pos(bg, s, i)</span>
<span class="sd">    if basis == None:</span>
<span class="sd">        basis = virtual_res_basis(bg, s, i, vvec).transpose()</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s2">&quot;s&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected stem (not single-stranded RNA element), got {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

    <span class="n">glob_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">bg</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">glob_pos</span> <span class="o">=</span> <span class="n">glob_pos</span><span class="p">[</span><span class="n">strand</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">bg</span><span class="o">.</span><span class="n">virtual_atoms</span><span class="p">(</span><span class="n">glob_pos</span><span class="p">)</span></div>


<div class="viewcode-block" id="calc_R"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.calc_R">[docs]</a><span class="k">def</span> <span class="nf">calc_R</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; calculate the distance of each 2D points from the center (xc, yc) &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">p</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xc</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">yc</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="f_2"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.f_2">[docs]</a><span class="k">def</span> <span class="nf">f_2</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; calculate the algebraic distance between the data points and the mean</span>
<span class="sd">        circle centered at c=(xc, yc) &quot;&quot;&quot;</span>
    <span class="n">Ri</span> <span class="o">=</span> <span class="n">calc_R</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Ri</span> <span class="o">-</span> <span class="n">Ri</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span></div>

<div class="viewcode-block" id="circle_fit"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.circle_fit">[docs]</a><span class="k">def</span> <span class="nf">circle_fit</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">x_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="n">u</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">x_m</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">y_m</span>

        <span class="c1"># linear system defining the center (uc, vc) in reduced coordinates:</span>
    <span class="c1">#    Suu * uc +  Suv * vc = (Suuu + Suvv)/2</span>
    <span class="c1">#    Suv * uc +  Svv * vc = (Suuv + Svvv)/2</span>
    <span class="n">Suv</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">Suu</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">u</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">Svv</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">Suuv</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">u</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">Suvv</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">v</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">Suuu</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">u</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">Svvv</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Solving the linear system</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">Suu</span><span class="p">,</span> <span class="n">Suv</span><span class="p">],</span> <span class="p">[</span><span class="n">Suv</span><span class="p">,</span> <span class="n">Svv</span><span class="p">]])</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Suuu</span> <span class="o">+</span> <span class="n">Suvv</span><span class="p">,</span> <span class="n">Svvv</span> <span class="o">+</span> <span class="n">Suuv</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="n">uc</span><span class="p">,</span> <span class="n">vc</span> <span class="o">=</span> <span class="n">nl</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>

    <span class="n">xc_1</span> <span class="o">=</span> <span class="n">x_m</span> <span class="o">+</span> <span class="n">uc</span>
    <span class="n">yc_1</span> <span class="o">=</span> <span class="n">y_m</span> <span class="o">+</span> <span class="n">vc</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">xc_1</span><span class="p">,</span> <span class="n">yc_1</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Ri_1     = sqrt((x-xc_1)**2 + (y-yc_1)**2)</span>
<span class="sd">    R_1      = mean(Ri_1)</span>
<span class="sd">    residu_1 = sum((Ri_1-R_1)**2)</span>

<span class="sd">    return (xc_1, yc_1, R_1)</span>
<span class="sd">    &#39;&#39;&#39;</span></div>

<div class="viewcode-block" id="circle_error"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.circle_error">[docs]</a><span class="k">def</span> <span class="nf">circle_error</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="n">f_2</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">e</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">])</span></div>


<div class="viewcode-block" id="f_3"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.f_3">[docs]</a><span class="k">def</span> <span class="nf">f_3</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">est</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; calculate the optimal circle for the points (p) projected onto</span>
<span class="sd">    the plane orthogonal to v &quot;&quot;&quot;</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
    <span class="n">new_points</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">new_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>

    <span class="c1">#center_2, ier=so.leastsq(f_2, center_estimate,args=p)</span>
    <span class="n">center_2</span> <span class="o">=</span> <span class="n">circle_fit</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">f_2</span><span class="p">(</span><span class="n">center_2</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span></div>


<div class="viewcode-block" id="fit_circle"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.fit_circle">[docs]</a><span class="k">def</span> <span class="nf">fit_circle</span><span class="p">(</span><span class="n">mids</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">start_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate the projection of points on the plane normal to</span>
<span class="sd">    vec and fit a circle to them.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">v1</span><span class="p">,</span> <span class="n">ier</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">leastsq</span><span class="p">(</span><span class="n">f_3</span><span class="p">,</span> <span class="n">mids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                             <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">mids</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]))</span>

    <span class="n">basis1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>

    <span class="n">points1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">basis1</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">start_pos1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">start_pos</span><span class="p">,</span> <span class="n">basis1</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span>
    <span class="n">end_pos1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">end_pos</span><span class="p">,</span> <span class="n">basis1</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span>

    <span class="n">center_5</span> <span class="o">=</span> <span class="n">circle_fit</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])</span>

    <span class="n">mids_stem_basis</span> <span class="o">=</span> <span class="p">[[</span><span class="n">start_pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center_5</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center_5</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                       <span class="p">[</span><span class="n">end_pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center_5</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center_5</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
    <span class="n">mids_standard_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mids_stem_basis</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                           <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">,</span> <span class="n">basis1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    # works!</span>
<span class="sd">    mids_stem_basis = [[nmids[0][0], center_4[0], center_4[1]],</span>
<span class="sd">                       [nmids[1][0], center_4[0], center_4[1]]]</span>
<span class="sd">    mids_standard_basis = cuv.change_basis(np.array(mids_stem_basis).T,</span>
<span class="sd">                                           cuv.standard_basis,</span>
<span class="sd">                                           basis).T</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">mids_standard_basis</span></div>


<div class="viewcode-block" id="extract_define_residues"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.extract_define_residues">[docs]</a><span class="k">def</span> <span class="nf">extract_define_residues</span><span class="p">(</span><span class="n">define</span><span class="p">,</span> <span class="n">chain</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Extract the residues in the define and return them as a new chain.&#39;&#39;&#39;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">Chain</span><span class="o">.</span><span class="n">Chain</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="n">ranges</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">define</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">c</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">chain</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">c</span></div>


<div class="viewcode-block" id="fit_circle_old"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.fit_circle_old">[docs]</a><span class="k">def</span> <span class="nf">fit_circle_old</span><span class="p">(</span><span class="n">mids</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">start_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">stem_length</span><span class="p">,</span>
                   <span class="n">define</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate the projection of points on the plane normal to</span>
<span class="sd">    vec and fit a circle to them.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">template_filename</span> <span class="o">=</span> <span class="s1">&#39;ideal_1_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">.pdb&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stem_length</span><span class="p">,</span> <span class="n">stem_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                                  <span class="n">stem_length</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">Configuration</span><span class="o">.</span><span class="n">stem_fragment_dir</span><span class="p">,</span>
                       <span class="n">template_filename</span><span class="p">)</span>
    <span class="n">ideal_chain</span> <span class="o">=</span> <span class="n">ftup</span><span class="o">.</span><span class="n">get_first_chain</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    rotran = ftup.pdb_rmsd(ideal_chain, chain, sidechains=False,</span>
<span class="sd">            superimpose=True, apply_sup=False)[2]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">rotran</span> <span class="o">=</span> <span class="n">ftup</span><span class="o">.</span><span class="n">pdb_rmsd</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">ideal_chain</span><span class="p">,</span> <span class="n">sidechains</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                          <span class="n">superimpose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">apply_sup</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">ideal_mids</span> <span class="o">=</span> <span class="n">get_mids_core</span><span class="p">(</span><span class="n">ideal_chain</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">stem_length</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                               <span class="n">stem_length</span><span class="p">,</span> <span class="n">stem_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">ideal_mids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ideal_mids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_array</span><span class="p">(),</span>
                           <span class="n">ideal_mids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_array</span><span class="p">()])</span>

    <span class="n">chain_new_mids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ideal_mids</span><span class="p">,</span> <span class="n">rotran</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">rotran</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">chain_new_mids</span>

    <span class="n">vec</span> <span class="o">=</span> <span class="n">mids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
    <span class="n">new_points</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">new_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">f_3</span><span class="p">(</span><span class="n">mids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">,</span> <span class="n">mids</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>

    <span class="n">v1</span><span class="p">,</span> <span class="n">ier</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">leastsq</span><span class="p">(</span><span class="n">f_3</span><span class="p">,</span> <span class="n">mids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">mids</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]),</span>
                         <span class="n">maxfev</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
    <span class="n">basis1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>

    <span class="n">points1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">basis1</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">start_pos1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">start_pos</span><span class="p">,</span> <span class="n">basis1</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span>
    <span class="n">end_pos1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">end_pos</span><span class="p">,</span> <span class="n">basis1</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span>

    <span class="n">center_5</span> <span class="o">=</span> <span class="n">circle_fit</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])</span>
    <span class="n">r5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">calc_R</span><span class="p">(</span><span class="o">*</span><span class="n">center_5</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">points1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]))</span>
    <span class="n">center_estimate</span> <span class="o">=</span> <span class="n">mids</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">center_2</span><span class="p">,</span> <span class="n">ier</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">leastsq</span><span class="p">(</span><span class="n">f_2</span><span class="p">,</span> <span class="n">center_estimate</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
    <span class="n">center_4</span> <span class="o">=</span> <span class="n">circle_fit</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">r4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">calc_R</span><span class="p">(</span><span class="o">*</span><span class="n">center_4</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">))</span>

    <span class="n">center_x</span> <span class="o">=</span> <span class="n">center_4</span>
    <span class="n">rx</span> <span class="o">=</span> <span class="n">r4</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">new_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">new_points</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">points1</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;go&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">center_x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;ro&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">center_5</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center_5</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;co&#39;</span><span class="p">)</span>

    <span class="n">mids</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mids</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mids</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">mids</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;yo&#39;</span><span class="p">)</span>

    <span class="c1">#ax.plot(mids[0][1], mids[0][2], &#39;go&#39;)</span>
    <span class="n">circle1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span><span class="n">center_x</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">circle2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span><span class="n">mids</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:],</span> <span class="n">rx</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">circle3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span><span class="n">center_5</span><span class="p">,</span> <span class="n">r5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle1</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle2</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle3</span><span class="p">)</span>

    <span class="n">mids_stem_basis</span> <span class="o">=</span> <span class="p">[[</span><span class="n">start_pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center_5</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center_5</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                       <span class="p">[</span><span class="n">end_pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center_5</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center_5</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
    <span class="n">mids_standard_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mids_stem_basis</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                           <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">,</span>
                                           <span class="n">basis1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    # works!</span>
<span class="sd">    mids_stem_basis = [[nmids[0][0], center_4[0], center_4[1]],</span>
<span class="sd">                       [nmids[1][0], center_4[0], center_4[1]]]</span>
<span class="sd">    mids_standard_basis = cuv.change_basis(np.array(mids_stem_basis).T,</span>
<span class="sd">                                           cuv.standard_basis,</span>
<span class="sd">                                           basis).T</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">mids_standard_basis</span></div>


<div class="viewcode-block" id="get_mids_fit_method"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_mids_fit_method">[docs]</a><span class="k">def</span> <span class="nf">get_mids_fit_method</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">define</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Estimate the endpoints of the cylinder axis by fitting it and using</span>
<span class="sd">    the rmsd of the best fit circle as the function to minimize.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">atom_poss</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">residue_numbers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">cg</span><span class="o">.</span><span class="n">get_resseqs</span><span class="p">(</span><span class="n">define</span><span class="p">)))</span>
    <span class="n">ideal_chain</span> <span class="o">=</span> <span class="n">chain</span>

    <span class="k">for</span> <span class="n">rn</span> <span class="ow">in</span> <span class="n">residue_numbers</span><span class="p">:</span>
        <span class="c1">#atom_poss += [chain[rn][&#39;C1*&#39;].get_vector().get_array()]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            for atom in chain[rn].get_list():</span>
<span class="sd">                atom_poss += [atom.get_vector().get_array()]</span>
<span class="sd">            &#39;&#39;&#39;</span>

            <span class="n">atom_poss</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ideal_chain</span><span class="p">[</span><span class="n">rn</span><span class="p">][</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()]</span>
            <span class="n">atom_poss</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ideal_chain</span><span class="p">[</span><span class="n">rn</span><span class="p">][</span><span class="s1">&#39;O3*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()]</span>
            <span class="n">atom_poss</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ideal_chain</span><span class="p">[</span><span class="n">rn</span><span class="p">][</span><span class="s1">&#39;C3*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()]</span>
            <span class="n">atom_poss</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ideal_chain</span><span class="p">[</span><span class="n">rn</span><span class="p">][</span><span class="s1">&#39;C4*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()]</span>
            <span class="n">atom_poss</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ideal_chain</span><span class="p">[</span><span class="n">rn</span><span class="p">][</span><span class="s1">&#39;C5*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()]</span>
            <span class="n">atom_poss</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ideal_chain</span><span class="p">[</span><span class="n">rn</span><span class="p">][</span><span class="s1">&#39;O5*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()]</span>
            <span class="n">atom_poss</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ideal_chain</span><span class="p">[</span><span class="n">rn</span><span class="p">][</span><span class="s1">&#39;C1*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atom_poss</span><span class="p">)</span>
    <span class="n">mids</span> <span class="o">=</span> <span class="n">estimate_mids_core</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">start1</span><span class="p">,</span> <span class="n">start2</span><span class="p">,</span> <span class="n">end1</span><span class="p">,</span> <span class="n">end2</span><span class="p">)</span>
    <span class="n">mids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_array</span><span class="p">(),</span> <span class="n">mids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_array</span><span class="p">()])</span>
    <span class="n">vec</span> <span class="o">=</span> <span class="n">mids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">v1</span><span class="p">,</span> <span class="n">ier</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">leastsq</span><span class="p">(</span><span class="n">f_3</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">mids</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]),</span> <span class="n">maxfev</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>

    <span class="n">start_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">chain</span><span class="p">[</span><span class="n">start1</span><span class="p">][</span><span class="s1">&#39;C1*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span> <span class="o">+</span>
                 <span class="n">chain</span><span class="p">[</span><span class="n">start2</span><span class="p">][</span><span class="s1">&#39;C1*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">())</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">end_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">chain</span><span class="p">[</span><span class="n">end1</span><span class="p">][</span><span class="s1">&#39;C1*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span> <span class="o">+</span>
               <span class="n">chain</span><span class="p">[</span><span class="n">end2</span><span class="p">][</span><span class="s1">&#39;C1*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">())</span> <span class="o">/</span> <span class="mf">2.</span>

    <span class="n">basis1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
    <span class="n">points1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">basis1</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">start_pos1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">start_pos</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">basis1</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">end_pos1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">end_pos</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">basis1</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="n">center</span> <span class="o">=</span> <span class="n">circle_fit</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])</span>
    <span class="n">mids_stem_basis</span> <span class="o">=</span> <span class="p">[[</span><span class="n">start_pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                       <span class="p">[</span><span class="n">end_pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
    <span class="n">mids_standard_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mids_stem_basis</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                           <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">,</span>
                                           <span class="n">basis1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">bpdb</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="n">mids_standard_basis</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">bpdb</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="n">mids_standard_basis</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span></div>

<span class="c1">#Seems to be unused at least since version 0.3</span>
<div class="viewcode-block" id="stem_vec_from_circle_fit"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.stem_vec_from_circle_fit">[docs]</a><span class="k">def</span> <span class="nf">stem_vec_from_circle_fit</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">stem_name</span><span class="o">=</span><span class="s1">&#39;s0&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Attempt to find the stem direcion vector given a set of atom positions.</span>

<span class="sd">    This will be done by solving for the stem_vector, then using that</span>
<span class="sd">    to project the atoms onto a plane orthogonal to that vector. On that plane,</span>
<span class="sd">    a circle will be fit to the positions of the atoms. The stem vector that</span>
<span class="sd">    gives a circle with the least residuals will be considered the ideal</span>
<span class="sd">    stem vector.</span>

<span class="sd">    :return: stem_vector</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">atom_poss</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#stem_name = &#39;s0&#39;</span>
    <span class="k">for</span> <span class="n">rn</span> <span class="ow">in</span> <span class="n">bg</span><span class="o">.</span><span class="n">stem_res_numbers</span><span class="p">(</span><span class="n">stem_name</span><span class="p">):</span>
        <span class="c1">#atom_poss += [chain[rn][&#39;C1*&#39;].get_vector().get_array()]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">atom_poss</span> <span class="o">+=</span> <span class="p">[</span><span class="n">chain</span><span class="p">[</span><span class="n">rn</span><span class="p">][</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()]</span>
            <span class="n">atom_poss</span> <span class="o">+=</span> <span class="p">[</span><span class="n">chain</span><span class="p">[</span><span class="n">rn</span><span class="p">][</span><span class="s1">&#39;O3*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()]</span>
            <span class="n">atom_poss</span> <span class="o">+=</span> <span class="p">[</span><span class="n">chain</span><span class="p">[</span><span class="n">rn</span><span class="p">][</span><span class="s1">&#39;C3*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()]</span>
            <span class="n">atom_poss</span> <span class="o">+=</span> <span class="p">[</span><span class="n">chain</span><span class="p">[</span><span class="n">rn</span><span class="p">][</span><span class="s1">&#39;C4*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()]</span>
            <span class="n">atom_poss</span> <span class="o">+=</span> <span class="p">[</span><span class="n">chain</span><span class="p">[</span><span class="n">rn</span><span class="p">][</span><span class="s1">&#39;C5*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()]</span>
            <span class="n">atom_poss</span> <span class="o">+=</span> <span class="p">[</span><span class="n">chain</span><span class="p">[</span><span class="n">rn</span><span class="p">][</span><span class="s1">&#39;O5*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()]</span>
            <span class="n">atom_poss</span> <span class="o">+=</span> <span class="p">[</span><span class="n">chain</span><span class="p">[</span><span class="n">rn</span><span class="p">][</span><span class="s1">&#39;C1*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">define</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">stem_name</span><span class="p">]</span>
    <span class="n">start_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">chain</span><span class="p">[</span><span class="n">define</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;C1*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span> <span class="o">+</span>
                 <span class="n">chain</span><span class="p">[</span><span class="n">define</span><span class="p">[</span><span class="mi">3</span><span class="p">]][</span><span class="s1">&#39;C1*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">())</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">end_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">chain</span><span class="p">[</span><span class="n">define</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;C1*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span> <span class="o">+</span>
               <span class="n">chain</span><span class="p">[</span><span class="n">define</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="s1">&#39;C1*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">())</span> <span class="o">/</span> <span class="mf">2.</span>

    <span class="n">mids</span> <span class="o">=</span> <span class="n">get_mids</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">bg</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">stem_name</span><span class="p">])</span>
    <span class="c1"># use the original calculation to provide an estimate for the</span>
    <span class="c1"># optimized stem position calculation</span>
    <span class="n">resnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">bg</span><span class="o">.</span><span class="n">seq_ids</span><span class="p">[</span><span class="n">d</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">bg</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">stem_name</span><span class="p">]]</span>
    <span class="n">stem_chain</span> <span class="o">=</span> <span class="n">extract_define_residues</span><span class="p">(</span><span class="n">resnames</span><span class="p">,</span> <span class="n">chain</span><span class="p">)</span>

    <span class="n">mids</span> <span class="o">=</span> <span class="p">(</span><span class="n">mids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_array</span><span class="p">(),</span> <span class="n">mids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_array</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">fit_circle_old</span><span class="p">(</span><span class="n">mids</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atom_poss</span><span class="p">),</span>
                          <span class="n">start_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">,</span> <span class="n">stem_chain</span><span class="p">,</span>
                          <span class="n">bg</span><span class="o">.</span><span class="n">stem_length</span><span class="p">(</span><span class="n">stem_name</span><span class="p">),</span> <span class="n">bg</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">stem_name</span><span class="p">])</span></div>

<span class="c1">#Seems to be unused at least since version 0.3</span>
<div class="viewcode-block" id="receptor_angle"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.receptor_angle">[docs]</a><span class="k">def</span> <span class="nf">receptor_angle</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">)</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">line_segment_distance</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                         <span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                         <span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                         <span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">stem_len</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">stem_length</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">stem_vec</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">m1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">i2</span> <span class="o">-</span> <span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">res_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">stem_len</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">m1</span> <span class="o">/</span> <span class="n">m2</span>
    <span class="n">vres</span> <span class="o">=</span> <span class="n">virtual_res_3d_pos</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">res_num</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">cuv</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">i2</span> <span class="o">-</span> <span class="n">i1</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.</span>

    <span class="n">incoming_angle</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">vector_rejection</span><span class="p">(</span><span class="n">i1</span> <span class="o">-</span> <span class="n">i2</span><span class="p">,</span> <span class="n">stem_vec</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span><span class="n">vres</span><span class="p">,</span> <span class="n">incoming_angle</span><span class="p">)</span></div>


<div class="viewcode-block" id="add_stem_information_from_pdb_chain"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.add_stem_information_from_pdb_chain">[docs]</a><span class="k">def</span> <span class="nf">add_stem_information_from_pdb_chain</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">seq_ids</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get the 3D information of the stems.</span>

<span class="sd">    Output the mid points of the helices as well as the &#39;twist&#39; vectors</span>
<span class="sd">    which describe the projection of the (ca - mids) vectors onto</span>
<span class="sd">    the plane perpendicular to the axis of the helix.</span>

<span class="sd">    Add all of this information to the BulgeGraph data structure.</span>

<span class="sd">    :param bg: The BulgeGraph.</span>
<span class="sd">    :param chain: The Bio.PDB chain representation of the 3D structure.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="n">ftup</span><span class="o">.</span><span class="n">rename_rosetta_atoms</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cg</span><span class="o">.</span><span class="n">defines</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span>
            <span class="n">mids</span> <span class="o">=</span> <span class="n">get_mids</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">seq_ids</span><span class="o">=</span><span class="n">seq_ids</span><span class="p">)</span>
            <span class="n">twists</span> <span class="o">=</span> <span class="n">get_twists</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">seq_ids</span><span class="o">=</span><span class="n">seq_ids</span><span class="p">)</span>

            <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_array</span><span class="p">(),</span> <span class="n">mids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_array</span><span class="p">())</span>
            <span class="n">cg</span><span class="o">.</span><span class="n">twists</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">twists</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">twists</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">cg</span><span class="o">.</span><span class="n">sampled</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cg</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">+</span> <span class="n">cg</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">d</span><span class="p">]</span></div>


<div class="viewcode-block" id="add_bulge_information_from_pdb_chain"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.add_bulge_information_from_pdb_chain">[docs]</a><span class="k">def</span> <span class="nf">add_bulge_information_from_pdb_chain</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">chain</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Add the information about the starts and ends of the bulges. The stems</span>
<span class="sd">    have to be created beforehand.</span>

<span class="sd">    Modifies the structure bg.</span>

<span class="sd">    :param bg: The CoarseGrainRNA.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;add_bulge_information_from_pdb_chain is deprecated.&quot;</span>
                  <span class="s2">&quot; Use cg.add_bulge_coords_from_stems instead!&quot;</span><span class="p">)</span>
    <span class="n">bg</span><span class="o">.</span><span class="n">add_bulge_coords_from_stems</span><span class="p">()</span></div>

<div class="viewcode-block" id="add_loop_information_from_pdb_chain"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.add_loop_information_from_pdb_chain">[docs]</a><span class="k">def</span> <span class="nf">add_loop_information_from_pdb_chain</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">seq_ids</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">hloop_iterator</span><span class="p">(),</span> <span class="p">[</span><span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="s1">&#39;f1&#39;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bg</span><span class="o">.</span><span class="n">defines</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">edges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Odd case where there are no stems in the structure</span>
            <span class="c1"># We should find the furthest distance from the first</span>
            <span class="c1"># nucleotide</span>
            <span class="n">first_res</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">chain</span><span class="o">.</span><span class="n">get_residues</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">catom_name</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                    <span class="n">first_res</span> <span class="o">=</span> <span class="n">res</span>
                    <span class="k">break</span>

            <span class="n">start_point</span> <span class="o">=</span> <span class="n">first_res</span><span class="p">[</span><span class="n">catom_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span> 
            <span class="n">centroid</span> <span class="o">=</span> <span class="n">get_furthest_c_alpha</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> 
                                            <span class="n">first_res</span><span class="p">[</span><span class="n">catom_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">(),</span> 
                                            <span class="n">d</span><span class="p">,</span> <span class="n">seq_ids</span><span class="o">=</span><span class="n">seq_ids</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">s1d</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">s1</span><span class="p">]</span>
            <span class="n">bd</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>

            <span class="p">(</span><span class="n">s1b</span><span class="p">,</span> <span class="n">s2b</span><span class="p">)</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">get_sides</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

            <span class="n">mids</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s1</span><span class="p">]</span>
            <span class="n">start_point</span> <span class="o">=</span> <span class="n">mids</span><span class="p">[</span><span class="n">s1b</span><span class="p">]</span>
            <span class="c1">#centroid = get_bulge_centroid(chain, bd)</span>

            <span class="n">centroid</span> <span class="o">=</span> <span class="n">get_furthest_c_alpha</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">mids</span><span class="p">[</span><span class="n">s1b</span><span class="p">],</span> <span class="n">d</span><span class="p">,</span> <span class="n">seq_ids</span><span class="o">=</span><span class="n">seq_ids</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">centroid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;No end found for loop </span><span class="si">%s</span><span class="s2">... using the end of stem </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>
                <span class="n">centroid</span> <span class="o">=</span> <span class="n">mids</span><span class="p">[</span><span class="n">s1b</span><span class="p">]</span>

        <span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_point</span><span class="p">,</span> <span class="n">centroid</span><span class="p">)</span></div>

<div class="viewcode-block" id="cylinder_works"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.cylinder_works">[docs]</a><span class="k">def</span> <span class="nf">cylinder_works</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">cylinders_to_stems</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span> <span class="mf">4.</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Check if all of these points are inside the cylinder.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">tv</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">tv</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
    
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">cylinders_to_stems</span><span class="p">[</span><span class="n">c</span><span class="p">]:</span>
        <span class="n">points</span> <span class="o">+=</span> <span class="p">[</span><span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
        
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="n">datamean</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">uu</span><span class="p">,</span> <span class="n">dd</span><span class="p">,</span> <span class="n">vv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">datamean</span><span class="p">)</span>
    
    <span class="n">n</span> <span class="o">=</span> <span class="n">vv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">data</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">datamean</span>
    
    <span class="n">dist_vec</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">((</span><span class="n">a</span><span class="o">-</span><span class="n">p</span><span class="p">),</span> <span class="n">n</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span> <span class="o">*</span> <span class="n">n</span>
    <span class="n">mags</span> <span class="o">=</span> <span class="p">[</span><span class="n">ftuv</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">dist_vec</span><span class="p">]</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    linepts = vv[0] * np.mgrid[-7:7:2j][:, np.newaxis]</span>
<span class="sd">    linepts += datamean</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    import matplotlib.pyplot as plt</span>
<span class="sd">    import mpl_toolkits.mplot3d as m3d</span>
<span class="sd">    </span>
<span class="sd">    ax = m3d.Axes3D(plt.figure())</span>
<span class="sd">    ax.scatter3D(*data.T)</span>
<span class="sd">    ax.plot3D(*linepts.T)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">mags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span></div>
                   
<div class="viewcode-block" id="get_encompassing_cylinders"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_encompassing_cylinders">[docs]</a><span class="k">def</span> <span class="nf">get_encompassing_cylinders</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">6.</span><span class="p">):</span>
    <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    
    <span class="c1"># the stems_in_cylinders dictionary will be indexed by stem name and contain</span>
    <span class="c1"># the number of the cylinder it contains</span>
    <span class="c1">#stems_to_cylinders = {&#39;s0&#39;: 0}</span>
    <span class="n">stems_to_cylinders</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">cylinders_to_stems</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    
    <span class="c1">#cylinders_to_stems = {0: [&#39;s0&#39;]}</span>
    
    <span class="c1"># the first cylinder is equal to the first stem</span>
    <span class="c1">#cylinders = {0: cg.coords[&#39;s0&#39;]}</span>
    <span class="n">to_visit</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">cg</span><span class="o">.</span><span class="n">defines</span><span class="o">.</span><span class="n">keys</span><span class="p">()))]</span>
    
    <span class="n">cylinder_counter</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">while</span> <span class="n">to_visit</span><span class="p">:</span>
        <span class="n">tv</span> <span class="o">=</span> <span class="n">to_visit</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
            <span class="k">continue</span>
            
        <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tv</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">cg</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">tv</span><span class="p">]:</span>
            <span class="n">to_visit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        
        <span class="c1"># not interested in non- stem, multiloop or interior loop elements</span>
        <span class="k">if</span> <span class="n">tv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;s&#39;</span> <span class="ow">and</span> <span class="n">tv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;m&#39;</span> <span class="ow">and</span> <span class="n">tv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
            
        <span class="c1">#cylinders_to_check = set(cylinders_to_stems.keys())</span>
        <span class="n">cylinders_to_check</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        
        <span class="c1"># find which cylinders we need to check</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">cg</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">tv</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">stems_to_cylinders</span><span class="p">:</span>
                <span class="n">cylinders_to_check</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">stems_to_cylinders</span><span class="p">[</span><span class="n">e</span><span class="p">])</span>  
            
        <span class="n">found</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cylinders_to_check</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="nb">sum</span><span class="p">([</span><span class="n">cg</span><span class="o">.</span><span class="n">stem_length</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cylinders_to_stems</span><span class="p">[</span><span class="n">x</span><span class="p">]])):</span>
            <span class="c1"># the new node will definitely be at the end of the cylinder</span>
            <span class="c1">#print &quot;checking...:&quot;, c, tv</span>
            <span class="k">if</span> <span class="n">cylinder_works</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">cylinders_to_stems</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
                <span class="n">cylinders_to_stems</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tv</span><span class="p">]</span>
                <span class="n">stems_to_cylinders</span><span class="p">[</span><span class="n">tv</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
                <span class="n">found</span> <span class="o">=</span> <span class="bp">True</span>
                
                <span class="k">break</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="c1"># no appropriately sized cylinder has been found so we</span>
            <span class="c1"># just create new one containing just this stem</span>
            <span class="n">cylinder_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">cylinders_to_stems</span><span class="p">[</span><span class="n">cylinder_counter</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tv</span><span class="p">]</span>
            <span class="n">stems_to_cylinders</span><span class="p">[</span><span class="n">tv</span><span class="p">]</span> <span class="o">=</span> <span class="n">cylinder_counter</span>
                
    <span class="k">return</span> <span class="n">cylinders_to_stems</span></div>

<div class="viewcode-block" id="element_coord_system"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.element_coord_system">[docs]</a><span class="k">def</span> <span class="nf">element_coord_system</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get a coordinate system for a particular coarse grain element.</span>

<span class="sd">    If an element has an axis vector, a, twist vectors t1 and t2,</span>
<span class="sd">    then the coordinate system will be a normalized version </span>
<span class="sd">    of the axis a, the second, v2,  will be equal to norm((t1 + t2) / 2.)</span>

<span class="sd">    And the third will be equal to a x v2.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">vec_axis</span> <span class="o">=</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">twists</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">get_twists</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>


    <span class="n">mid_twist</span> <span class="o">=</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">twists</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">twists</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1">#return (((cg.coords[d][0] + cg.coords[d][1]) / 2.),</span>
    <span class="k">return</span> <span class="p">(((</span><span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">),</span>
            <span class="n">ftuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">vec_axis</span><span class="p">,</span> <span class="n">mid_twist</span><span class="p">))</span></div>

<div class="viewcode-block" id="virtual_atoms"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.virtual_atoms">[docs]</a><span class="k">def</span> <span class="nf">virtual_atoms</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">given_atom_names</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sidechain</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get a list of virtual atoms for this structure.</span>

<span class="sd">    :param cg: The coarse grain structure.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">VirtualAtomsLookup</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">given_atom_names</span><span class="p">,</span> <span class="n">sidechain</span><span class="p">)</span></div>

<div class="viewcode-block" id="VirtualAtomsLookup"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.VirtualAtomsLookup">[docs]</a><span class="k">class</span> <span class="nc">VirtualAtomsLookup</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An object with a dict-like interface that calculated the virtual atom positions on demand.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cg</span><span class="p">,</span> <span class="n">given_atom_names</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sidechain</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param cg: The coarse grain structure, for which the virtual atoms are generated. </span>

<span class="sd">        ..note :: </span>
<span class="sd">            If cg is modified, new virtual atom positions are calculated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">=</span><span class="n">cg</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">given_atom_names</span><span class="o">=</span><span class="n">given_atom_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sidechain</span><span class="o">=</span><span class="n">sidechain</span>
    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :returns: A dictionary containing all atoms (as keys) and their </span>
<span class="sd">                  positions (as values) for the given residue.</span>
<span class="sd">        :param position: The position of the residue in the RNA (starting with 1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Find out the stem for which we have to calculate virtual atom positions</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">defines</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c1">#For multiloops of length 0, value is []</span>
            <span class="k">elif</span> <span class="n">position</span><span class="o">&gt;=</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">position</span><span class="o">&lt;=</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem_for_element</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">==</span><span class="mi">4</span> <span class="ow">and</span> <span class="n">position</span><span class="o">&gt;=</span><span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">position</span><span class="o">&lt;=</span><span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem_for_element</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">False</span><span class="p">,</span> <span class="s2">&quot;No return for pos {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
    <span class="nd">@profile</span>
<div class="viewcode-block" id="VirtualAtomsLookup.keys"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.VirtualAtomsLookup.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">k</span><span class="o">=</span><span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">defines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">k</span></div>

    <span class="k">def</span> <span class="nf">_getitem_for_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :returns: A dictionary containing all atoms (as keys) and their positions (as values) for the given residue.</span>
<span class="sd">        :param d: The coarse grained element (e.g. &quot;s1&quot;)</span>
<span class="sd">        :param pos: The position of the residue. It has to be in the element d!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;s&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem_for_stem</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span> <span class="c1">#Use virtual residues for stems.</span>
        <span class="kn">import</span> <span class="nn">forgi.threedee.utilities.average_atom_positions</span> <span class="kn">as</span> <span class="nn">ftua</span>
        <span class="n">e_coords</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span>
        <span class="n">origin</span><span class="p">,</span> <span class="n">basis</span> <span class="o">=</span> <span class="n">element_coord_system</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;i&#39;</span> <span class="ow">or</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;m&#39;</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">connections</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="n">conn_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">connection_type</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conn_type</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">izip</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">define_residue_num_iterator</span><span class="p">(</span><span class="n">d</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">!=</span><span class="n">pos</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">given_atom_names</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sidechain</span><span class="p">:</span>
                    <span class="n">atom_names</span> <span class="o">=</span> <span class="p">(</span><span class="n">ftup</span><span class="o">.</span><span class="n">nonsidechain_atoms</span> <span class="o">+</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="n">r</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ftup</span><span class="o">.</span><span class="n">side_chain_atoms</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="n">r</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">atom_names</span> <span class="o">=</span> <span class="n">ftup</span><span class="o">.</span><span class="n">nonsidechain_atoms</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">atom_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">given_atom_names</span>
            <span class="k">for</span> <span class="n">aname</span> <span class="ow">in</span> <span class="n">atom_names</span><span class="p">:</span>
                <span class="n">identifier</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                              <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">get_node_dimensions</span><span class="p">(</span><span class="n">d</span><span class="p">))),</span>
                                              <span class="n">conn_type</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">aname</span><span class="p">)</span>

                <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">aname</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">aname</span><span class="o">=</span><span class="n">aname</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">e_coords</span><span class="p">[</span><span class="n">aname</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span> <span class="o">+</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ftua</span><span class="o">.</span><span class="n">avg_atom_poss</span><span class="p">[</span><span class="n">identifier</span><span class="p">]),</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">,</span> <span class="n">basis</span> <span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ke</span><span class="p">:</span>
                    <span class="c1">#warnings.warn(&quot;KeyError in virtual_atoms. No coordinates found for: {}&quot;.format(ke))</span>
                    <span class="k">pass</span>
            <span class="k">return</span> <span class="n">e_coords</span>
    <span class="k">def</span> <span class="nf">_getitem_for_stem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">side</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">stem_resn_to_stem_vres_side</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">pos</span><span class="o">&gt;=</span><span class="mi">1</span>    <span class="c1">#pos-1 should not be negative!  </span>
        <span class="n">residue</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="n">pos</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#The sequence coordinates are 1-based!</span>

        <span class="n">atoms</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">given_atom_names</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sidechain</span><span class="p">:</span>
                <span class="n">atom_names</span> <span class="o">=</span> <span class="p">(</span><span class="n">ftup</span><span class="o">.</span><span class="n">nonsidechain_atoms</span> <span class="o">+</span>  <span class="n">ftup</span><span class="o">.</span><span class="n">side_chain_atoms</span><span class="p">[</span><span class="n">residue</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">atom_names</span> <span class="o">=</span> <span class="n">ftup</span><span class="o">.</span><span class="n">nonsidechain_atoms</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atom_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">given_atom_names</span>
        <span class="k">for</span> <span class="n">aname</span> <span class="ow">in</span> <span class="n">atom_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">in</span> <span class="n">aname</span><span class="p">:</span>
                <span class="n">aname_star</span><span class="o">=</span><span class="n">aname</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;*&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aname_star</span><span class="o">=</span><span class="n">aname</span>
            <span class="n">spos</span> <span class="o">=</span> <span class="n">ftus</span><span class="o">.</span><span class="n">avg_stem_vres_atom_coords</span><span class="p">[</span><span class="n">side</span><span class="p">][</span><span class="n">residue</span><span class="p">][</span><span class="n">aname_star</span><span class="p">]</span>
            <span class="n">atoms</span><span class="p">[</span><span class="n">aname</span><span class="p">]</span> <span class="o">=</span> <span class="n">spos_to_pos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">spos</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">atoms</span></div>
<span class="sd">&quot;&quot;&quot;def add_atoms(coords, twists, define, side, seq, new_coords):</span>
<span class="sd">    stem_len = define[1] - define[0] + 1</span>

<span class="sd">    for i in range(stem_len):</span>
<span class="sd">        if side == 0:</span>
<span class="sd">            resnum = define[0] + i</span>
<span class="sd">        else:</span>
<span class="sd">            resnum = define[1] - i</span>
<span class="sd">        resname = seq[resnum-1]</span>
<span class="sd">        </span>
<span class="sd">        vbasis = virtual_res_basis_core(coords, twists, i, stem_len)</span>
<span class="sd">        vpos = virtual_res_3d_pos_core(coords, twists, i, stem_len)</span>

<span class="sd">        for a in ftus.avg_stem_vres_atom_coords[side][resname].items():</span>
<span class="sd">            c = a[1]</span>
<span class="sd">            new_coords[resnum][a[0]] = np.dot(vbasis.transpose(), c) + vpos[0]</span>
<span class="sd">    </span>
<span class="sd">    return new_coords</span>

<span class="sd">def cg_atoms(cg):</span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="sd">    Place atoms as if every segment was a helix.</span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="sd">    new_coords = col.defaultdict(dict)</span>

<span class="sd">    for d in cg.defines:</span>
<span class="sd">        coords = cg.coords[d]</span>
<span class="sd">        twists = cg.get_twists(d)</span>

<span class="sd">        if d[0] == &#39;s&#39; or d[0] == &#39;i&#39;:</span>
<span class="sd">            for c in chunks(cg.defines[d], 2):</span>
<span class="sd">                for side in range(2):</span>
<span class="sd">                    new_coords = add_atoms(coords, twists, c, side, cg.seq, new_coords)</span>
<span class="sd">        elif d[0] == &#39;m&#39;:</span>
<span class="sd">            side = cg.get_strand(d)</span>

<span class="sd">            if len(cg.defines[d]) &gt; 0:</span>
<span class="sd">                new_coords = add_atoms(coords, twists, cg.defines[d], side, cg.seq, new_coords)</span>

<span class="sd">        elif d[0] == &#39;f&#39;:</span>
<span class="sd">            new_coords = add_atoms(coords, twists, cg.defines[d], 0, cg.seq, new_coords)</span>
<span class="sd">        </span>
<span class="sd">        elif d[0] == &#39;t&#39;:</span>
<span class="sd">            new_coords = add_atoms(coords, twists, cg.defines[d], 1, cg.seq, new_coords)</span>

<span class="sd">    return new_coords&quot;&quot;&quot;</span>

<div class="viewcode-block" id="element_distance"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.element_distance">[docs]</a><span class="k">def</span> <span class="nf">element_distance</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate the distance between the two closest points of these</span>
<span class="sd">    two elements.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">line_segment_distance</span><span class="p">(</span><span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">l1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">l1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                       <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">l2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">l2</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">vec_distance</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_basepair_center"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_basepair_center">[docs]</a><span class="k">def</span> <span class="nf">get_basepair_center</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The center of a basepair, as defined in doi: 10.1261/rna.305307 </span>

<span class="sd">    :param pos: The number of one of the two pairing bases</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pos2</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">pairing_partner</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="n">seq1</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="n">pos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">seq2</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="n">pos2</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C8&quot;</span><span class="p">],</span> <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C8&quot;</span><span class="p">],</span> <span class="s2">&quot;U&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C6&quot;</span><span class="p">],</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C6&quot;</span><span class="p">]}</span>
    <span class="n">va1</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">virtual_atoms</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="n">va2</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">virtual_atoms</span><span class="p">(</span><span class="n">pos2</span><span class="p">)</span>
    <span class="n">avpos</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">[</span><span class="n">seq1</span><span class="p">]:</span>
        <span class="n">avpos</span><span class="o">+=</span><span class="n">va1</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">[</span><span class="n">seq2</span><span class="p">]:</span>
        <span class="n">avpos</span><span class="o">+=</span><span class="n">va2</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>
    <span class="n">avpos</span><span class="o">/=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">seq1</span><span class="p">])</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">seq2</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">avpos</span></div>

<div class="viewcode-block" id="get_basepair_plane"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_basepair_plane">[docs]</a><span class="k">def</span> <span class="nf">get_basepair_plane</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The plane of the basepair, as defined in figure 13 of doi: 10.1261/rna.305307 </span>
<span class="sd">  </span>
<span class="sd">    :param pos: The number of one of the two pairing bases</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pos2</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">pairing_partner</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="n">seq1</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="n">pos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">seq2</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="n">pos2</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">va1</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">virtual_atoms</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="n">va2</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">virtual_atoms</span><span class="p">(</span><span class="n">pos2</span><span class="p">)</span>
    <span class="n">h_bonds</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;U&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;O4&quot;</span><span class="p">,</span> <span class="s2">&quot;N6&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N3&quot;</span><span class="p">,</span> <span class="s2">&quot;N1&quot;</span><span class="p">)],</span>
                     <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;N3&quot;</span><span class="p">,</span> <span class="s2">&quot;O6&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;O2&quot;</span><span class="p">,</span> <span class="s2">&quot;N1&quot;</span><span class="p">)]},</span>
               <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;U&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;N6&quot;</span><span class="p">,</span> <span class="s2">&quot;O4&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N1&quot;</span><span class="p">,</span> <span class="s2">&quot;N3&quot;</span><span class="p">)]},</span>
               <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;U&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;O6&quot;</span><span class="p">,</span> <span class="s2">&quot;N3&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N1&quot;</span><span class="p">,</span> <span class="s2">&quot;O2&quot;</span><span class="p">)],</span>
                     <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;O6&quot;</span><span class="p">,</span> <span class="s2">&quot;N4&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N1&quot;</span><span class="p">,</span> <span class="s2">&quot;N3&quot;</span><span class="p">),(</span><span class="s2">&quot;N2&quot;</span><span class="p">,</span> <span class="s2">&quot;O2&quot;</span><span class="p">)]},</span>
               <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;N4&quot;</span><span class="p">,</span> <span class="s2">&quot;O6&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N3&quot;</span><span class="p">,</span> <span class="s2">&quot;N1&quot;</span><span class="p">),(</span><span class="s2">&quot;O2&quot;</span><span class="p">,</span> <span class="s2">&quot;N2&quot;</span><span class="p">)]}</span>
              <span class="p">}</span>
    <span class="c1">#print( seq1, seq2 )</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">hb</span> <span class="o">=</span> <span class="n">h_bonds</span><span class="p">[</span><span class="n">seq1</span><span class="p">][</span><span class="n">seq2</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="c1"># Non-canonical basepair</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Estimating plane from stem vector for &quot;</span>
                      <span class="s2">&quot; non-canonical basepair {}-{} at positions&quot;</span>
                      <span class="s2">&quot; {},{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seq1</span><span class="p">,</span> <span class="n">seq2</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">pos2</span><span class="p">))</span>
        <span class="n">stem</span><span class="p">,</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">nucleotides_to_elements</span><span class="p">([</span><span class="n">pos</span><span class="p">,</span> <span class="n">pos2</span><span class="p">])</span> <span class="c1">#ValueError, if cg.pairing_partner is buggy</span>
        <span class="k">return</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plane</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">contribs</span><span class="o">=</span><span class="mi">0</span>

        <span class="k">for</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">hb</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">left_1</span><span class="o">=</span><span class="n">va1</span><span class="p">[</span><span class="n">l1</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">left_2</span><span class="o">=</span><span class="n">va1</span><span class="p">[</span><span class="n">l2</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">right_1</span><span class="o">=</span><span class="n">va2</span><span class="p">[</span><span class="n">l1</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">right_2</span><span class="o">=</span><span class="n">va2</span><span class="p">[</span><span class="n">l2</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">add</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">right_1</span><span class="o">-</span><span class="n">left_1</span><span class="p">,</span> <span class="n">right_2</span><span class="o">-</span><span class="n">left_1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">plane</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)):</span> 
                <span class="k">assert</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">plane</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;{}-{}: {}, {}: {}&quot;</span>
                 <span class="s2">&quot; degrees&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seq1</span><span class="p">,</span> <span class="n">seq2</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">ftuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">plane</span><span class="p">))))</span>
            <span class="n">plane</span><span class="o">+=</span><span class="n">add</span>
            <span class="n">add</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">right_1</span><span class="o">-</span><span class="n">left_1</span><span class="p">,</span> <span class="n">left_2</span><span class="o">-</span><span class="n">right_1</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">plane</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;{}-{}: {}, {}: {}&quot;</span>
               <span class="s2">&quot; degrees&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seq1</span><span class="p">,</span> <span class="n">seq2</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">ftuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">plane</span><span class="p">))))</span>
            <span class="n">plane</span><span class="o">+=</span><span class="n">add</span>
            <span class="n">add</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">right_2</span><span class="o">-</span><span class="n">left_2</span><span class="p">,</span> <span class="n">right_2</span><span class="o">-</span><span class="n">left_1</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">plane</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;{}-{}: {}, {}: {}&quot;</span>
               <span class="s2">&quot; degrees&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seq1</span><span class="p">,</span> <span class="n">seq2</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">ftuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">plane</span><span class="p">))))</span>
            <span class="n">plane</span><span class="o">+=</span><span class="n">add</span>
            <span class="n">add</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">right_2</span><span class="o">-</span><span class="n">left_2</span><span class="p">,</span> <span class="n">left_2</span><span class="o">-</span><span class="n">right_1</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">plane</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;{}-{}: {}, {}: {}&quot;</span>
               <span class="s2">&quot; degrees&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seq1</span><span class="p">,</span> <span class="n">seq2</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">ftuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">plane</span><span class="p">))))</span>
            <span class="n">plane</span><span class="o">+=</span><span class="n">add</span>
        <span class="k">return</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>  </div>
















</pre></div>

      </div>
      <div class="bottomnav">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2012-2016 Peter Kerpedjiev &lt;pkerp@tbi.univie.ac.at&gt;; 2015,2016 Bernhard Thiel &lt;thiel@tbi.univie.ac.at&gt;.
      Last updated on Sep 05, 2016.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.
    </div>
  </body>
</html>