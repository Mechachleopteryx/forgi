

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>forgi.threedee.utilities.graph_pdb &#8212; forgi 2.0.0 documentation</title>
    <link rel="stylesheet" href="../../../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/print.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '2.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../../_static/theme_extras.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../../../../index.html">
          <span>forgi 2.0.0 documentation</span></a></h1>
      </div>
      <div class="topnav">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for forgi.threedee.utilities.graph_pdb</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">map</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">range</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">object</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">zip</span><span class="p">,</span> <span class="nb">str</span>

<span class="kn">import</span> <span class="nn">itertools</span> <span class="k">as</span> <span class="nn">it</span>
<span class="kn">import</span> <span class="nn">collections</span> <span class="k">as</span> <span class="nn">col</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">op</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="k">import</span> <span class="n">pprint</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">uuid</span>


<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.linalg</span> <span class="k">as</span> <span class="nn">nl</span>
<span class="kn">import</span> <span class="nn">numpy.testing</span> <span class="k">as</span> <span class="nn">nptest</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">so</span>
<span class="kn">import</span> <span class="nn">Bio.PDB</span> <span class="k">as</span> <span class="nn">bp</span>
<span class="kn">import</span> <span class="nn">Bio.PDB</span> <span class="k">as</span> <span class="nn">bpdb</span>
<span class="kn">import</span> <span class="nn">Bio.PDB.PDBExceptions</span>

<span class="kn">from</span> <span class="nn">logging_exceptions</span> <span class="k">import</span> <span class="n">log_to_exception</span>

<span class="kn">import</span> <span class="nn">forgi.threedee.utilities.average_stem_vres_atom_positions</span> <span class="k">as</span> <span class="nn">ftus</span>
<span class="kn">import</span> <span class="nn">forgi.utilities.debug</span> <span class="k">as</span> <span class="nn">fud</span>
<span class="kn">import</span> <span class="nn">forgi.threedee.utilities.my_math</span> <span class="k">as</span> <span class="nn">ftum</span>
<span class="kn">import</span> <span class="nn">forgi.threedee.utilities.pdb</span> <span class="k">as</span> <span class="nn">ftup</span>
<span class="kn">import</span> <span class="nn">forgi.threedee.utilities.vector</span> <span class="k">as</span> <span class="nn">cuv</span>
<span class="kn">import</span> <span class="nn">forgi.threedee.utilities.vector</span> <span class="k">as</span> <span class="nn">ftuv</span>
<span class="kn">import</span> <span class="nn">forgi</span>
<span class="kn">from</span> <span class="nn">forgi.threedee.utilities.modified_res</span> <span class="k">import</span> <span class="n">change_residue_id</span>
<span class="kn">from</span> <span class="nn">forgi.utilities.exceptions</span> <span class="k">import</span> <span class="n">CgConstructionError</span>
<span class="kn">from</span> <span class="nn">forgi.threedee.utilities.pdb</span> <span class="k">import</span> <span class="n">AtomName</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">REFERENCE_CATOM</span> <span class="o">=</span> <span class="n">AtomName</span><span class="p">(</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">)</span>


<span class="k">try</span><span class="p">:</span>
    <span class="n">profile</span>  <span class="c1"># The @profile decorator from line_profiler (kernprof)</span>
<span class="k">except</span><span class="p">:</span>
<div class="viewcode-block" id="profile"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.profile">[docs]</a>    <span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="stem_stem_orientation"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.stem_stem_orientation">[docs]</a><span class="k">def</span> <span class="nf">stem_stem_orientation</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate the orientation of stem s2 in relation to stem s1</span>
<span class="sd">    as described by 3 parameters:</span>

<span class="sd">    1. The distance between the closest points of the two stems.</span>
<span class="sd">    2. The angle between s1 and s2 in the plane formed by the axis of</span>
<span class="sd">       the first stem and the vector between the two points closest</span>
<span class="sd">       to each on both stems.</span>
<span class="sd">    3. The angle of s2 out of the plane formed by their axes.</span>

<span class="sd">    :param bg: The BulgeGraph containing the stems.</span>
<span class="sd">    :param s1: The name of the first stem</span>
<span class="sd">    :param s2: The name of the second stem</span>
<span class="sd">    :return: (x,y,z) where x,y and z are the parameters described in</span>
<span class="sd">        the description above.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># shorten the names a little bit</span>
    <span class="n">s1_p0</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">s1_p1</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">s2_p0</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">s2_p1</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># The vectors of the axes of the cylinders</span>
    <span class="n">s1_vec</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">s2_vec</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># the minimum distance between the two stems, which are represented</span>
    <span class="c1"># as line segments</span>
    <span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">)</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">line_segment_distance</span><span class="p">(</span><span class="n">s1_p0</span><span class="p">,</span> <span class="n">s1_p1</span><span class="p">,</span> <span class="n">s2_p0</span><span class="p">,</span> <span class="n">s2_p1</span><span class="p">)</span>
    <span class="n">i_vec</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">-</span> <span class="n">i1</span>

    <span class="n">i_rej</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">vector_rejection</span><span class="p">(</span><span class="n">i_vec</span><span class="p">,</span> <span class="n">s1_vec</span><span class="p">)</span>
    <span class="n">plane_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">i_rej</span><span class="p">,</span> <span class="n">s1_vec</span><span class="p">)</span>
    <span class="c1"># s2_proj is in the intersection plane</span>
    <span class="n">s2_proj_in</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">vector_rejection</span><span class="p">(</span><span class="n">s2_vec</span><span class="p">,</span> <span class="n">plane_vec</span><span class="p">)</span>
    <span class="c1"># s2 proj_out is out of the intersection plane</span>
    <span class="n">s2_proj_out</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">vector_rejection</span><span class="p">(</span><span class="n">s2_vec</span><span class="p">,</span> <span class="n">i_rej</span><span class="p">)</span>
    <span class="c1"># the normal of the plane defined by the two stem vectors</span>

    <span class="c1">#ang1 = cuv.vec_angle(s1_vec, s2_proj_out)</span>
    <span class="c1">#ang2 = cuv.vec_angle(s1_vec, s2_proj_in)</span>
    <span class="n">ang1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span><span class="n">s2_proj_in</span><span class="p">,</span> <span class="n">s1_vec</span><span class="p">)</span>
    <span class="n">ang2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span><span class="n">s2_proj_out</span><span class="p">,</span> <span class="n">s1_vec</span><span class="p">)</span>

    <span class="c1">#ang3 = cuv.vec_angle(s1_vec, s2_proj_in)</span>
    <span class="c1">#ang4 = cuv.vec_angle(s1_vec, s2_proj_out)</span>

    <span class="c1"># ever so slightly increased to prevent domain errors</span>
    <span class="c1"># in the lateral_offset calculation below</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">i_vec</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.0001</span>

    <span class="n">ortho_offset</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">i_rej</span><span class="p">)</span>
    <span class="n">lateral_offset</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dist</span> <span class="o">*</span> <span class="n">dist</span> <span class="o">-</span> <span class="n">ortho_offset</span> <span class="o">*</span> <span class="n">ortho_offset</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">cuv</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">i_vec</span><span class="p">),</span> <span class="n">ang1</span><span class="p">,</span>
            <span class="n">ang2</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span><span class="n">s1_vec</span><span class="p">,</span> <span class="n">s2_vec</span><span class="p">),</span> <span class="n">lateral_offset</span><span class="p">,</span> <span class="n">ortho_offset</span><span class="p">)</span></div>


<div class="viewcode-block" id="base_normals"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.base_normals">[docs]</a><span class="k">def</span> <span class="nf">base_normals</span><span class="p">(</span><span class="n">pdb_filename</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Return a list of the normals for each base in the structure.</span>

<span class="sd">    As defined by the average of the cross products between the C2-C5</span>
<span class="sd">    and C2-C6 vectors and the N3-C6 and N3-C5 vectors. The origin of</span>
<span class="sd">    the vector will be the centroid of these four atoms.</span>

<span class="sd">    :param pdb_filename: The name of the pdb file containing the structure</span>
<span class="sd">    :return: A list of pairs containing the origin the normal as well as the</span>
<span class="sd">        normal itself.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">struct</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">PDBParser</span><span class="p">()</span><span class="o">.</span><span class="n">get_structure</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">pdb_filename</span><span class="p">)</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">get_chains</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">origin_norms</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">:</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;C2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span>
        <span class="n">c5</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;C5&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span>
        <span class="n">c6</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;C6&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span>
        <span class="n">n3</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;N3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span>

        <span class="n">v1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">c6</span> <span class="o">-</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c5</span> <span class="o">-</span> <span class="n">c2</span><span class="p">))</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">c6</span> <span class="o">-</span> <span class="n">n3</span><span class="p">,</span> <span class="n">c5</span> <span class="o">-</span> <span class="n">n3</span><span class="p">))</span>

        <span class="c1"># take the average of the two, for accuracy or something</span>
        <span class="n">v_norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">v1</span> <span class="o">+</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>

        <span class="n">origin</span> <span class="o">=</span> <span class="p">(</span><span class="n">c2</span> <span class="o">+</span> <span class="n">c5</span> <span class="o">+</span> <span class="n">c6</span> <span class="o">+</span> <span class="n">n3</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4.</span>
        <span class="n">origin_norms</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">origin</span><span class="p">,</span> <span class="n">v_norm</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">origin_norms</span></div>


<div class="viewcode-block" id="get_twist_angle"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_twist_angle">[docs]</a><span class="k">def</span> <span class="nf">get_twist_angle</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">twists</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get the angle of the twists with respect to each other.</span>

<span class="sd">    :param coords: The coordinates of the ends of the stem.</span>
<span class="sd">    :param twists: The two twist vectors.</span>
<span class="sd">    :return angle: The angle between the two twist vectors.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">stem_vec</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">stem_vec</span><span class="p">,</span> <span class="n">twists</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">twist2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">twists</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">basis</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span>
    <span class="c1">#assert_allclose(twist2[0], 0., rtol=1e-7, atol=1e-7)</span>

    <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">twist2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">twist2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">angle</span></div>


<div class="viewcode-block" id="twist2_from_twist1"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.twist2_from_twist1">[docs]</a><span class="k">def</span> <span class="nf">twist2_from_twist1</span><span class="p">(</span><span class="n">stem_vec</span><span class="p">,</span> <span class="n">twist1</span><span class="p">,</span> <span class="n">angle</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get an orientation for the second twist which will place it an</span>
<span class="sd">    angle of angle from the first twist.</span>

<span class="sd">    :param stem_vec: The vector of the stem.</span>
<span class="sd">    :param twist1: The vector of the first twist.</span>
<span class="sd">    :param angle: The angular difference between the two twists.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">stem_vec</span><span class="p">,</span> <span class="n">twist1</span><span class="p">)</span>

    <span class="n">twist2_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)])</span>
    <span class="n">twist2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">twist2_new</span><span class="p">)</span>
    <span class="c1">#twist2 = cuv.change_basis(twist2_new, cuv.standard_basis, basis)</span>

    <span class="k">return</span> <span class="n">twist2</span></div>


<div class="viewcode-block" id="get_twist_parameter"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_twist_parameter">[docs]</a><span class="k">def</span> <span class="nf">get_twist_parameter</span><span class="p">(</span><span class="n">twist1</span><span class="p">,</span> <span class="n">twist2</span><span class="p">,</span> <span class="n">u_v</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate how much stem1 must be twisted for its twist vector</span>
<span class="sd">    to coincide with that of stem2.</span>

<span class="sd">    :param twist1: The twist notator of stem1</span>
<span class="sd">    :param twist2: The twist notator of stem2</span>
<span class="sd">    :param u_v: The parameters u and v for rotating stem2 onto stem1</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">u_v</span>
    <span class="n">rot_mat1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">rot_mat2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">u</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>

    <span class="n">twist2_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot_mat1</span><span class="p">,</span> <span class="n">twist2</span><span class="p">)</span>
    <span class="n">twist2_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot_mat2</span><span class="p">,</span> <span class="n">twist2_new</span><span class="p">)</span>

    <span class="c1"># print &quot;get_twist_parameter twist2:&quot;, twist2_new</span>

    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">twist2_new</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">twist2_new</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="get_stem_orientation_parameters"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_stem_orientation_parameters">[docs]</a><span class="k">def</span> <span class="nf">get_stem_orientation_parameters</span><span class="p">(</span><span class="n">stem1_vec</span><span class="p">,</span> <span class="n">twist1</span><span class="p">,</span> <span class="n">stem2_vec</span><span class="p">,</span> <span class="n">twist2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Return a parameterization of the orientation of stem2 with respect to</span>
<span class="sd">    stem1.</span>

<span class="sd">    stem1 -&gt; bulge -&gt; stem2</span>

<span class="sd">    :param stem1_vec: The vector representing the axis of stem1</span>
<span class="sd">    :param twist1: The twist of stem1 closest to the bulge</span>
<span class="sd">    :param stem2_vec: The vector representing the axis of stem2</span>

<span class="sd">    :returns: (r,u,v,t) where r,u,v = the stem orientation in polar coordinates</span>
<span class="sd">                        and t is the twist parameter.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># Since we will denote the orientation of stem2 with respect to stem1</span>
    <span class="c1"># We first need to define a new coordinate system based on stem1</span>

    <span class="n">stem1_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">stem1_vec</span><span class="p">,</span> <span class="n">twist1</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Stem1 basis </span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">stem1_basis</span><span class="p">)</span>
    <span class="c1"># Transform the vector of stem2 to the new coordinate system</span>
    <span class="n">stem2_new_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">stem2_vec</span><span class="p">,</span> <span class="n">stem1_basis</span><span class="p">,</span>
                                       <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Stem2 in basis of stem 1 </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">stem2_new_basis</span><span class="p">)</span>

    <span class="n">twist2_new_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">twist2</span><span class="p">,</span> <span class="n">stem1_basis</span><span class="p">,</span>
                                        <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span>

    <span class="c1"># Convert the cartesian coordinates to polar coordinates</span>
    <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">spherical_cartesian_to_polar</span><span class="p">(</span><span class="n">stem2_new_basis</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">get_twist_parameter</span><span class="p">(</span><span class="n">twist1</span><span class="p">,</span> <span class="n">twist2_new_basis</span><span class="p">,</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;r </span><span class="si">%s</span><span class="s2">, u </span><span class="si">%s</span><span class="s2">, v </span><span class="si">%s</span><span class="s2">, t </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_stem_separation_parameters"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_stem_separation_parameters">[docs]</a><span class="k">def</span> <span class="nf">get_stem_separation_parameters</span><span class="p">(</span><span class="n">stem</span><span class="p">,</span> <span class="n">twist</span><span class="p">,</span> <span class="n">bulge</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Parameterize the location of the bulge with respect to the stem.</span>

<span class="sd">    :param stem: The stem vector.</span>
<span class="sd">    :param bulge: the bulge vector.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">stem_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">stem</span><span class="p">,</span> <span class="n">twist</span><span class="p">)</span>
    <span class="n">bulge_new_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">bulge</span><span class="p">,</span> <span class="n">stem_basis</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cuv</span><span class="o">.</span><span class="n">spherical_cartesian_to_polar</span><span class="p">(</span><span class="n">bulge_new_basis</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_stem_twist_and_bulge_vecs"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_stem_twist_and_bulge_vecs">[docs]</a><span class="k">def</span> <span class="nf">get_stem_twist_and_bulge_vecs</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">bulge</span><span class="p">,</span> <span class="n">connections</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Return the vectors of the stems and of the twists between which</span>
<span class="sd">    we want to calculate angles.</span>

<span class="sd">    The two vectors will be defined as follows:</span>

<span class="sd">    s1e -&gt; s1b -&gt; b -&gt; s2b -&gt; s2e</span>

<span class="sd">    The twists will be the two closest to the bulge.</span>

<span class="sd">    :param bulge: The name of the bulge separating the two helices.</span>
<span class="sd">    :param connections: The two stems that are connected to this bulge.</span>
<span class="sd">    :return: (stem1, twist1, stem2, twist2, bulge)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1">#s1d = bg.defines[s1]</span>
    <span class="c1">#s2d = bg.defines[s2]</span>

    <span class="n">mids1</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s1</span><span class="p">]</span>
    <span class="n">twists1</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">twists</span><span class="p">[</span><span class="n">s1</span><span class="p">]</span>

    <span class="n">mids2</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s2</span><span class="p">]</span>
    <span class="n">twists2</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">twists</span><span class="p">[</span><span class="n">s2</span><span class="p">]</span>

    <span class="c1"># find out which sides of the stems are closest to the bulge</span>
    <span class="c1"># the results will be indexes into the mids array</span>
    <span class="p">(</span><span class="n">s1b</span><span class="p">,</span> <span class="n">s1e</span><span class="p">)</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">get_sides</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">bulge</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Side of 1st stem </span><span class="si">%s</span><span class="s2"> attached to </span><span class="si">%s</span><span class="s2"> is </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">bulge</span><span class="p">,</span> <span class="n">s1b</span><span class="p">)</span>
    <span class="p">(</span><span class="n">s2b</span><span class="p">,</span> <span class="n">s2e</span><span class="p">)</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">get_sides</span><span class="p">(</span><span class="n">s2</span><span class="p">,</span> <span class="n">bulge</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Side of 2nd stem </span><span class="si">%s</span><span class="s2"> attached to </span><span class="si">%s</span><span class="s2"> is </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">bulge</span><span class="p">,</span> <span class="n">s2b</span><span class="p">)</span>

    <span class="c1"># Create directional vectors for the stems</span>
    <span class="c1">#  For ML:           For IL: -&gt; -&gt; -&gt;</span>
    <span class="c1">#    |    A</span>
    <span class="c1">#    V    |</span>
    <span class="c1">#    * -&gt; *</span>
    <span class="n">stem1_vec</span> <span class="o">=</span> <span class="n">mids1</span><span class="p">[</span><span class="n">s1b</span><span class="p">]</span> <span class="o">-</span> <span class="n">mids1</span><span class="p">[</span><span class="n">s1e</span><span class="p">]</span>
    <span class="n">bulge_vec</span> <span class="o">=</span> <span class="n">mids2</span><span class="p">[</span><span class="n">s2b</span><span class="p">]</span> <span class="o">-</span> <span class="n">mids1</span><span class="p">[</span><span class="n">s1b</span><span class="p">]</span>
    <span class="n">stem2_vec</span> <span class="o">=</span> <span class="n">mids2</span><span class="p">[</span><span class="n">s2e</span><span class="p">]</span> <span class="o">-</span> <span class="n">mids2</span><span class="p">[</span><span class="n">s2b</span><span class="p">]</span>

    <span class="c1">#twists1_vec = [twists1[s1b], twists1[s1e]]</span>
    <span class="c1">#twists2_vec = [twists2[s2e], twists2[s2b]]</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">stem1_vec</span><span class="p">,</span> <span class="n">twists1</span><span class="p">[</span><span class="n">s1b</span><span class="p">],</span> <span class="n">stem2_vec</span><span class="p">,</span> <span class="n">twists2</span><span class="p">[</span><span class="n">s2b</span><span class="p">],</span> <span class="n">bulge_vec</span><span class="p">)</span></div>


<div class="viewcode-block" id="stem2_pos_from_stem1"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.stem2_pos_from_stem1">[docs]</a><span class="k">def</span> <span class="nf">stem2_pos_from_stem1</span><span class="p">(</span><span class="n">stem1</span><span class="p">,</span> <span class="n">twist1</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get the starting point of a second stem, given the parameters</span>
<span class="sd">    about where it&#39;s located with respect to stem1</span>

<span class="sd">    :param stem1: The vector representing the axis of stem1&#39;s cylinder</span>
<span class="sd">    :param twist1: The twist parameter of stem1</span>
<span class="sd">    :param params: The parameters describing the position of stem2 wrt stem1</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="n">params</span>
    <span class="n">stem2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">spherical_polar_to_cartesian</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

    <span class="n">stem1_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">stem1</span><span class="p">,</span> <span class="n">twist1</span><span class="p">)</span>
    <span class="n">stem2_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">stem1_basis</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">stem2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stem2_start</span></div>


<div class="viewcode-block" id="stem2_pos_from_stem1_1"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.stem2_pos_from_stem1_1">[docs]</a><span class="k">def</span> <span class="nf">stem2_pos_from_stem1_1</span><span class="p">(</span><span class="n">transposed_stem1_basis</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get the starting point of a second stem, given the parameters</span>
<span class="sd">    about where it&#39;s located with respect to stem1</span>

<span class="sd">    The params of the stat describe the change in the coordinate system of stem1.</span>
<span class="sd">    This function converts that to a carthesian vector the standard coordinate system</span>

<span class="sd">    :param transposed_stem1_basis: The vtransposed basis of the first stem.</span>
<span class="sd">    :param params: The parameters describing the position of stem2 wrt stem1</span>
<span class="sd">                   (i.e. the carthesian vector in standard coordinates pointing from stem1 to stem2)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="n">params</span>
    <span class="n">stem2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">spherical_polar_to_cartesian</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
    <span class="n">stem2_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transposed_stem1_basis</span><span class="p">,</span> <span class="n">stem2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stem2_start</span></div>

<span class="c1"># Seems to be unused!</span>


<div class="viewcode-block" id="twist2_orient_from_stem1"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.twist2_orient_from_stem1">[docs]</a><span class="k">def</span> <span class="nf">twist2_orient_from_stem1</span><span class="p">(</span><span class="n">stem1</span><span class="p">,</span> <span class="n">twist1</span><span class="p">,</span> <span class="n">u_v_t</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate the position of the twist factor of the 2nd stem from its</span>
<span class="sd">    parameters and the first stem.</span>

<span class="sd">    :param stem1: The vector representing the axis of stem1&#39;s cylinder</span>
<span class="sd">    :param twist1: The twist factor of stem1.</span>
<span class="sd">    :param u_v_t: The parameters describing how the twist of stem2 is</span>
<span class="sd">                      oriented with respect to stem1. A triple `(u, v, t)`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">u_v_t</span>
    <span class="n">twist2_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="p">)])</span>

    <span class="n">rot_mat1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">rot_mat2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">u</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>

    <span class="n">rot_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot_mat2</span><span class="p">,</span> <span class="n">rot_mat1</span><span class="p">)</span>
    <span class="n">twist2_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">nl</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">rot_mat</span><span class="p">),</span> <span class="n">twist2_new</span><span class="p">)</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    twist2_new = dot(inv(rot_mat2), twist2_new)</span>
<span class="sd">    twist2_new = dot(inv(rot_mat1), twist2_new)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">stem1_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">stem1</span><span class="p">,</span> <span class="n">twist1</span><span class="p">)</span>
    <span class="n">twist2_new_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">twist2_new</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">,</span>
                                        <span class="n">stem1_basis</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">twist2_new_basis</span></div>


<div class="viewcode-block" id="twist2_orient_from_stem1_1"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.twist2_orient_from_stem1_1">[docs]</a><span class="k">def</span> <span class="nf">twist2_orient_from_stem1_1</span><span class="p">(</span><span class="n">stem1_basis</span><span class="p">,</span> <span class="n">u_v_t</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate the position of the twist factor of the 2nd stem from its</span>
<span class="sd">    parameters and the first stem.</span>

<span class="sd">    :param stem1: The vector representing the axis of stem1&#39;s cylinder</span>
<span class="sd">    :param twist1: The twist factor of stem1.</span>
<span class="sd">    :param u_v_t: The parameters describing how the twist of stem2 is</span>
<span class="sd">                      oriented with respect to stem1. A triple `(u, v, t)`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">u_v_t</span>
    <span class="n">twist2_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="p">)])</span>

    <span class="n">rot_mat1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">rot_mat2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">u</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>

    <span class="n">rot_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot_mat2</span><span class="p">,</span> <span class="n">rot_mat1</span><span class="p">)</span>
    <span class="c1">#assert np.allclose(nl.inv(rot_mat), rot_mat.T)</span>
    <span class="n">twist2_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot_mat</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">twist2_new</span><span class="p">)</span>

    <span class="n">twist2_new_basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">stem1_basis</span><span class="p">,</span> <span class="n">twist2_new</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">twist2_new_basis</span></div>


<div class="viewcode-block" id="stem2_orient_from_stem1"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.stem2_orient_from_stem1">[docs]</a><span class="k">def</span> <span class="nf">stem2_orient_from_stem1</span><span class="p">(</span><span class="n">stem1</span><span class="p">,</span> <span class="n">twist1</span><span class="p">,</span> <span class="n">r_u_v</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate the orientation of the second stem, given its parameterization</span>
<span class="sd">    and the parameterization of stem1</span>

<span class="sd">    :param stem1: The vector representing the axis of stem1&#39;s cylinder</span>
<span class="sd">    :param twist1: The twist factor of stem1.</span>
<span class="sd">    :param r_u_v: The orientation of stem2 wrt stem1, a triple `(r, u, v)`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">stem1_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">stem1</span><span class="p">,</span> <span class="n">twist1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stem2_orient_from_stem1_1</span><span class="p">(</span><span class="n">stem1_basis</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">r_u_v</span><span class="p">)</span></div>


<div class="viewcode-block" id="stem2_orient_from_stem1_1"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.stem2_orient_from_stem1_1">[docs]</a><span class="k">def</span> <span class="nf">stem2_orient_from_stem1_1</span><span class="p">(</span><span class="n">stem1_basis</span><span class="p">,</span> <span class="n">r_u_v</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate the orientation of the second stem, given its parameterization</span>
<span class="sd">    and the parameterization of stem1</span>

<span class="sd">    :param stem1: The vector representing the axis of stem1&#39;s cylinder</span>
<span class="sd">    :param twist1: The twist factor of stem1.</span>
<span class="sd">    :param r_u_v: The orientation of stem2 wrt stem1, a triple `(r, u, v)`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">r_u_v</span>
    <span class="n">stem2_in_basis1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">spherical_polar_to_cartesian</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
    <span class="n">stem2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">stem1_basis</span><span class="p">,</span> <span class="n">stem2_in_basis1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stem2</span></div>


<div class="viewcode-block" id="get_angle_stat_geometry"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_angle_stat_geometry">[docs]</a><span class="k">def</span> <span class="nf">get_angle_stat_geometry</span><span class="p">(</span><span class="n">stem1_vec</span><span class="p">,</span> <span class="n">twist1</span><span class="p">,</span> <span class="n">stem2_vec</span><span class="p">,</span> <span class="n">twist2</span><span class="p">,</span> <span class="n">bulge_vec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param stem1_vec: The vector of the first stem, pointing TOWARDS the bulge</span>
<span class="sd">    :param twist1: The twist vector at the side of stem1 closest to the bulge</span>
<span class="sd">    :param stem2_vec: The vector of the second stem, pointing AWAY FROM the bulge</span>
<span class="sd">    :param twist2: The twist vector at the side of stem2 closest to the bulge</span>
<span class="sd">    :param bulge_vec: The vector from stem1 to stem2</span>

<span class="sd">    :returns: T 6-tuple: u,v (the orientation parameters),</span>
<span class="sd">                         t (twist parameter) and</span>
<span class="sd">                         r1, u1, v1 (the seperation parameters)</span>


<span class="sd">        \                A</span>
<span class="sd">         \ stem1        /</span>
<span class="sd">          \            / stem2</span>
<span class="sd">           V          /</span>
<span class="sd">            ---------&gt;</span>
<span class="sd">              bulge</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Get the orientations for orienting these two stems</span>
        <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_stem_orientation_parameters</span><span class="p">(</span><span class="n">stem1_vec</span><span class="p">,</span> <span class="n">twist1</span><span class="p">,</span>
                                                       <span class="n">stem2_vec</span><span class="p">,</span> <span class="n">twist2</span><span class="p">)</span>
        <span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">u1</span><span class="p">,</span> <span class="n">v1</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_stem_separation_parameters</span><span class="p">(</span>
            <span class="n">stem1_vec</span><span class="p">,</span> <span class="n">twist1</span><span class="p">,</span> <span class="n">bulge_vec</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ZeroDivisionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">log_to_exception</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cannot get stat. The 3D coodinates are probably wrong.&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">return</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">u1</span><span class="p">,</span> <span class="n">v1</span></div>


<div class="viewcode-block" id="get_broken_ml_deviation"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_broken_ml_deviation">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">get_broken_ml_deviation</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">broken_ml_name</span><span class="p">,</span> <span class="n">fixed_stem_name</span><span class="p">,</span> <span class="n">virtual_stat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If we assgin a stat to a broken ml-segment, how much would the attached</span>
<span class="sd">    stem deviate from its true location.</span>

<span class="sd">    Calculates the position of a &#39;&quot;virtual stem&quot;, which would be</span>
<span class="sd">    placed after the broken ml-segment, if it was a true ml-segment</span>
<span class="sd">    with the virtual stat assigned.</span>
<span class="sd">    Then calculates the deviation between this virtual stem and the actual stem.</span>

<span class="sd">    :param cg: The CoarseGrainRNA</span>
<span class="sd">    :param broken_ml_name: The name of the ml-segment of interest.</span>
<span class="sd">                           It should not be part of cg.mst.</span>
<span class="sd">    :param fixed_stem_name: The name of a stem (e.g. &quot;s0&quot;) attached to the</span>
<span class="sd">                            broken ml segment. This stem will be used as reference,</span>
<span class="sd">                            For the other stem attached to the broken ml-segment (original_stem),</span>
<span class="sd">                            the virtual stem position will be calculated.</span>
<span class="sd">    :param virtual_stat: The stat assigned to the broken ml segment, in the direction</span>
<span class="sd">                         from fixed_stem_name to the other stem.</span>

<span class="sd">    :returns: A triple: positional_deviation, angular_deviation and twist_deviation.</span>
<span class="sd">              positional_deviation measures how far the start of the virtual stem</span>
<span class="sd">              is from the start of the true (&quot;original&quot;) stem.</span>
<span class="sd">              Angular deviation measures (in radians) the differece in the stem&#39;s orientation.</span>
<span class="sd">              twist_deviation measures the angle (in radians) between the two stem&#39;s twist vectors.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting broken ML deviation for </span><span class="si">%s</span><span class="s2"> attached to </span><span class="si">%s</span><span class="s2"> &quot;</span>
              <span class="s2">&quot;using stat </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">broken_ml_name</span><span class="p">,</span> <span class="n">fixed_stem_name</span><span class="p">,</span>
              <span class="n">virtual_stat</span><span class="o">.</span><span class="n">pdb_name</span><span class="p">)</span>
    <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">broken_ml_name</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">s1</span> <span class="o">==</span> <span class="n">fixed_stem_name</span><span class="p">:</span>
        <span class="n">orig_stem_name</span> <span class="o">=</span> <span class="n">s2</span>
    <span class="k">elif</span> <span class="n">s2</span> <span class="o">==</span> <span class="n">fixed_stem_name</span><span class="p">:</span>
        <span class="n">orig_stem_name</span> <span class="o">=</span> <span class="n">s1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;fixed stem </span><span class="si">{}</span><span class="s2"> is not attached to ml </span><span class="si">{}</span><span class="s2"> with &quot;</span>
                         <span class="s2">&quot;edges </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fixed_stem_name</span><span class="p">,</span> <span class="n">broken_ml_name</span><span class="p">,</span> <span class="p">[</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">]))</span>

    <span class="n">sides</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">get_sides</span><span class="p">(</span><span class="n">fixed_stem_name</span><span class="p">,</span> <span class="n">broken_ml_name</span><span class="p">)</span>
    <span class="n">fixed_s_vec</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">get_direction</span><span class="p">(</span><span class="n">fixed_stem_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sides</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">fixed_s_vec</span> <span class="o">=</span> <span class="o">-</span><span class="n">fixed_s_vec</span>
    <span class="n">s_twist</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">twists</span><span class="p">[</span><span class="n">fixed_stem_name</span><span class="p">][</span><span class="n">sides</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">fixed_stem_basis</span> <span class="o">=</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">fixed_s_vec</span><span class="p">,</span> <span class="n">s_twist</span><span class="p">)</span>
    <span class="n">vbulge_vec</span><span class="p">,</span> <span class="n">vstem_vec</span><span class="p">,</span> <span class="n">vstem_twist</span> <span class="o">=</span> <span class="n">_virtual_stem_from_bulge</span><span class="p">(</span>
        <span class="n">fixed_stem_basis</span><span class="p">,</span> <span class="n">virtual_stat</span><span class="p">)</span>

    <span class="n">vstem_vec</span> <span class="o">*=</span> <span class="mi">5</span>
    <span class="n">vstem_coords0</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">fixed_stem_name</span><span class="p">][</span><span class="n">sides</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">vbulge_vec</span>
    <span class="n">vstem_coords1</span> <span class="o">=</span> <span class="n">vstem_coords0</span> <span class="o">+</span> <span class="n">vstem_vec</span>

    <span class="n">sides2</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">get_sides</span><span class="p">(</span><span class="n">orig_stem_name</span><span class="p">,</span> <span class="n">broken_ml_name</span><span class="p">)</span>
    <span class="n">orig_coords0</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">orig_stem_name</span><span class="p">][</span><span class="n">sides2</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">orig_coords1</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">orig_stem_name</span><span class="p">][</span><span class="n">sides2</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

    <span class="n">orig_stem_vec</span> <span class="o">=</span> <span class="n">orig_coords1</span> <span class="o">-</span> <span class="n">orig_coords0</span>
    <span class="n">true_bulge_vec</span> <span class="o">=</span> <span class="n">orig_coords0</span> <span class="o">-</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">fixed_stem_name</span><span class="p">][</span><span class="n">sides</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="n">pos_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">ftuv</span><span class="o">.</span><span class="n">vec_distance</span><span class="p">(</span><span class="n">orig_coords0</span><span class="p">,</span> <span class="n">vstem_coords0</span><span class="p">))</span>
    <span class="n">ang_dev</span> <span class="o">=</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span><span class="n">vstem_vec</span><span class="p">,</span> <span class="n">orig_stem_vec</span><span class="p">)</span>
    <span class="n">twist_dev</span> <span class="o">=</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span>
        <span class="n">cg</span><span class="o">.</span><span class="n">twists</span><span class="p">[</span><span class="n">orig_stem_name</span><span class="p">][</span><span class="n">sides2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">vstem_twist</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Deviation: pos </span><span class="si">%s</span><span class="s2">, orient </span><span class="si">%s</span><span class="s2">, twist: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pos_dev</span><span class="p">,</span>
              <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">ang_dev</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">twist_dev</span><span class="p">))</span>

    <span class="c1"># For debugging</span>
    <span class="c1">#max_diff = 6</span>
    <span class="c1">#max_adiff = math.radians(3*max_diff)</span>
    <span class="c1"># if pos_dev &lt; max_diff and ang_dev&lt;max_adiff and twist_dev&lt;2*max_adiff:</span>
    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># plotting-code used for debugging</span>
        <span class="n">pos_adev</span> <span class="o">=</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span><span class="n">true_bulge_vec</span><span class="p">,</span> <span class="n">vbulge_vec</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deviation: pos </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2"> orient </span><span class="si">%s</span><span class="s2">, twist: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pos_dev</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">pos_adev</span><span class="p">),</span>
                 <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">ang_dev</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">twist_dev</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Length: virtual: </span><span class="si">%s</span><span class="s2"> original: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span>
            <span class="n">vstem_vec</span><span class="p">),</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">orig_stem_vec</span><span class="p">))</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

        <span class="n">_plot_junction_2d</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">broken_ml_name</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">fixed_stem_name</span><span class="p">][</span><span class="n">sides</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">orig_stem_name</span><span class="p">][</span><span class="n">sides2</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]],</span>
                 <span class="p">[</span><span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">fixed_stem_name</span><span class="p">][</span><span class="n">sides</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">],</span>
                     <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">orig_stem_name</span><span class="p">][</span><span class="n">sides2</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">]],</span>
                 <span class="s2">&quot;.-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;true bulge&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">fixed_stem_name</span><span class="p">][</span><span class="n">sides</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">],</span> <span class="n">vstem_coords0</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                 <span class="p">[</span><span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">fixed_stem_name</span><span class="p">][</span><span class="n">sides</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">],</span> <span class="n">vstem_coords0</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                 <span class="s2">&quot;.-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;virtual bulge&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">vstem_coords0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vstem_coords1</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                 <span class="p">[</span><span class="n">vstem_coords0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vstem_coords1</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                 <span class="s2">&quot;s-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;virtual&quot;</span> <span class="o">+</span> <span class="n">orig_stem_name</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">pos_dev</span><span class="p">,</span> <span class="n">ang_dev</span><span class="p">,</span> <span class="n">twist_dev</span></div>


<span class="k">def</span> <span class="nf">_plot_element</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">elem</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="n">name_suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span>
             <span class="p">[</span><span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]],</span>
             <span class="n">style</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="n">elem</span> <span class="o">+</span> <span class="n">name_suffix</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_plot_junction_2d</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">broken_ml</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TODO: Move this to a proper location</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="n">plotted</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">_plot_element</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">broken_ml</span><span class="p">,</span> <span class="n">name_suffix</span><span class="o">=</span><span class="s2">&quot; broken&quot;</span><span class="p">)</span>
    <span class="n">elem</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">get_next_ml_segment</span><span class="p">(</span><span class="n">broken_ml</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">elem</span> <span class="o">!=</span> <span class="n">broken_ml</span><span class="p">:</span>
        <span class="n">_plot_element</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">cg</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">elem</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plotted</span><span class="p">:</span>
                <span class="n">_plot_element</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
                <span class="n">plotted</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">elem</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">get_next_ml_segment</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_virtual_stem_from_bulge</span><span class="p">(</span><span class="n">prev_stem_basis</span><span class="p">,</span>  <span class="n">stat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a virtual stem with length 1 that would be placed</span>
<span class="sd">    by stat and prev_stem</span>

<span class="sd">    :param prev_stem_basis: The basis of the previous stem.</span>
<span class="sd">    :param stat: The angle stat that describes the orientation of the</span>
<span class="sd">                 virtual stem from the previous stem.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">transposed_stem1_basis</span> <span class="o">=</span> <span class="n">prev_stem_basis</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">start_location</span> <span class="o">=</span> <span class="n">stem2_pos_from_stem1_1</span><span class="p">(</span>
        <span class="n">transposed_stem1_basis</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">position_params</span><span class="p">())</span>
    <span class="n">stem_orientation</span> <span class="o">=</span> <span class="n">stem2_orient_from_stem1_1</span><span class="p">(</span><span class="n">transposed_stem1_basis</span><span class="p">,</span>
                                                 <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">orientation_params</span><span class="p">()))</span>
    <span class="n">twist1</span> <span class="o">=</span> <span class="n">twist2_orient_from_stem1_1</span><span class="p">(</span>
        <span class="n">transposed_stem1_basis</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">twist_params</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">start_location</span><span class="p">,</span> <span class="n">stem_orientation</span><span class="p">,</span> <span class="n">twist1</span>


<div class="viewcode-block" id="get_centroid"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_centroid">[docs]</a><span class="k">def</span> <span class="nf">get_centroid</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">residue_num</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param residue_num: A list of integers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">residue_num</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">residue_num</span><span class="p">]</span>
    <span class="c1">#print &gt;&gt;sys.stderr, &quot;residue_num:&quot;, residue_num</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">residue_num</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">atoms</span> <span class="o">+=</span> <span class="p">[</span><span class="n">chain</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">REFERENCE_CATOM</span><span class="p">]]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># the C1* atom probably doesn&#39;t exist</span>
            <span class="k">continue</span>

    <span class="n">vectors</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">cuv</span><span class="o">.</span><span class="n">get_vector_centroid</span><span class="p">(</span><span class="n">vectors</span><span class="p">)</span></div>

<span class="c1"># Seems to be unused!</span>


<div class="viewcode-block" id="get_bulge_centroid"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_bulge_centroid">[docs]</a><span class="k">def</span> <span class="nf">get_bulge_centroid</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">define</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">res_nums</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">define</span><span class="p">):</span>
        <span class="n">res_nums</span> <span class="o">+=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">define</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">define</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>

    <span class="c1">#print &gt;&gt;sys.stderr, &quot;res_nums:&quot;, res_nums</span>
    <span class="k">return</span> <span class="n">get_centroid</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">res_nums</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_furthest_c_alpha"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_furthest_c_alpha">[docs]</a><span class="k">def</span> <span class="nf">get_furthest_c_alpha</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">stem_end</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get the position of the c-alpha atom furthest from the end of the stem.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">seq_ids</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">max_dist</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">furthest_pos</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">res_ids</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">cg</span><span class="o">.</span><span class="n">get_resseqs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">seq_ids</span><span class="o">=</span><span class="n">seq_ids</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">chainId</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">res_ids</span><span class="p">:</span>  <span class="c1"># seq_ids now contain chain</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">c_apos</span> <span class="o">=</span> <span class="n">chain</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">REFERENCE_CATOM</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ke</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Nucleotide </span><span class="si">%s</span><span class="s2"> missing in element </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">d</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">dist</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">stem_end</span> <span class="o">-</span> <span class="n">c_apos</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dist</span> <span class="o">&gt;=</span> <span class="n">max_dist</span><span class="p">:</span>
            <span class="n">max_dist</span> <span class="o">=</span> <span class="n">dist</span>
            <span class="n">furthest_pos</span> <span class="o">=</span> <span class="n">c_apos</span>

    <span class="k">return</span> <span class="n">furthest_pos</span></div>


<div class="viewcode-block" id="stem_from_chains"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.stem_from_chains">[docs]</a><span class="k">def</span> <span class="nf">stem_from_chains</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">chains</span><span class="p">,</span> <span class="n">elem_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function combines get_mids and get_twists into one more efficient routine.</span>

<span class="sd">    :param chains: A dictionary {chain_id: Biopython_PDB_chain}</span>
<span class="sd">    :param elem_name: e.g. &quot;s0&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stem_length</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">stem_length</span><span class="p">(</span><span class="n">elem_name</span><span class="p">)</span>
    <span class="n">template_filename</span> <span class="o">=</span> <span class="s1">&#39;ideal_1_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">.pdb&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stem_length</span><span class="p">,</span> <span class="n">stem_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                                  <span class="n">stem_length</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">forgi</span><span class="o">.</span><span class="n">threedee</span><span class="o">.</span><span class="n">data_file</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">template_filename</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ideal_chain</span> <span class="o">=</span> <span class="n">ftup</span><span class="o">.</span><span class="n">get_first_chain</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">stem_length</span> <span class="o">&gt;</span> <span class="mi">40</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CgConstructionError</span><span class="p">(</span><span class="s2">&quot;Cannot create coordinates. &quot;</span>
                                      <span class="s2">&quot;Helices with lengths greater than 40 are currently not supported in forgi.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span>
    <span class="n">stem_chain</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">Chain</span><span class="o">.</span><span class="n">Chain</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">residue_ids</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">get_resseqs</span><span class="p">(</span><span class="n">elem_name</span><span class="p">,</span> <span class="n">seq_ids</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">log_to_exception</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;seq_ids were &#39;</span><span class="si">%r</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">cg</span><span class="o">.</span><span class="n">seq_ids</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="n">new_residue_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">strand</span> <span class="ow">in</span> <span class="n">residue_ids</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">res_id</span> <span class="ow">in</span> <span class="n">strand</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding residue </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">res_id</span><span class="p">)</span>
            <span class="n">original_residue</span> <span class="o">=</span> <span class="n">chains</span><span class="p">[</span><span class="n">res_id</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">res_id</span><span class="o">.</span><span class="n">resid</span><span class="p">]</span>
            <span class="n">residue</span> <span class="o">=</span> <span class="n">original_residue</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">stem_chain</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">residue</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Bio</span><span class="o">.</span><span class="n">PDB</span><span class="o">.</span><span class="n">PDBExceptions</span><span class="o">.</span><span class="n">PDBConstructionException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Temporarily changing resid </span><span class="si">%s</span><span class="s2"> to uuid, because this id is present twice (with different chain) in one stem&quot;</span><span class="p">,</span> <span class="n">residue</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">change_residue_id</span><span class="p">(</span><span class="n">residue</span><span class="p">,</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
                <span class="n">stem_chain</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">residue</span><span class="p">)</span>
            <span class="n">new_residue_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">residue</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="n">rotran</span> <span class="o">=</span> <span class="n">ftup</span><span class="o">.</span><span class="n">pdb_rmsd</span><span class="p">(</span><span class="n">stem_chain</span><span class="p">,</span> <span class="n">ideal_chain</span><span class="p">,</span> <span class="n">sidechains</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">superimpose</span><span class="o">=</span><span class="kc">True</span> <span class="p">)[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># average length of a base-pair: 2.547</span>
    <span class="n">mult</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># Stems with 1 bp have a tiny length</span>
    <span class="n">ideal_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">mult</span><span class="p">],</span>
                             <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="n">mult</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">stem_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.547</span><span class="p">])])</span>

    <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ideal_coords</span><span class="p">,</span> <span class="n">rotran</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">rotran</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">stem_direction</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># the first nucleotide of the first strand</span>
    <span class="c1"># and the last nucleotide of the second strand</span>
    <span class="n">first_res</span> <span class="o">=</span> <span class="n">residue_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">start_vec1</span> <span class="o">=</span> <span class="n">chains</span><span class="p">[</span><span class="n">first_res</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">first_res</span><span class="o">.</span><span class="n">resid</span><span class="p">][</span><span class="n">REFERENCE_CATOM</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">last_res</span> <span class="o">=</span> <span class="n">residue_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">end_vec1</span> <span class="o">=</span> <span class="n">chains</span><span class="p">[</span><span class="n">last_res</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">last_res</span><span class="o">.</span><span class="n">resid</span><span class="p">][</span><span class="n">REFERENCE_CATOM</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># the last nucleotide of the first strand</span>
    <span class="c1"># and the first nucleotide of the second strand</span>
    <span class="n">first_res_a</span> <span class="o">=</span> <span class="n">residue_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">start_vec1a</span> <span class="o">=</span> <span class="n">chains</span><span class="p">[</span><span class="n">first_res_a</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">first_res_a</span><span class="o">.</span><span class="n">resid</span><span class="p">][</span><span class="n">REFERENCE_CATOM</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Atoms are </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">chains</span><span class="p">[</span><span class="n">first_res_a</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">first_res_a</span><span class="o">.</span><span class="n">resid</span><span class="p">]</span><span class="o">.</span><span class="n">child_dict</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="n">last_res_a</span> <span class="o">=</span> <span class="n">residue_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">end_vec1a</span> <span class="o">=</span> <span class="n">chains</span><span class="p">[</span><span class="n">last_res_a</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">last_res_a</span><span class="o">.</span><span class="n">resid</span><span class="p">][</span><span class="n">REFERENCE_CATOM</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">notch1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">vector_rejection</span><span class="p">(</span><span class="n">start_vec1</span><span class="p">,</span> <span class="n">stem_direction</span><span class="p">)</span>
    <span class="n">notch2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">vector_rejection</span><span class="p">(</span><span class="n">end_vec1</span><span class="p">,</span> <span class="n">stem_direction</span><span class="p">)</span>

    <span class="n">notch1a</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">vector_rejection</span><span class="p">(</span><span class="n">start_vec1a</span><span class="p">,</span> <span class="n">stem_direction</span><span class="p">)</span>
    <span class="n">notch2a</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">vector_rejection</span><span class="p">(</span><span class="n">end_vec1a</span><span class="p">,</span> <span class="n">stem_direction</span><span class="p">)</span>

    <span class="n">twists</span> <span class="o">=</span> <span class="p">(</span><span class="n">cuv</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">notch1</span> <span class="o">+</span> <span class="n">notch1a</span><span class="p">),</span> <span class="n">cuv</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">notch2</span> <span class="o">+</span> <span class="n">notch2a</span><span class="p">))</span>

    <span class="c1"># Perform some verification</span>
    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">verify_vatom_positions</span><span class="p">(</span><span class="n">residue_ids</span><span class="p">,</span> <span class="n">chains</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span>
                               <span class="n">twists</span><span class="p">,</span> <span class="s2">&quot;stem_</span><span class="si">{}</span><span class="s2">_from_chain&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">elem_name</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">coords</span><span class="p">,</span> <span class="n">twists</span></div>


<div class="viewcode-block" id="verify_vatom_positions"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.verify_vatom_positions">[docs]</a><span class="k">def</span> <span class="nf">verify_vatom_positions</span><span class="p">(</span><span class="n">residue_ids</span><span class="p">,</span> <span class="n">chains</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">twists</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param coords: The coords of ONE stem</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res1</span><span class="p">,</span> <span class="n">res2</span> <span class="o">=</span> <span class="n">residue_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">residue_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">res3</span><span class="p">,</span> <span class="n">res4</span> <span class="o">=</span> <span class="n">residue_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">residue_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d</span> <span class="k">import</span> <span class="n">Axes3D</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">Axes3D</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="n">strand0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="n">chains</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">r</span><span class="o">.</span><span class="n">resid</span><span class="p">][</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">residue_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">strand1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="n">chains</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">r</span><span class="o">.</span><span class="n">resid</span><span class="p">][</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">residue_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">strand0</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">strand0</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">strand0</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;forward strand&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">strand1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">strand1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">strand1</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;backwards strand&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">chains</span><span class="p">[</span><span class="n">res1</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">res1</span><span class="o">.</span><span class="n">resid</span><span class="p">][</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chains</span><span class="p">[</span><span class="n">res2</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">res2</span><span class="o">.</span><span class="n">resid</span><span class="p">][</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
            <span class="p">[</span><span class="n">chains</span><span class="p">[</span><span class="n">res1</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">res1</span><span class="o">.</span><span class="n">resid</span><span class="p">][</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">chains</span><span class="p">[</span><span class="n">res2</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">res2</span><span class="o">.</span><span class="n">resid</span><span class="p">][</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
            <span class="p">[</span><span class="n">chains</span><span class="p">[</span><span class="n">res1</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">res1</span><span class="o">.</span><span class="n">resid</span><span class="p">][</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">chains</span><span class="p">[</span><span class="n">res2</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">res2</span><span class="o">.</span><span class="n">resid</span><span class="p">][</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;bp&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">chains</span><span class="p">[</span><span class="n">res3</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">res3</span><span class="o">.</span><span class="n">resid</span><span class="p">][</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chains</span><span class="p">[</span><span class="n">res4</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">res4</span><span class="o">.</span><span class="n">resid</span><span class="p">][</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
            <span class="p">[</span><span class="n">chains</span><span class="p">[</span><span class="n">res3</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">res3</span><span class="o">.</span><span class="n">resid</span><span class="p">][</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">chains</span><span class="p">[</span><span class="n">res4</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">res4</span><span class="o">.</span><span class="n">resid</span><span class="p">][</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
            <span class="p">[</span><span class="n">chains</span><span class="p">[</span><span class="n">res3</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">res3</span><span class="o">.</span><span class="n">resid</span><span class="p">][</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">chains</span><span class="p">[</span><span class="n">res4</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">res4</span><span class="o">.</span><span class="n">resid</span><span class="p">][</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;bp&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;STEM&quot;</span><span class="p">)</span>
    <span class="n">twist1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">twists</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                       <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">twists</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="p">])</span>
    <span class="n">twist2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">twists</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                       <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">twists</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twist1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">twist1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">twist1</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Twist1&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twist2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">twist2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">twist2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Twist1&quot;</span><span class="p">)</span>
    <span class="c1"># Virtual atoms</span>

    <span class="n">vres_pos</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">vres_bases</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">c1_vecs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">residue_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">virtual_res_3d_pos_core</span><span class="p">(</span>
            <span class="n">coords</span><span class="p">,</span> <span class="n">twists</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">residue_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">vres_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="n">virtual_res_basis_core</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">twists</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">residue_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">vres_bases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
        <span class="n">c1_vecs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ftuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span>
            <span class="n">chains</span><span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">res</span><span class="o">.</span><span class="n">resid</span><span class="p">][</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span> <span class="o">-</span> <span class="n">vres_pos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">vres_bases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">))</span>

    <span class="c1">#print(&quot;C1 vecs:&quot;, c1_vecs)</span>
    <span class="n">av_c1_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">c1_vecs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">c1_vecs</span><span class="p">)</span>
    <span class="c1">#print(&quot;Av C1&#39; vec = &quot;, av_c1_vec)</span>
    <span class="n">virtual_c1s</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">basis</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">vres_pos</span><span class="p">,</span> <span class="n">vres_bases</span><span class="p">):</span>
        <span class="n">virtual_c1s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ftuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span>
            <span class="n">av_c1_vec</span><span class="p">,</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">,</span> <span class="n">basis</span><span class="p">)</span> <span class="o">+</span> <span class="n">pos</span><span class="p">)</span>

    <span class="n">virtual_c1s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">virtual_c1s</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">virtual_c1s</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">virtual_c1s</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">virtual_c1s</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;virtual C1&#39;&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
    <span class="c1">#assert False</span>


<div class="viewcode-block" id="total_helix_rotation"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.total_helix_rotation">[docs]</a><span class="k">def</span> <span class="nf">total_helix_rotation</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">twists</span><span class="p">,</span> <span class="n">stem_len</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the total rotation of the helix in radians from the twists.</span>

<span class="sd">    When we calculate the angle between the two twists, we only know</span>
<span class="sd">    the true rotation modulo 2*pi (i.e. a rotation of 45 degrees could</span>
<span class="sd">    mean 45 degrees or 405 degrees). Depending on the number of nucleotides and</span>
<span class="sd">    knowledge of the ideal helix (which turns roughly 30 degrees per base-pair),</span>
<span class="sd">    this function outputs the correct result.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stem_vec</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># the angle of the second twist with respect to the first</span>
    <span class="n">stem_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">stem_vec</span><span class="p">,</span> <span class="n">twists</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">twists</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">stem_basis</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span>
    <span class="n">twist_angle</span> <span class="o">=</span> <span class="n">ftum</span><span class="o">.</span><span class="n">atan3</span><span class="p">(</span><span class="n">t2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">t2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># calculated from an ideal length 30 helix</span>
    <span class="n">average_ang_per_nt</span> <span class="o">=</span> <span class="mf">0.636738030735</span>
    <span class="n">expected_total_ang</span> <span class="o">=</span> <span class="p">(</span><span class="n">stem_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">average_ang_per_nt</span>
    <span class="n">expected_twist_ang</span> <span class="o">=</span> <span class="n">expected_total_ang</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span></div>


<div class="viewcode-block" id="virtual_res_3d_pos_core"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.virtual_res_3d_pos_core">[docs]</a><span class="k">def</span> <span class="nf">virtual_res_3d_pos_core</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">twists</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">stem_len</span><span class="p">,</span> <span class="n">stem_inv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate the virtual position of the i&#39;th nucleotide in the stem.</span>

<span class="sd">    The virtual position extrapolates the position of the residues based</span>
<span class="sd">    on the twists of the helix.</span>

<span class="sd">    :return: A tuple containing the point located on the axis of the stem</span>
<span class="sd">             and a vector away from that point in the direction of the</span>
<span class="sd">             residue.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#stem_len = bg.defines[stem][1] - bg.defines[stem][0] + 1</span>
    <span class="n">stem_vec</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># the position of the virtual residue along the axis of</span>
    <span class="c1"># the stem</span>
    <span class="k">if</span> <span class="n">stem_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">vres_stem_pos</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vres_stem_pos</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">stem_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">stem_vec</span>

    <span class="c1"># the angle of the second twist with respect to the first</span>
    <span class="k">if</span> <span class="n">stem_inv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stem_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">stem_vec</span><span class="p">,</span> <span class="n">twists</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">twists</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">stem_basis</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">stem_inv</span><span class="p">,</span> <span class="n">twists</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">ang</span> <span class="o">=</span> <span class="n">ftum</span><span class="o">.</span><span class="n">atan3</span><span class="p">(</span><span class="n">t2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">t2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># calculated from an ideal length 30 helix</span>
    <span class="n">average_ang_per_nt</span> <span class="o">=</span> <span class="mf">0.636738030735</span>
    <span class="n">expected_ang</span> <span class="o">=</span> <span class="p">(</span><span class="n">stem_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">average_ang_per_nt</span>
    <span class="n">expected_dev</span> <span class="o">=</span> <span class="n">expected_ang</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">expected_dev</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">expected_dev</span> <span class="o">-=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>
    <span class="c1"># expected_dev uis now between 0 and 360 degrees</span>
    <span class="k">if</span> <span class="n">ang</span> <span class="o">&lt;</span> <span class="n">expected_dev</span><span class="p">:</span>
        <span class="n">forward</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="n">ang</span> <span class="o">-</span> <span class="n">expected_dev</span>
        <span class="n">backward</span> <span class="o">=</span> <span class="n">expected_dev</span> <span class="o">-</span> <span class="n">ang</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">forward</span> <span class="o">=</span> <span class="n">ang</span> <span class="o">-</span> <span class="n">expected_dev</span>
        <span class="n">backward</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="n">expected_dev</span> <span class="o">-</span> <span class="n">ang</span>

    <span class="k">if</span> <span class="n">forward</span> <span class="o">&lt;</span> <span class="n">backward</span><span class="p">:</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="n">expected_ang</span> <span class="o">+</span> <span class="n">forward</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="n">expected_ang</span> <span class="o">-</span> <span class="n">backward</span>

    <span class="k">if</span> <span class="n">stem_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ang_per_nt</span> <span class="o">=</span> <span class="n">ang</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">stem_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="n">ang_per_nt</span> <span class="o">*</span> <span class="n">i</span>

    <span class="c1"># the basis vectors for the helix along which the</span>
    <span class="c1"># virtual residues will residue</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">twists</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">stem_vec</span><span class="p">,</span> <span class="n">twists</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="n">ang_offset</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="c1"># equation for a circle in 3-space</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">vres_stem_pos</span><span class="p">,</span>
            <span class="n">u</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang</span><span class="p">)</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span><span class="p">),</span>
            <span class="n">u</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang</span> <span class="o">+</span> <span class="n">ang_offset</span><span class="p">)</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span> <span class="o">+</span> <span class="n">ang_offset</span><span class="p">),</span>
            <span class="n">u</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang</span> <span class="o">-</span> <span class="n">ang_offset</span><span class="p">)</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span> <span class="o">-</span> <span class="n">ang_offset</span><span class="p">))</span></div>


<div class="viewcode-block" id="virtual_res_3d_pos"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.virtual_res_3d_pos">[docs]</a><span class="k">def</span> <span class="nf">virtual_res_3d_pos</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">stem</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">stem_inv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stem_length</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">stem_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">virtual_res_3d_pos_core</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem</span><span class="p">],</span> <span class="n">bg</span><span class="o">.</span><span class="n">twists</span><span class="p">[</span><span class="n">stem</span><span class="p">],</span> <span class="n">i</span><span class="p">,</span>
                                       <span class="n">bg</span><span class="o">.</span><span class="n">stem_length</span><span class="p">(</span><span class="n">stem</span><span class="p">),</span> <span class="n">stem_inv</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">virtual_res_3d_pos_core</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem</span><span class="p">],</span> <span class="n">bg</span><span class="o">.</span><span class="n">twists</span><span class="p">[</span><span class="n">stem</span><span class="p">],</span> <span class="n">i</span><span class="p">,</span>
                                       <span class="n">stem_length</span><span class="p">,</span> <span class="n">stem_inv</span><span class="p">)</span></div>


<div class="viewcode-block" id="virtual_res_basis_core"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.virtual_res_basis_core">[docs]</a><span class="k">def</span> <span class="nf">virtual_res_basis_core</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">twists</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">stem_len</span><span class="p">,</span> <span class="n">vec</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Define a basis based on the location of a virtual stem residue.</span>

<span class="sd">    The basis will be defined by the direction of the stem, the direction</span>
<span class="sd">    of the virtual residue.</span>

<span class="sd">    :param bg: The BulgeGraph structure</span>
<span class="sd">    :param stem: The name of the stem</span>
<span class="sd">    :param i: The i&#39;th residue of the stem</span>

<span class="sd">    :return: A 3x3 matrix defining the coordinate system above.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">vec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">vec_l</span><span class="p">,</span> <span class="n">vec_r</span><span class="p">)</span> <span class="o">=</span> <span class="n">virtual_res_3d_pos_core</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">twists</span><span class="p">,</span>
                                                           <span class="n">i</span><span class="p">,</span> <span class="n">stem_len</span><span class="p">)</span>

    <span class="n">stem_vec</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">stem_vec</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span></div>


<div class="viewcode-block" id="virtual_res_basis"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.virtual_res_basis">[docs]</a><span class="k">def</span> <span class="nf">virtual_res_basis</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">stem</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">vec</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">virtual_res_basis_core</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem</span><span class="p">],</span> <span class="n">bg</span><span class="o">.</span><span class="n">twists</span><span class="p">[</span><span class="n">stem</span><span class="p">],</span> <span class="n">i</span><span class="p">,</span>
                                  <span class="n">bg</span><span class="o">.</span><span class="n">stem_length</span><span class="p">(</span><span class="n">stem</span><span class="p">),</span> <span class="n">vec</span><span class="p">)</span></div>


<div class="viewcode-block" id="pos_to_spos"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.pos_to_spos">[docs]</a><span class="k">def</span> <span class="nf">pos_to_spos</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">i2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convert the location of s2, i2 into the coordinate system</span>
<span class="sd">    defined by (s1, i1)</span>

<span class="sd">    :param bg: The BulgeGraph containing the stems</span>
<span class="sd">    :param s1: The basis stem name</span>
<span class="sd">    :param i1: The basis res position</span>
<span class="sd">    :param s2: The stem containing the nucleotide to be converted</span>
<span class="sd">    :param i2: The nucleotide to be converted position</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">sbasis</span> <span class="o">=</span> <span class="n">virtual_res_basis</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">i1</span><span class="p">)</span>
    <span class="p">(</span><span class="n">s1_pos</span><span class="p">,</span> <span class="n">s1_vec</span><span class="p">,</span> <span class="n">s1_vec_l</span><span class="p">,</span> <span class="n">s1_vec_r</span><span class="p">)</span> <span class="o">=</span> <span class="n">virtual_res_3d_pos</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">i1</span><span class="p">)</span>
    <span class="p">(</span><span class="n">s2_pos</span><span class="p">,</span> <span class="n">s2_vec</span><span class="p">,</span> <span class="n">s2_vec_l</span><span class="p">,</span> <span class="n">s2_vec_r</span><span class="p">)</span> <span class="o">=</span> <span class="n">virtual_res_3d_pos</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">i2</span><span class="p">)</span>

    <span class="c1">#rpos = (s2_pos + 7. * s2_vec) - (s1_pos + 7 * s1_vec)</span>
    <span class="n">rpos</span> <span class="o">=</span> <span class="p">(</span><span class="n">s2_pos</span> <span class="o">+</span> <span class="mf">7.</span> <span class="o">*</span> <span class="n">s2_vec</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">s1_pos</span><span class="p">)</span>
    <span class="c1"># print &quot;sbasis:&quot;, sbasis</span>

    <span class="n">spos</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">rpos</span><span class="p">,</span> <span class="n">sbasis</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    if spos[1] ** 2 + spos[2] ** 2 &lt; 5 and spos[0] &gt; -5 and spos[0] &lt; 5:</span>
<span class="sd">        print &gt;&gt;sys.stderr, &quot;spos:&quot;, spos, s1, i1, s2, i2</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">spos</span></div>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">def spos_to_pos(bg, stem, i, spos):</span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="sd">    Convert the location of spos from the coordinate system</span>
<span class="sd">    of (stem, i) into the standard coordinate system.</span>

<span class="sd">    :param bg: The BulgeGraph</span>
<span class="sd">    :param stem: The name of the stem in the BulgeGraph</span>
<span class="sd">    :param i: The i&#39;th residue in &#39;stem&#39; which will define the coordinate</span>
<span class="sd">              system</span>
<span class="sd">    :param spos: The position in the alternate coordinate system</span>

<span class="sd">    :return: The coordinates in the cartesian coordinate system of the</span>
<span class="sd">        rest of the model.</span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="sd">    if stem in bg.vbases and i in bg.vbases[stem]:</span>
<span class="sd">        sbasis=bg.vbases[stem][i]</span>
<span class="sd">    else:</span>
<span class="sd">        sbasis = virtual_res_basis(bg, stem, i)</span>
<span class="sd">    pos = cuv.change_basis(spos, cuv.standard_basis, sbasis)</span>

<span class="sd">    try:</span>
<span class="sd">        (s1_pos, s1_vec, s1_vec_l, s1_vec_r) = bg.v3dposs[stem][i]</span>
<span class="sd">    except KeyError as e:</span>
<span class="sd">        log.info(&quot;in spos_to_pos: KeyError {}. Adding virtual residues for stem {}&quot;.format(e, stem))</span>
<span class="sd">        add_virtual_residues(bg, stem)</span>
<span class="sd">        (s1_pos, s1_vec, s1_vec_l, s1_vec_r) = bg.v3dposs[stem][i]</span>

<span class="sd">    #return pos + (s1_pos + s1_vec) #TODO BT: THIS SEEMS WRONG</span>
<span class="sd">    return pos + s1_pos</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="get_residue_type"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_residue_type">[docs]</a><span class="k">def</span> <span class="nf">get_residue_type</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">stem_len</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Each nucleotide will be classified according to its position</span>
<span class="sd">    within the stem. That way, the distribution of surrounding</span>
<span class="sd">    nucleotides will be conditioned on the type of nucleotides.</span>

<span class="sd">    This is important due to the fact that nucleotides at the end</span>
<span class="sd">    of a stem may have other stem nucleotides in the direction</span>
<span class="sd">    of the stem vector. Nucleotides, in the middle shoubulge not due</span>
<span class="sd">    to the excluded volume of the stem they occupy.</span>

<span class="sd">    :param i: The position of the nucleotide.</span>
<span class="sd">    :param stem_len: The length of the stem.</span>

<span class="sd">    :return: The type of nucleotide position.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">stem_len</span><span class="p">)</span>

    <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="junction_virtual_res_distance"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.junction_virtual_res_distance">[docs]</a><span class="k">def</span> <span class="nf">junction_virtual_res_distance</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">bulge</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Compute the distance between the two virtual residues flanking</span>
<span class="sd">    a bulge region.</span>

<span class="sd">    :param bg: The BulgeGraph containing the bulge.</span>
<span class="sd">    :param bulge: The name of the bulge.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">cs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">bulge</span><span class="p">])</span>

    <span class="p">(</span><span class="n">s1b</span><span class="p">,</span> <span class="n">s1e</span><span class="p">)</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">get_sides</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bulge</span><span class="p">)</span>
    <span class="p">(</span><span class="n">s2b</span><span class="p">,</span> <span class="n">s2e</span><span class="p">)</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">get_sides</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bulge</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">s1b</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">v3dposs</span><span class="p">[</span><span class="n">cs</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">bg</span><span class="o">.</span><span class="n">stem_length</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">v3dposs</span><span class="p">[</span><span class="n">cs</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">(</span><span class="n">vr1_p</span><span class="p">,</span> <span class="n">vr1_v</span><span class="p">,</span> <span class="n">vr1_v_l</span><span class="p">,</span> <span class="n">vr1_v_r</span><span class="p">)</span> <span class="o">=</span> <span class="n">res</span>

    <span class="k">if</span> <span class="n">s2b</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">v3dposs</span><span class="p">[</span><span class="n">cs</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">bg</span><span class="o">.</span><span class="n">stem_length</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">v3dposs</span><span class="p">[</span><span class="n">cs</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>

    <span class="p">(</span><span class="n">vr2_p</span><span class="p">,</span> <span class="n">vr2_v</span><span class="p">,</span> <span class="n">vr2_v_l</span><span class="p">,</span> <span class="n">vr2_v_r</span><span class="p">)</span> <span class="o">=</span> <span class="n">res</span>

    <span class="n">dist2</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">vec_distance</span><span class="p">((</span><span class="n">vr1_p</span> <span class="o">+</span> <span class="mf">7.</span> <span class="o">*</span> <span class="n">vr1_v</span><span class="p">),</span> <span class="p">(</span><span class="n">vr2_p</span> <span class="o">+</span> <span class="mf">7.</span> <span class="o">*</span> <span class="n">vr2_v</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dist2</span></div>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">def get_strand_atom_vrn(bg, s, i):</span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="sd">    Return the strand and which atom to use for the adjacent</span>
<span class="sd">    nucleotide distance calculation.</span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="sd">    if i == 0:</span>
<span class="sd">        return (0, &#39;P&#39;, 0)</span>

<span class="sd">    # this might have to just be bg.stem_length(s)</span>
<span class="sd">    if i == 1:</span>
<span class="sd">        return (0, &#39;O3*&#39;, bg.stem_length(s) - 1)</span>
<span class="sd">    if i == 2:</span>
<span class="sd">        return (1, &#39;P&#39;, bg.stem_length(s) - 1)</span>
<span class="sd">    if i == 3:</span>
<span class="sd">        return (1, &#39;O3*&#39;, 0)</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="junction_virtual_atom_distance"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.junction_virtual_atom_distance">[docs]</a><span class="k">def</span> <span class="nf">junction_virtual_atom_distance</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">bulge</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Compute the distance between the O3&#39; atom and P&#39; atom</span>
<span class="sd">    of the two residues that flank the junction segment.</span>

<span class="sd">    :param bg: The BulgeGraph containing the bulge.</span>
<span class="sd">    :param bulge: The name of the bulge</span>

<span class="sd">    :return: A single number corresponding to the distance above.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">connecting_stems</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">connections</span><span class="p">(</span><span class="n">bulge</span><span class="p">)</span>
    <span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">k1</span><span class="p">)</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">_get_sides_plus</span><span class="p">(</span><span class="n">connecting_stems</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bulge</span><span class="p">)</span>
    <span class="p">(</span><span class="n">i2</span><span class="p">,</span> <span class="n">k2</span><span class="p">)</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">_get_sides_plus</span><span class="p">(</span><span class="n">connecting_stems</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bulge</span><span class="p">)</span>
    <span class="n">pos1</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">connecting_stems</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">i1</span><span class="p">]</span>
    <span class="n">pos2</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">connecting_stems</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">i2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">bulge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;m&quot;</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">]))</span> <span class="o">==</span> <span class="n">bg</span><span class="o">.</span><span class="n">flanking_nucleotides</span><span class="p">(</span><span class="n">bulge</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i1</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i1</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="s2">&quot;P&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="s2">&quot;O3&#39;&quot;</span>
    <span class="k">if</span> <span class="n">i2</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i2</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="s2">&quot;P&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="s2">&quot;O3&#39;&quot;</span>
    <span class="k">assert</span> <span class="n">a1</span> <span class="o">!=</span> <span class="n">a2</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">virtual_atoms</span><span class="p">(</span>
        <span class="n">pos1</span><span class="p">)[</span><span class="n">a1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bg</span><span class="o">.</span><span class="n">virtual_atoms</span><span class="p">(</span><span class="n">pos2</span><span class="p">)[</span><span class="n">a2</span><span class="p">])</span>
    <span class="c1"># if bg.element_length(bulge)==0:</span>
    <span class="c1">#    partner1 = bg.pairing_partner(pos1)</span>
    <span class="c1">#    partner2 = bg.pairing_partner(pos2)</span>
    <span class="c1">#    dist2 = cuv.magnitude(bg.virtual_atoms(pos1)[a2]-bg.virtual_atoms(pos2)[a1])</span>
    <span class="c1">#    dist3 = cuv.magnitude(bg.virtual_atoms(partner1)[a1]-bg.virtual_atoms(partner2)[a2])</span>
    <span class="c1">#    dist4 = cuv.magnitude(bg.virtual_atoms(partner1)[a2]-bg.virtual_atoms(partner2)[a1])</span>
    <span class="c1">#    assert dist &lt; dist2, &quot;{} ({} nts): {} !&lt; {}&quot;.format(bulge, bg.element_length(bulge), dist, dist2)</span>
    <span class="c1">#    assert dist &lt; dist3, &quot;{} ({} nts): {} !&lt; {}&quot;.format(bulge, bg.element_length(bulge), dist, dist3)</span>
    <span class="c1">#    assert dist &lt; dist4, &quot;{} ({} nts): {} !&lt; {}&quot;.format(bulge, bg.element_length(bulge), dist, dist4)</span>
    <span class="k">return</span> <span class="n">dist</span></div>


<div class="viewcode-block" id="add_virtual_residues"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.add_virtual_residues">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">add_virtual_residues</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create all of the virtual residues and the associated</span>
<span class="sd">    bases and inverses for the given stem.</span>

<span class="sd">    .. note::</span>
<span class="sd">       This is a low-level function used if only the virtual residues of a single</span>
<span class="sd">       stems should be added. To add the virtual residues for all stems, use</span>
<span class="sd">       `cg.add_all_virtual_residues`</span>

<span class="sd">    :param bg: The CoarseGrainRNA bulge graph containing the stem</span>
<span class="sd">    :param element: The name of the stem to be included</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_add_stem_virtual_residues</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_add_loop_virtual_residues</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_add_loop_virtual_residues</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cg</span><span class="o">.</span><span class="n">chains</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;No virtual residues added for </span><span class="si">%s</span><span class="s2">, because no pdb chain present&quot;</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">resid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cg</span><span class="o">.</span><span class="n">define_residue_num_iterator</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">seq_ids</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">global_coords</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">chains</span><span class="p">[</span><span class="n">resid</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">resid</span><span class="o">.</span><span class="n">resid</span><span class="p">][</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Added virtual residue position for residue </span><span class="si">%s</span><span class="s2"> will be &quot;</span>
                      <span class="s2">&quot;inaccurate, because no C1&#39; is present. Atoms are </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">resid</span><span class="p">,</span>
                      <span class="nb">list</span><span class="p">(</span><span class="n">cg</span><span class="o">.</span><span class="n">chains</span><span class="p">[</span><span class="n">resid</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">resid</span><span class="o">.</span><span class="n">resid</span><span class="p">]</span><span class="o">.</span><span class="n">child_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">p</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">cg</span><span class="o">.</span><span class="n">chains</span><span class="p">[</span><span class="n">resid</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">resid</span><span class="o">.</span><span class="n">resid</span><span class="p">]:</span>
                <span class="n">p</span><span class="o">+=</span><span class="n">atom</span><span class="o">.</span><span class="n">coord</span>
                <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">global_coords</span> <span class="o">=</span> <span class="n">p</span><span class="o">/</span><span class="n">i</span>

        <span class="n">origin</span><span class="p">,</span> <span class="n">basis</span> <span class="o">=</span> <span class="n">element_coord_system</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>
        <span class="n">element_coords</span> <span class="o">=</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span>
            <span class="n">global_coords</span> <span class="o">-</span> <span class="n">origin</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span>
        <span class="n">cg</span><span class="o">.</span><span class="n">vposs</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">element_coords</span>


<span class="k">def</span> <span class="nf">_add_stem_virtual_residues</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">stem</span><span class="p">):</span>
    <span class="n">stem_vec</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">get_direction</span><span class="p">(</span><span class="n">stem</span><span class="p">)</span>
    <span class="n">twist_vec</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">get_twists</span><span class="p">(</span><span class="n">stem</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">stem</span> <span class="ow">in</span> <span class="n">bg</span><span class="o">.</span><span class="n">bases</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">stem_vec</span><span class="p">,</span> <span class="n">bg</span><span class="o">.</span><span class="n">bases</span><span class="p">[</span><span class="n">stem</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">twist_vec</span><span class="p">,</span> <span class="n">bg</span><span class="o">.</span><span class="n">bases</span><span class="p">[</span><span class="n">stem</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">stem_inv</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">stem_invs</span><span class="p">[</span><span class="n">stem</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stem_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">stem_vec</span><span class="p">,</span> <span class="n">twist_vec</span><span class="p">)</span>
        <span class="n">stem_inv</span> <span class="o">=</span> <span class="n">nl</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">stem_basis</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
        <span class="n">bg</span><span class="o">.</span><span class="n">bases</span><span class="p">[</span><span class="n">stem</span><span class="p">]</span> <span class="o">=</span> <span class="n">stem_basis</span>
        <span class="n">bg</span><span class="o">.</span><span class="n">stem_invs</span><span class="p">[</span><span class="n">stem</span><span class="p">]</span> <span class="o">=</span> <span class="n">stem_inv</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">stem_length</span><span class="p">(</span><span class="n">stem</span><span class="p">)):</span>
        <span class="n">vpos</span> <span class="o">=</span> <span class="n">virtual_res_3d_pos</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">stem</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">stem_inv</span><span class="o">=</span><span class="n">stem_inv</span><span class="p">)</span>
        <span class="n">vbasis</span> <span class="o">=</span> <span class="n">virtual_res_basis</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">stem</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">vec</span><span class="o">=</span><span class="n">vpos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">vinv</span> <span class="o">=</span> <span class="n">nl</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">vbasis</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>

        <span class="n">bg</span><span class="o">.</span><span class="n">vposs</span><span class="p">[</span><span class="n">stem</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vpos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">bg</span><span class="o">.</span><span class="n">vvecs</span><span class="p">[</span><span class="n">stem</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vpos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">bg</span><span class="o">.</span><span class="n">v3dposs</span><span class="p">[</span><span class="n">stem</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vpos</span>
        <span class="n">bg</span><span class="o">.</span><span class="n">vbases</span><span class="p">[</span><span class="n">stem</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vbasis</span>
        <span class="n">bg</span><span class="o">.</span><span class="n">vinvs</span><span class="p">[</span><span class="n">stem</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vinv</span>


<div class="viewcode-block" id="stem_vres_reference_atoms"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.stem_vres_reference_atoms">[docs]</a><span class="k">def</span> <span class="nf">stem_vres_reference_atoms</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate the position of each atom in the reference of the</span>
<span class="sd">    stem and virtual residue.</span>

<span class="sd">    :param bg: The BulgeGraph</span>
<span class="sd">    :param s: The stem identifier</span>
<span class="sd">    :param i: The i&#39;th base-pair in the stem</span>

<span class="sd">    :return (origin, basis, [dict(atoms), dict(atoms)])</span>
<span class="sd">        The origin of the coordinate system (vpos)</span>
<span class="sd">        The basis of the virtual residue</span>
<span class="sd">        Two dictionaries containing the positions of each atom in the coordinate system of the virtual residue</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(),</span> <span class="nb">dict</span><span class="p">()]</span>
    <span class="p">(</span><span class="n">vpos</span><span class="p">,</span> <span class="n">vvec</span><span class="p">,</span> <span class="n">vvec_l</span><span class="p">,</span> <span class="n">vvec_r</span><span class="p">)</span> <span class="o">=</span> <span class="n">virtual_res_3d_pos</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="c1">#vec1 = cuv.normalize(bg.coords[s][1] - bg.coords[s][0])</span>
    <span class="c1">#vec2 = cuv.normalize(vvec)</span>
    <span class="n">stem_direction</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">twist</span> <span class="o">=</span> <span class="n">vvec</span>

    <span class="n">basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">stem_direction</span><span class="p">,</span> <span class="n">twist</span><span class="p">)</span>

    <span class="n">residue_ids</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">get_resseqs</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">seq_ids</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">strand</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">res_id</span> <span class="o">=</span> <span class="n">residue_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res_id</span> <span class="o">=</span> <span class="n">residue_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">ftup</span><span class="o">.</span><span class="n">all_rna_atoms</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">chains</span><span class="p">[</span><span class="n">res_id</span><span class="o">.</span><span class="n">chain</span><span class="p">][</span><span class="n">res_id</span><span class="o">.</span><span class="n">resid</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_c</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">vpos</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Atom </span><span class="si">%s</span><span class="s2"> has coords </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">new_c</span><span class="p">)</span>
                <span class="n">coords</span><span class="p">[</span><span class="n">strand</span><span class="p">][</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_c</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">vpos</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span></div>


<div class="viewcode-block" id="bounding_boxes"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.bounding_boxes">[docs]</a><span class="k">def</span> <span class="nf">bounding_boxes</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Return the bounding boxes of the two nucleotides at the</span>
<span class="sd">    i&#39;th position on the stem.</span>

<span class="sd">    :param bg: A BulgeGraph where bg.chains is not None</span>
<span class="sd">    :param s: The stem identifier</span>
<span class="sd">    :param i: The i&#39;th base-pair in the stem</span>

<span class="sd">    :return: (origin, basis, [(c1, c2), (c1, c2)]) The bases</span>
<span class="sd">             and the corners defining the bounding box</span>
<span class="sd">             of the two nucleotides</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="p">(</span><span class="n">vpos</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">atoms</span><span class="p">)</span> <span class="o">=</span> <span class="n">stem_vres_reference_atoms</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">corners</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">min_c</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10000.</span><span class="p">,</span> <span class="mf">10000.</span><span class="p">,</span> <span class="mf">10000.</span><span class="p">]</span>
        <span class="n">max_c</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">10000.</span><span class="p">,</span> <span class="o">-</span><span class="mf">10000.</span><span class="p">,</span> <span class="o">-</span><span class="mf">10000.</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">min_c</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">min_c</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">atom</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">max_c</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_c</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">atom</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">min_c</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">max_c</span>
        <span class="n">corners</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">)]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">vpos</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">corners</span><span class="p">)</span></div>


<div class="viewcode-block" id="virtual_residue_atoms"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.virtual_residue_atoms">[docs]</a><span class="k">def</span> <span class="nf">virtual_residue_atoms</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">strand</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Return the atoms for the virtual residue.</span>

<span class="sd">    :param bg: The BulgeGraph</span>
<span class="sd">    :param s: The stem</span>
<span class="sd">    :param i: The virtual residue number</span>
<span class="sd">    :param strand: The strand for which to get the virtual atoms</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    if vpos == None or vvec == None:</span>
<span class="sd">        (vpos, vvec, vvec_l, vvec_r) = virtual_res_3d_pos(bg, s, i)</span>
<span class="sd">    if basis == None:</span>
<span class="sd">        basis = virtual_res_basis(bg, s, i, vvec).transpose()</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Expected stem (not single-stranded RNA element), got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

    <span class="n">glob_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">bg</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">glob_pos</span> <span class="o">=</span> <span class="n">glob_pos</span><span class="p">[</span><span class="n">strand</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">bg</span><span class="o">.</span><span class="n">virtual_atoms</span><span class="p">(</span><span class="n">glob_pos</span><span class="p">)</span></div>


<div class="viewcode-block" id="calc_R"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.calc_R">[docs]</a><span class="k">def</span> <span class="nf">calc_R</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; calculate the distance of each 2D points from the center (xc, yc) &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">p</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xc</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">yc</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="f_2"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.f_2">[docs]</a><span class="k">def</span> <span class="nf">f_2</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; calculate the algebraic distance between the data points and the mean</span>
<span class="sd">        circle centered at c=(xc, yc) &quot;&quot;&quot;</span>
    <span class="n">Ri</span> <span class="o">=</span> <span class="n">calc_R</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Ri</span> <span class="o">-</span> <span class="n">Ri</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span></div>


<div class="viewcode-block" id="circle_fit"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.circle_fit">[docs]</a><span class="k">def</span> <span class="nf">circle_fit</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">x_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="n">u</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">x_m</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">y_m</span>

    <span class="c1"># linear system defining the center (uc, vc) in reduced coordinates:</span>
    <span class="c1">#    Suu * uc +  Suv * vc = (Suuu + Suvv)/2</span>
    <span class="c1">#    Suv * uc +  Svv * vc = (Suuv + Svvv)/2</span>
    <span class="n">Suv</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">Suu</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">u</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">Svv</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">Suuv</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">u</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">Suvv</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">v</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">Suuu</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">u</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">Svvv</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Solving the linear system</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">Suu</span><span class="p">,</span> <span class="n">Suv</span><span class="p">],</span> <span class="p">[</span><span class="n">Suv</span><span class="p">,</span> <span class="n">Svv</span><span class="p">]])</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Suuu</span> <span class="o">+</span> <span class="n">Suvv</span><span class="p">,</span> <span class="n">Svvv</span> <span class="o">+</span> <span class="n">Suuv</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="n">uc</span><span class="p">,</span> <span class="n">vc</span> <span class="o">=</span> <span class="n">nl</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>

    <span class="n">xc_1</span> <span class="o">=</span> <span class="n">x_m</span> <span class="o">+</span> <span class="n">uc</span>
    <span class="n">yc_1</span> <span class="o">=</span> <span class="n">y_m</span> <span class="o">+</span> <span class="n">vc</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">xc_1</span><span class="p">,</span> <span class="n">yc_1</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Ri_1     = sqrt((x-xc_1)**2 + (y-yc_1)**2)</span>
<span class="sd">    R_1      = mean(Ri_1)</span>
<span class="sd">    residu_1 = sum((Ri_1-R_1)**2)</span>

<span class="sd">    return (xc_1, yc_1, R_1)</span>
<span class="sd">    &#39;&#39;&#39;</span></div>


<div class="viewcode-block" id="circle_error"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.circle_error">[docs]</a><span class="k">def</span> <span class="nf">circle_error</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="n">f_2</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">e</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">])</span></div>


<div class="viewcode-block" id="f_3"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.f_3">[docs]</a><span class="k">def</span> <span class="nf">f_3</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">est</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; calculate the optimal circle for the points (p) projected onto</span>
<span class="sd">    the plane orthogonal to v &quot;&quot;&quot;</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
    <span class="n">new_points</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">new_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>

    <span class="c1">#center_2, ier=so.leastsq(f_2, center_estimate,args=p)</span>
    <span class="n">center_2</span> <span class="o">=</span> <span class="n">circle_fit</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">f_2</span><span class="p">(</span><span class="n">center_2</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span></div>


<div class="viewcode-block" id="fit_circle"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.fit_circle">[docs]</a><span class="k">def</span> <span class="nf">fit_circle</span><span class="p">(</span><span class="n">mids</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">start_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate the projection of points on the plane normal to</span>
<span class="sd">    vec and fit a circle to them.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">v1</span><span class="p">,</span> <span class="n">ier</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">leastsq</span><span class="p">(</span><span class="n">f_3</span><span class="p">,</span> <span class="n">mids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                             <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">mids</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]))</span>

    <span class="n">basis1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>

    <span class="n">points1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">basis1</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">start_pos1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">start_pos</span><span class="p">,</span> <span class="n">basis1</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span>
    <span class="n">end_pos1</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">end_pos</span><span class="p">,</span> <span class="n">basis1</span><span class="p">,</span> <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">)</span>

    <span class="n">center_5</span> <span class="o">=</span> <span class="n">circle_fit</span><span class="p">(</span><span class="n">points1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])</span>

    <span class="n">mids_stem_basis</span> <span class="o">=</span> <span class="p">[[</span><span class="n">start_pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center_5</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center_5</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                       <span class="p">[</span><span class="n">end_pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center_5</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center_5</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
    <span class="n">mids_standard_basis</span> <span class="o">=</span> <span class="n">cuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mids_stem_basis</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                           <span class="n">cuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">,</span> <span class="n">basis1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    # works!</span>
<span class="sd">    mids_stem_basis = [[nmids[0][0], center_4[0], center_4[1]],</span>
<span class="sd">                       [nmids[1][0], center_4[0], center_4[1]]]</span>
<span class="sd">    mids_standard_basis = cuv.change_basis(np.array(mids_stem_basis).T,</span>
<span class="sd">                                           cuv.standard_basis,</span>
<span class="sd">                                           basis).T</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">mids_standard_basis</span></div>


<div class="viewcode-block" id="extract_define_residues"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.extract_define_residues">[docs]</a><span class="k">def</span> <span class="nf">extract_define_residues</span><span class="p">(</span><span class="n">define</span><span class="p">,</span> <span class="n">chain</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Extract the residues in the define and return them as a new chain.&#39;&#39;&#39;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">Chain</span><span class="o">.</span><span class="n">Chain</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="n">ranges</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">define</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">c</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">chain</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">c</span></div>


<div class="viewcode-block" id="add_stem_information_from_pdb_chains"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.add_stem_information_from_pdb_chains">[docs]</a><span class="k">def</span> <span class="nf">add_stem_information_from_pdb_chains</span><span class="p">(</span><span class="n">cg</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get the 3D information of the stems.</span>

<span class="sd">    Output the mid points of the helices as well as the &#39;twist&#39; vectors</span>
<span class="sd">    which describe the projection of the (ca - mids) vectors onto</span>
<span class="sd">    the plane perpendicular to the axis of the helix.</span>

<span class="sd">    Add all of this information to the BulgeGraph data structure.</span>

<span class="sd">    :param bg: The BulgeGraph.</span>
<span class="sd">    :param chain: The Bio.PDB chain representation of the 3D structure.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">new_chains</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">cg</span><span class="o">.</span><span class="n">chains</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">new_chains</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ftup</span><span class="o">.</span><span class="n">rename_rosetta_atoms</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cg</span><span class="o">.</span><span class="n">defines</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span>
            <span class="n">coords</span><span class="p">,</span> <span class="n">twists</span> <span class="o">=</span> <span class="n">stem_from_chains</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">new_chains</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
            <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span>
            <span class="n">stem_dir</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cg</span><span class="o">.</span><span class="n">twists</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">twists</span>
            <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">stem_dir</span><span class="p">,</span> <span class="n">twists</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">10</span>
            <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">stem_dir</span><span class="p">,</span> <span class="n">twists</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">10</span></div>
            <span class="c1">#cg.sampled[d] = [cg.name] + cg.defines[d]</span>


<div class="viewcode-block" id="get_incomplete_elements"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_incomplete_elements">[docs]</a><span class="k">def</span> <span class="nf">get_incomplete_elements</span><span class="p">(</span><span class="n">cg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get an estimated list of cg-elements which have missing residues in the PDB.</span>

<span class="sd">    One of many problems with PDB data are residues, for which no</span>
<span class="sd">    coordinates could be determined experimentally. This function gives</span>
<span class="sd">    an estimated list of cg-elements, which are affected by missing residues.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">incomplete</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">cg</span><span class="o">.</span><span class="n">defines</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cg</span><span class="o">.</span><span class="n">define_range_iterator</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">adjacent</span><span class="o">=</span><span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;s&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cg</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">!=</span> <span class="n">cg</span><span class="o">.</span><span class="n">seq</span><span class="o">.</span><span class="n">with_missing</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]]:</span>
                <span class="n">incomplete</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">incomplete</span></div>


<div class="viewcode-block" id="add_loop_information_from_pdb_chains"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.add_loop_information_from_pdb_chains">[docs]</a><span class="k">def</span> <span class="nf">add_loop_information_from_pdb_chains</span><span class="p">(</span><span class="n">bg</span><span class="p">):</span>
    <span class="n">seq_ids</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1">#log.info(&quot;add_loop_information_from_pdb_chains called&quot;)</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">hloop_iterator</span><span class="p">(),</span> <span class="n">bg</span><span class="o">.</span><span class="n">floop_iterator</span><span class="p">(),</span> <span class="n">bg</span><span class="o">.</span><span class="n">tloop_iterator</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bg</span><span class="o">.</span><span class="n">defines</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span>

        <span class="n">edges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Odd case where there are no stems in the structure</span>
            <span class="c1"># We should find the furthest distance from the first</span>
            <span class="c1"># nucleotide</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;add_loop_information_from_pdb_chain: </span><span class="si">{}</span><span class="s2"> has no neighbor&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>

            <span class="n">chain_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">chain</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">bg</span><span class="o">.</span><span class="n">get_resseqs</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">y</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">chain_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">c</span><span class="p">,</span> <span class="o">=</span> <span class="n">chain_ids</span>
            <span class="n">chain</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">chains</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>

            <span class="n">first_res</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">chain</span><span class="o">.</span><span class="n">get_residues</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">REFERENCE_CATOM</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                    <span class="n">first_res</span> <span class="o">=</span> <span class="n">res</span>
                    <span class="k">break</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">start_point</span> <span class="o">=</span> <span class="n">first_res</span><span class="p">[</span><span class="n">REFERENCE_CATOM</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">first_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">CgConstructionError</span><span class="p">(</span><span class="s2">&quot;The PDB chain does not contain any </span><span class="si">{}</span><span class="s2"> atom (despite containing </span><span class="si">{}</span><span class="s2"> residues).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">REFERENCE_CATOM</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">get_residues</span><span class="p">()))))</span>
                    <span class="k">with</span> <span class="n">log_to_exception</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s2">&quot;The chain&#39;s last residue only has the following atoms: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">child_list</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">e</span>
            <span class="n">centroid</span> <span class="o">=</span> <span class="n">get_furthest_c_alpha</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span>
                                            <span class="n">first_res</span><span class="p">[</span><span class="n">REFERENCE_CATOM</span><span class="p">]</span><span class="o">.</span><span class="n">get_vector</span><span class="p">(</span>
                                            <span class="p">)</span><span class="o">.</span><span class="n">get_array</span><span class="p">(),</span>
                                            <span class="n">d</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">chain_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">chain</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">bg</span><span class="o">.</span><span class="n">get_resseqs</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">y</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">chain_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">c</span><span class="p">,</span> <span class="o">=</span> <span class="n">chain_ids</span>
            <span class="n">chain</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">chains</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>

            <span class="n">s1</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">s1d</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">s1</span><span class="p">]</span>
            <span class="n">bd</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>

            <span class="p">(</span><span class="n">s1b</span><span class="p">,</span> <span class="n">s2b</span><span class="p">)</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">get_sides</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

            <span class="n">mids</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s1</span><span class="p">]</span>
            <span class="n">start_point</span> <span class="o">=</span> <span class="n">mids</span><span class="p">[</span><span class="n">s1b</span><span class="p">]</span>
            <span class="c1">#centroid = get_bulge_centroid(chain, bd)</span>

            <span class="n">centroid</span> <span class="o">=</span> <span class="n">get_furthest_c_alpha</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">mids</span><span class="p">[</span><span class="n">s1b</span><span class="p">],</span> <span class="n">d</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">centroid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No end found for loop </span><span class="si">%s</span><span class="s2">... using the end of stem </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">s1</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">centroid</span> <span class="o">=</span> <span class="n">mids</span><span class="p">[</span><span class="n">s1b</span><span class="p">]</span>

        <span class="k">assert</span> <span class="n">start_point</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">centroid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">bg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_point</span><span class="p">,</span> <span class="n">centroid</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_add_loop_vres</span><span class="p">(</span><span class="n">cg</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cg</span><span class="o">.</span><span class="n">defines</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span>  <span class="c1"># fifeprime only-cgs have no twists</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding virtual residues&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">cg</span><span class="o">.</span><span class="n">defines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">add_virtual_residues</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not add virtual residues from PDB for </span><span class="si">%s</span><span class="s2">, elem </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span>



<div class="viewcode-block" id="cylinder_works"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.cylinder_works">[docs]</a><span class="k">def</span> <span class="nf">cylinder_works</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">cylinders_to_stems</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mf">4.</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Check if all of these points are inside the cylinder.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">tv</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">tv</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>

    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">cylinders_to_stems</span><span class="p">[</span><span class="n">c</span><span class="p">]:</span>
        <span class="n">points</span> <span class="o">+=</span> <span class="p">[</span><span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="n">datamean</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">uu</span><span class="p">,</span> <span class="n">dd</span><span class="p">,</span> <span class="n">vv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">datamean</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">vv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">data</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">datamean</span>

    <span class="n">dist_vec</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">((</span><span class="n">a</span> <span class="o">-</span> <span class="n">p</span><span class="p">),</span> <span class="n">n</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span> <span class="o">*</span> <span class="n">n</span> <span class="c1"># pylint: disable=invalid-sequence-index</span>
    <span class="n">mags</span> <span class="o">=</span> <span class="p">[</span><span class="n">ftuv</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">dist_vec</span><span class="p">]</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    linepts = vv[0] * np.mgrid[-7:7:2j][:, np.newaxis]</span>
<span class="sd">    linepts += datamean</span>


<span class="sd">    import matplotlib.pyplot as plt</span>
<span class="sd">    import mpl_toolkits.mplot3d as m3d</span>

<span class="sd">    ax = m3d.Axes3D(plt.figure())</span>
<span class="sd">    ax.scatter3D(*data.T)</span>
<span class="sd">    ax.plot3D(*linepts.T)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">mags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="get_encompassing_cylinders"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_encompassing_cylinders">[docs]</a><span class="k">def</span> <span class="nf">get_encompassing_cylinders</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">6.</span><span class="p">):</span>
    <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># the stems_in_cylinders dictionary will be indexed by stem name and contain</span>
    <span class="c1"># the number of the cylinder it contains</span>
    <span class="c1">#stems_to_cylinders = {&#39;s0&#39;: 0}</span>
    <span class="n">stems_to_cylinders</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">cylinders_to_stems</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="c1">#cylinders_to_stems = {0: [&#39;s0&#39;]}</span>

    <span class="c1"># the first cylinder is equal to the first stem</span>
    <span class="c1">#cylinders = {0: cg.coords[&#39;s0&#39;]}</span>
    <span class="n">to_visit</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">cg</span><span class="o">.</span><span class="n">defines</span><span class="o">.</span><span class="n">keys</span><span class="p">()))]</span>

    <span class="n">cylinder_counter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="n">to_visit</span><span class="p">:</span>
        <span class="n">tv</span> <span class="o">=</span> <span class="n">to_visit</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tv</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">cg</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">tv</span><span class="p">]:</span>
            <span class="n">to_visit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="c1"># not interested in non- stem, multiloop or interior loop elements</span>
        <span class="k">if</span> <span class="n">tv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;s&#39;</span> <span class="ow">and</span> <span class="n">tv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;m&#39;</span> <span class="ow">and</span> <span class="n">tv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1">#cylinders_to_check = set(cylinders_to_stems.keys())</span>
        <span class="n">cylinders_to_check</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># find which cylinders we need to check</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">cg</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">tv</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">stems_to_cylinders</span><span class="p">:</span>
                <span class="n">cylinders_to_check</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">stems_to_cylinders</span><span class="p">[</span><span class="n">e</span><span class="p">])</span>

        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cylinders_to_check</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="nb">sum</span><span class="p">([</span><span class="n">cg</span><span class="o">.</span><span class="n">stem_length</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cylinders_to_stems</span><span class="p">[</span><span class="n">x</span><span class="p">]])):</span>
            <span class="c1"># the new node will definitely be at the end of the cylinder</span>
            <span class="c1"># print &quot;checking...:&quot;, c, tv</span>
            <span class="k">if</span> <span class="n">cylinder_works</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">cylinders_to_stems</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
                <span class="n">cylinders_to_stems</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tv</span><span class="p">]</span>
                <span class="n">stems_to_cylinders</span><span class="p">[</span><span class="n">tv</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="c1"># no appropriately sized cylinder has been found so we</span>
            <span class="c1"># just create new one containing just this stem</span>
            <span class="n">cylinder_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">cylinders_to_stems</span><span class="p">[</span><span class="n">cylinder_counter</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tv</span><span class="p">]</span>
            <span class="n">stems_to_cylinders</span><span class="p">[</span><span class="n">tv</span><span class="p">]</span> <span class="o">=</span> <span class="n">cylinder_counter</span>

    <span class="k">return</span> <span class="n">cylinders_to_stems</span></div>


<div class="viewcode-block" id="element_coord_system"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.element_coord_system">[docs]</a><span class="k">def</span> <span class="nf">element_coord_system</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get a coordinate system for a particular coarse grain element.</span>

<span class="sd">    If an element has an axis vector, a, twist vectors t1 and t2,</span>
<span class="sd">    then the coordinate system will be a normalized version</span>
<span class="sd">    of the axis a, the second, v2,  will be equal to norm((t1 + t2) / 2.)</span>

<span class="sd">    And the third will be equal to a x v2.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">vec_axis</span> <span class="o">=</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">twists</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">get_twists</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="n">mid_twist</span> <span class="o">=</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">twists</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">twists</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vec_axis</span><span class="p">,</span> <span class="n">twists</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">**-</span> \
        <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vec_axis</span><span class="p">,</span> <span class="n">twists</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vec_axis</span><span class="p">,</span> <span class="n">twists</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">10</span>
    <span class="k">return</span> <span class="p">(((</span><span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">),</span>
            <span class="n">ftuv</span><span class="o">.</span><span class="n">create_orthonormal_basis</span><span class="p">(</span><span class="n">vec_axis</span><span class="p">,</span> <span class="n">mid_twist</span><span class="p">))</span></div>


<div class="viewcode-block" id="virtual_atoms"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.virtual_atoms">[docs]</a><span class="k">def</span> <span class="nf">virtual_atoms</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">given_atom_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sidechain</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get a list of virtual atoms for this structure.</span>

<span class="sd">    :param cg: The coarse grain structure.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">VirtualAtomsLookup</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">given_atom_names</span><span class="p">,</span> <span class="n">sidechain</span><span class="p">)</span></div>


<span class="c1"># Module-level var used for caching.</span>
<span class="n">_average_atom_positions</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="VirtualAtomsLookup"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.VirtualAtomsLookup">[docs]</a><span class="k">class</span> <span class="nc">VirtualAtomsLookup</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An object with a dict-like interface that calculates the virtual atom positions on demand.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cg</span><span class="p">,</span> <span class="n">given_atom_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sidechain</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param cg: The coarse grain structure, for which the virtual atoms are generated.</span>

<span class="sd">        ..note ::</span>
<span class="sd">            If cg is modified, new virtual atom positions are calculated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cg</span> <span class="o">=</span> <span class="n">cg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">given_atom_names</span> <span class="o">=</span> <span class="n">given_atom_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sidechain</span> <span class="o">=</span> <span class="n">sidechain</span>
    <span class="c1">#@profile</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :returns: A dictionary containing all atoms (as keys) and their</span>
<span class="sd">                  positions (as values) for the given residue.</span>
<span class="sd">        :param position: The position of the residue in the RNA (starting with 1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Find out the stem for which we have to calculate virtual atom positions</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">defines</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># For multiloops of length 0, value is []</span>
            <span class="k">elif</span> <span class="n">position</span> <span class="o">&gt;=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">position</span> <span class="o">&lt;=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem_for_element</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">position</span> <span class="o">&gt;=</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">position</span> <span class="o">&lt;=</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem_for_element</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;No return for pos </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
    <span class="c1">#@profile</span>

<div class="viewcode-block" id="VirtualAtomsLookup.keys"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.VirtualAtomsLookup.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">defines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">k</span></div>

    <span class="k">def</span> <span class="nf">_getitem_for_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :returns:   A dictionary containing all atoms (as keys) and</span>
<span class="sd">                    their positions (as values) for the given residue.</span>
<span class="sd">        :param d:   The coarse grained element (e.g. &quot;s1&quot;)</span>
<span class="sd">        :param pos: The position of the residue. It has to be in the element d!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">_average_atom_positions</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span>
            <span class="c1"># Use virtual residues for stems.</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem_for_stem</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_average_atom_positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;LOADING AV_ATOM_POS&quot;</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">pkgutil</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pkgutil</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span>
                <span class="s1">&#39;forgi&#39;</span><span class="p">,</span> <span class="s1">&#39;threedee/data/average_atom_positions.json&#39;</span><span class="p">)</span>
            <span class="n">_average_atom_positions</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using loaded av_atom_pos&quot;</span><span class="p">)</span>

        <span class="n">e_coords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">origin</span><span class="p">,</span> <span class="n">basis</span> <span class="o">=</span> <span class="n">element_coord_system</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># 0-length hairpin.</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;h&quot;</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Returning empty set of virtual atoms for 0-length hairpin&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">e_coords</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;for position </span><span class="si">{}</span><span class="s2"> in element </span><span class="si">{}</span><span class="s2"> with define </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">pos</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">d</span><span class="p">]))</span>
            <span class="k">raise</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;i&#39;</span> <span class="ow">or</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;m&#39;</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">connections</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="n">conn_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">connection_type</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conn_type</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">define_residue_num_iterator</span><span class="p">(</span><span class="n">d</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="n">pos</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">given_atom_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sidechain</span><span class="p">:</span>
                    <span class="c1"># Seq is now 1-based</span>
                    <span class="n">atom_names</span> <span class="o">=</span> <span class="p">(</span><span class="n">ftup</span><span class="o">.</span><span class="n">nonsidechain_atoms</span> <span class="o">+</span> <span class="p">[</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ftup</span><span class="o">.</span><span class="n">side_chain_atoms</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="n">r</span><span class="p">]]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">atom_names</span> <span class="o">=</span> <span class="n">ftup</span><span class="o">.</span><span class="n">nonsidechain_atoms</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">atom_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">given_atom_names</span>
            <span class="k">for</span> <span class="n">aname</span> <span class="ow">in</span> <span class="n">atom_names</span><span class="p">:</span>
                <span class="n">identifier</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                 <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                                     <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">get_node_dimensions</span><span class="p">(</span><span class="n">d</span><span class="p">))),</span>
                                                 <span class="n">conn_type</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">aname</span><span class="p">)</span>

                <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">aname</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">aname</span> <span class="o">=</span> <span class="n">aname</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">e_coords</span><span class="p">[</span><span class="n">aname</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span> <span class="o">+</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_average_atom_positions</span><span class="p">[</span><span class="n">identifier</span><span class="p">]),</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">,</span> <span class="n">basis</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ke</span><span class="p">:</span>
                    <span class="c1">#warnings.warn(&quot;KeyError in virtual_atoms. No coordinates found for: {}&quot;.format(ke))</span>
                    <span class="k">pass</span>
            <span class="k">return</span> <span class="n">e_coords</span>

    <span class="k">def</span> <span class="nf">_getitem_for_stem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;getitem_for_stem </span><span class="si">%s</span><span class="s2">, pos </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
        <span class="n">pos_in_stem</span><span class="p">,</span> <span class="n">side</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">stem_resn_to_stem_vres_side</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">residue</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">log_to_exception</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;position </span><span class="si">{}</span><span class="s2"> not in sequence </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">seq</span><span class="p">))</span>
            <span class="k">raise</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">given_atom_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sidechain</span><span class="p">:</span>
                <span class="n">atom_names</span> <span class="o">=</span> <span class="p">(</span><span class="n">ftup</span><span class="o">.</span><span class="n">nonsidechain_atoms</span> <span class="o">+</span>
                              <span class="n">ftup</span><span class="o">.</span><span class="n">side_chain_atoms</span><span class="p">[</span><span class="n">residue</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">atom_names</span> <span class="o">=</span> <span class="n">ftup</span><span class="o">.</span><span class="n">nonsidechain_atoms</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atom_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">given_atom_names</span>
        <span class="n">atom_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atom_coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">aname</span> <span class="ow">in</span> <span class="n">atom_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">aname</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
                <span class="n">aname_dash</span> <span class="o">=</span> <span class="n">aname</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aname_dash</span> <span class="o">=</span> <span class="n">aname</span>
            <span class="n">spos</span> <span class="o">=</span> <span class="n">ftus</span><span class="o">.</span><span class="n">avg_stem_vres_atom_coords</span><span class="p">[</span><span class="n">side</span><span class="p">][</span><span class="n">residue</span><span class="p">][</span><span class="n">aname_dash</span><span class="p">]</span>
            <span class="c1"># TODO: Maybe we can vectorize this and calculate pos from spos for all atoms of the residue at once.</span>
            <span class="n">atom_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aname</span><span class="p">)</span>
            <span class="n">atom_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spos</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># virtual_res_basis(self.cg, d, pos_in_stem)</span>
            <span class="n">vres_basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">vbases</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">pos_in_stem</span><span class="p">]</span>
            <span class="c1"># virtual_res_3d_pos(self.cg, d, pos_in_stem)[0]</span>
            <span class="n">vres_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">vposs</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">pos_in_stem</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">add_all_virtual_residues</span><span class="p">()</span>
            <span class="c1"># virtual_res_basis(self.cg, d, pos_in_stem)</span>
            <span class="n">vres_basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">vbases</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">pos_in_stem</span><span class="p">]</span>
            <span class="c1"># virtual_res_3d_pos(self.cg, d, pos_in_stem)[0]</span>
            <span class="n">vres_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">vposs</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">pos_in_stem</span><span class="p">]</span>

        <span class="n">atom_coords</span> <span class="o">=</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">change_basis_vectorized</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atom_coords</span><span class="p">),</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">,</span> <span class="n">vres_basis</span><span class="p">)</span> <span class="o">+</span> <span class="n">vres_pos</span>

        <span class="k">return</span> <span class="p">{</span><span class="n">aname</span><span class="p">:</span> <span class="n">coord</span> <span class="k">for</span> <span class="n">aname</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">atom_keys</span><span class="p">,</span> <span class="n">atom_coords</span><span class="p">)}</span></div>


<div class="viewcode-block" id="vres_to_global_coordinates"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.vres_to_global_coordinates">[docs]</a><span class="k">def</span> <span class="nf">vres_to_global_coordinates</span><span class="p">(</span><span class="n">vres_pos</span><span class="p">,</span> <span class="n">vres_basis</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span>
    <span class="n">newpos</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">v_pos</span> <span class="ow">in</span> <span class="n">positions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span><span class="n">v_pos</span><span class="p">,</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">standard_basis</span><span class="p">,</span> <span class="n">vres_basis</span><span class="p">)</span>
        <span class="n">newpos</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">vres_pos</span>
    <span class="k">return</span> <span class="n">newpos</span></div>


<div class="viewcode-block" id="element_distance"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.element_distance">[docs]</a><span class="k">def</span> <span class="nf">element_distance</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate the distance between the two closest points of these</span>
<span class="sd">    two elements.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">line_segment_distance</span><span class="p">(</span><span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">l1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                          <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">l1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                          <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">l2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                          <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">l2</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">vec_distance</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_basepair_center"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_basepair_center">[docs]</a><span class="k">def</span> <span class="nf">get_basepair_center</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The center of a basepair, as defined in doi: 10.1261/rna.305307</span>

<span class="sd">    :param pos: The number of one of the two pairing bases</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pos2</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">pairing_partner</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="n">seq1</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">seq2</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="n">pos2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C8&quot;</span><span class="p">],</span> <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C8&quot;</span><span class="p">],</span>
             <span class="s2">&quot;U&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C6&quot;</span><span class="p">],</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;C1&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;C6&quot;</span><span class="p">]}</span>
    <span class="n">va1</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">virtual_atoms</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="n">va2</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">virtual_atoms</span><span class="p">(</span><span class="n">pos2</span><span class="p">)</span>
    <span class="n">avpos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">[</span><span class="n">seq1</span><span class="p">]:</span>
            <span class="n">avpos</span> <span class="o">+=</span> <span class="n">va1</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">[</span><span class="n">seq2</span><span class="p">]:</span>
            <span class="n">avpos</span> <span class="o">+=</span> <span class="n">va2</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">va1</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">va2</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">raise</span>
    <span class="n">avpos</span> <span class="o">/=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">seq1</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">seq2</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">avpos</span></div>


<div class="viewcode-block" id="get_basepair_plane"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.utilities.graph_pdb.html#forgi.threedee.utilities.graph_pdb.get_basepair_plane">[docs]</a><span class="k">def</span> <span class="nf">get_basepair_plane</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The plane of the basepair, as defined in figure 13 of doi: 10.1261/rna.305307</span>

<span class="sd">    :param pos: The number of one of the two pairing bases</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pos2</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">pairing_partner</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="n">seq1</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">seq2</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="n">pos2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">va1</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">virtual_atoms</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="n">va2</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">virtual_atoms</span><span class="p">(</span><span class="n">pos2</span><span class="p">)</span>
    <span class="n">h_bonds</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;U&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;O4&quot;</span><span class="p">,</span> <span class="s2">&quot;N6&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N3&quot;</span><span class="p">,</span> <span class="s2">&quot;N1&quot;</span><span class="p">)],</span>
                     <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;N3&quot;</span><span class="p">,</span> <span class="s2">&quot;O6&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;O2&quot;</span><span class="p">,</span> <span class="s2">&quot;N1&quot;</span><span class="p">)]},</span>
               <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;U&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;N6&quot;</span><span class="p">,</span> <span class="s2">&quot;O4&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N1&quot;</span><span class="p">,</span> <span class="s2">&quot;N3&quot;</span><span class="p">)]},</span>
               <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;U&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;O6&quot;</span><span class="p">,</span> <span class="s2">&quot;N3&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N1&quot;</span><span class="p">,</span> <span class="s2">&quot;O2&quot;</span><span class="p">)],</span>
                     <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;O6&quot;</span><span class="p">,</span> <span class="s2">&quot;N4&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N1&quot;</span><span class="p">,</span> <span class="s2">&quot;N3&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N2&quot;</span><span class="p">,</span> <span class="s2">&quot;O2&quot;</span><span class="p">)]},</span>
               <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;N4&quot;</span><span class="p">,</span> <span class="s2">&quot;O6&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N3&quot;</span><span class="p">,</span> <span class="s2">&quot;N1&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;O2&quot;</span><span class="p">,</span> <span class="s2">&quot;N2&quot;</span><span class="p">)]}</span>
               <span class="p">}</span>
    <span class="c1">#print( seq1, seq2 )</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">hb</span> <span class="o">=</span> <span class="n">h_bonds</span><span class="p">[</span><span class="n">seq1</span><span class="p">][</span><span class="n">seq2</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="c1"># Non-canonical basepair</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Estimating plane from stem vector for &quot;</span>
                      <span class="s2">&quot; non-canonical basepair </span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> at positions&quot;</span>
                      <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seq1</span><span class="p">,</span> <span class="n">seq2</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">pos2</span><span class="p">))</span>
        <span class="c1"># ValueError, if cg.pairing_partner is buggy</span>
        <span class="n">stem</span><span class="p">,</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">nucleotides_to_elements</span><span class="p">([</span><span class="n">pos</span><span class="p">,</span> <span class="n">pos2</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">cg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plane</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">contribs</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">hb</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">left_1</span> <span class="o">=</span> <span class="n">va1</span><span class="p">[</span><span class="n">l1</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">left_2</span> <span class="o">=</span> <span class="n">va1</span><span class="p">[</span><span class="n">l2</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">right_1</span> <span class="o">=</span> <span class="n">va2</span><span class="p">[</span><span class="n">l1</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">right_2</span> <span class="o">=</span> <span class="n">va2</span><span class="p">[</span><span class="n">l2</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">add</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">right_1</span> <span class="o">-</span> <span class="n">left_1</span><span class="p">,</span> <span class="n">right_2</span> <span class="o">-</span> <span class="n">left_1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">plane</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)):</span>
                <span class="k">assert</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">plane</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span>
                                                                       <span class="s2">&quot; degrees&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seq1</span><span class="p">,</span> <span class="n">seq2</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">ftuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">plane</span><span class="p">))))</span>
            <span class="n">plane</span> <span class="o">+=</span> <span class="n">add</span>
            <span class="n">add</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">right_1</span> <span class="o">-</span> <span class="n">left_1</span><span class="p">,</span> <span class="n">left_2</span> <span class="o">-</span> <span class="n">right_1</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">plane</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span>
                                                                   <span class="s2">&quot; degrees&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seq1</span><span class="p">,</span> <span class="n">seq2</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">ftuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">plane</span><span class="p">))))</span>
            <span class="n">plane</span> <span class="o">+=</span> <span class="n">add</span>
            <span class="n">add</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">right_2</span> <span class="o">-</span> <span class="n">left_2</span><span class="p">,</span> <span class="n">right_2</span> <span class="o">-</span> <span class="n">left_1</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">plane</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span>
                                                                   <span class="s2">&quot; degrees&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seq1</span><span class="p">,</span> <span class="n">seq2</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">ftuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">plane</span><span class="p">))))</span>
            <span class="n">plane</span> <span class="o">+=</span> <span class="n">add</span>
            <span class="n">add</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">right_2</span> <span class="o">-</span> <span class="n">left_2</span><span class="p">,</span> <span class="n">left_2</span> <span class="o">-</span> <span class="n">right_1</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">plane</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span>
                                                                   <span class="s2">&quot; degrees&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seq1</span><span class="p">,</span> <span class="n">seq2</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">ftuv</span><span class="o">.</span><span class="n">vec_angle</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">plane</span><span class="p">))))</span>
            <span class="n">plane</span> <span class="o">+=</span> <span class="n">add</span>
        <span class="k">return</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span></div>
</pre></div>

      </div>
      <div class="bottomnav">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2016 Peter Kerpedjiev &lt;pkerp@tbi.univie.ac.at&gt;; 2015-2018 Bernhard Thiel &lt;thiel@tbi.univie.ac.at&gt;.
      Last updated on Feb 25, 2019.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.7.
    </div>
  </body>
</html>