
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>forgi.threedee.model.coarse_grain &mdash; forgi 0.4 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '0.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../../_static/theme_extras.js"></script>
    <link rel="top" title="forgi 0.4 documentation" href="../../../../index.html" />
    <link rel="up" title="forgi.threedee" href="../../threedee.html" /> 
  </head>
  <body role="document">
      <div class="header"><h1 class="heading"><a href="../../../../index.html">
          <span>forgi 0.4 documentation</span></a></h1>
      </div>
      <div class="topnav">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for forgi.threedee.model.coarse_grain</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ascii</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">chr</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="nb">hex</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span>
                      <span class="nb">map</span><span class="p">,</span> <span class="nb">next</span><span class="p">,</span> <span class="nb">oct</span><span class="p">,</span> <span class="nb">pow</span><span class="p">,</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">round</span><span class="p">,</span>
                      <span class="nb">str</span><span class="p">,</span> <span class="nb">super</span><span class="p">,</span> <span class="nb">zip</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">...graph</span> <span class="kn">import</span> <span class="n">bulge_graph</span> <span class="k">as</span> <span class="n">fgb</span>
<span class="kn">from</span> <span class="nn">..utilities</span> <span class="kn">import</span> <span class="n">graph_pdb</span> <span class="k">as</span> <span class="n">ftug</span>
<span class="kn">from</span> <span class="nn">..model</span> <span class="kn">import</span> <span class="n">stats</span> <span class="k">as</span> <span class="n">ftms</span>

<span class="kn">from</span> <span class="nn">...aux.k2n_standalone</span> <span class="kn">import</span> <span class="n">knotted2nested</span> <span class="k">as</span> <span class="n">cak</span>
<span class="kn">from</span> <span class="nn">..utilities</span> <span class="kn">import</span> <span class="n">mcannotate</span> <span class="k">as</span> <span class="n">ftum</span>
<span class="kn">from</span> <span class="nn">..utilities</span> <span class="kn">import</span> <span class="n">pdb</span> <span class="k">as</span> <span class="n">ftup</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">descriptors</span> <span class="k">as</span> <span class="n">ftud</span>
<span class="kn">from</span> <span class="nn">..utilities</span> <span class="kn">import</span> <span class="n">vector</span> <span class="k">as</span> <span class="n">ftuv</span>
<span class="kn">from</span> <span class="nn">...utilities</span> <span class="kn">import</span> <span class="n">debug</span> <span class="k">as</span> <span class="n">fud</span>
<span class="kn">from</span> <span class="nn">...utilities</span> <span class="kn">import</span> <span class="n">stuff</span> <span class="k">as</span> <span class="n">fus</span>
<span class="kn">from</span> <span class="nn">...utilities.observedDict</span> <span class="kn">import</span> <span class="n">observedDict</span>

<span class="kn">import</span> <span class="nn">Bio.PDB</span> <span class="kn">as</span> <span class="nn">bpdb</span>
<span class="kn">import</span> <span class="nn">collections</span> <span class="kn">as</span> <span class="nn">c</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.spatial</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="kn">as</span> <span class="nn">op</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span> <span class="kn">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span> <span class="kn">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">itertools</span> <span class="kn">as</span> <span class="nn">it</span>


<span class="k">try</span><span class="p">:</span>
  <span class="n">profile</span>  <span class="c1">#The @profile decorator from line_profiler (kernprof)</span>
<span class="k">except</span><span class="p">:</span>
<div class="viewcode-block" id="profile"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.profile">[docs]</a>  <span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> 
    <span class="k">return</span> <span class="n">x</span></div>

<div class="viewcode-block" id="remove_hetatm"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.remove_hetatm">[docs]</a><span class="k">def</span> <span class="nf">remove_hetatm</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Go through the lines of a pdb file and remove any which refer to a</span>
<span class="sd">    HETATM.</span>

<span class="sd">    :param lines: A an array of lines of text from a pdb file.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">new_lines</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;HETATM&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;5MU&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;5MU&#39;</span><span class="p">,</span> <span class="s1">&#39;  U&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;PSU&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;PSU&#39;</span><span class="p">,</span> <span class="s1">&#39;  U&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;5MC&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;5MC&#39;</span><span class="p">,</span> <span class="s1">&#39;  C&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;1MG&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;1MG&#39;</span><span class="p">,</span> <span class="s1">&#39;  G&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;H2U&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;H2U&#39;</span><span class="p">,</span> <span class="s1">&#39;  G&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
        
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;HETATM&#39;</span><span class="p">,</span> <span class="s1">&#39;ATOM  &#39;</span><span class="p">)</span>
        <span class="n">new_lines</span> <span class="o">+=</span> <span class="p">[</span><span class="n">line</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">new_lines</span></div>


<div class="viewcode-block" id="add_longrange_interactions"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.add_longrange_interactions">[docs]</a><span class="k">def</span> <span class="nf">add_longrange_interactions</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Iterate over the lines in an MC-Annotate file and add information</span>
<span class="sd">    about interactions between non-adjacent elements.</span>

<span class="sd">    :param cg: A CoarseGrainRNA structure</span>
<span class="sd">    :param lines: All the lines in an MC-Annotate file</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ftum</span><span class="o">.</span><span class="n">iterate_over_interactions</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="p">(</span><span class="n">from_chain</span><span class="p">,</span> <span class="n">from_base</span><span class="p">,</span> <span class="n">to_chain</span><span class="p">,</span> <span class="n">to_base</span><span class="p">)</span> <span class="o">=</span>  <span class="n">ftum</span><span class="o">.</span><span class="n">get_interacting_base_pairs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">seq_id1</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">seq_ids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ftum</span><span class="o">.</span><span class="n">parse_resid</span><span class="p">(</span><span class="n">from_base</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">seq_id2</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">seq_ids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ftum</span><span class="o">.</span><span class="n">parse_resid</span><span class="p">(</span><span class="n">to_base</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">node1</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">get_node_from_residue_num</span><span class="p">(</span><span class="n">seq_id1</span><span class="p">)</span>
        <span class="n">node2</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">get_node_from_residue_num</span><span class="p">(</span><span class="n">seq_id2</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">seq_id2</span> <span class="o">-</span> <span class="n">seq_id1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">node1</span> <span class="o">!=</span> <span class="n">node2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cg</span><span class="o">.</span><span class="n">has_connection</span><span class="p">(</span><span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">):</span>
            <span class="n">cg</span><span class="o">.</span><span class="n">longrange</span><span class="p">[</span><span class="n">node1</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node2</span><span class="p">)</span>
            <span class="n">cg</span><span class="o">.</span><span class="n">longrange</span><span class="p">[</span><span class="n">node2</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node1</span><span class="p">)</span></div>

<div class="viewcode-block" id="load_cg_from_pdb_in_dir"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.load_cg_from_pdb_in_dir">[docs]</a><span class="k">def</span> <span class="nf">load_cg_from_pdb_in_dir</span><span class="p">(</span><span class="n">pdb_filename</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">secondary_structure</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                            <span class="n">chain_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">remove_pseudoknots</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create the coarse grain model from a pdb file and store all</span>
<span class="sd">    of the intermediate files in the given directory.</span>

<span class="sd">    :param pdb_filename: The name of the pdb file to be coarseified</span>
<span class="sd">    :param output_dir: The name of the output directory</span>
<span class="sd">    :param secondary_structure: Specify a particular secondary structure</span>
<span class="sd">                                for this coarsification.</span>
<span class="sd">    :param chain_id: The id of the chain to create the CG model from</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">parser</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">PDBParser</span><span class="p">()</span>

    <span class="c1">#chain = ftup.load_structure(pdb_filename)</span>
    <span class="k">if</span> <span class="n">chain_id</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">chain</span> <span class="o">=</span> <span class="n">ftup</span><span class="o">.</span><span class="n">get_biggest_chain</span><span class="p">(</span><span class="n">pdb_filename</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="n">parser</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chain</span> <span class="o">=</span> <span class="n">ftup</span><span class="o">.</span><span class="n">get_particular_chain</span><span class="p">(</span><span class="n">pdb_filename</span><span class="p">,</span> <span class="n">chain_id</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="n">parser</span><span class="p">)</span>

    <span class="n">chain</span> <span class="o">=</span> <span class="n">ftup</span><span class="o">.</span><span class="n">rename_modified_ress</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="n">ftup</span><span class="o">.</span><span class="n">rename_rosetta_atoms</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="n">ftup</span><span class="o">.</span><span class="n">remove_hetatm</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>

    <span class="c1"># output the biggest RNA chain</span>
    <span class="n">pdb_base</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pdb_filename</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">pdb_base</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">chain</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">op</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;temp.pdb&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1"># TODO: the following should be changed to take the input parser</span>
        <span class="c1"># and use that to output the chain</span>
        <span class="n">ftup</span><span class="o">.</span><span class="n">output_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="n">pdb_base</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pdb_filename</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pdb_base</span> <span class="o">+=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">chain</span><span class="o">.</span><span class="n">id</span>

        <span class="n">cg</span> <span class="o">=</span> <span class="n">CoarseGrainRNA</span><span class="p">()</span>
        <span class="n">cg</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">pdb_base</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">get_list</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cg</span>

        <span class="c1"># first we annotate the 3D structure</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;MC-Annotate&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;temp.mcannotate&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f3</span><span class="p">:</span>
            <span class="n">f3</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># convert the mcannotate output into bpseq format</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">dotplot</span><span class="p">,</span> <span class="n">residue_map</span><span class="p">)</span> <span class="o">=</span> <span class="n">ftum</span><span class="o">.</span><span class="n">get_dotplot</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cg</span>

        <span class="c1"># f2 will store the dotbracket notation</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;temp.bpseq&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f2</span><span class="p">:</span>
            <span class="n">f2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dotplot</span><span class="p">)</span>
            <span class="n">f2</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="c1"># remove pseudoknots</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            p = sp.Popen([&#39;aux/k2n_standalone/knotted2nested.py&#39;, &#39;-f&#39;, &#39;bpseq&#39;, </span>
<span class="sd">                          &#39;-F&#39;, &#39;vienna&#39;, f2.name], stdout = sp.PIPE)</span>

<span class="sd">            out, err = p.communicate()</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="k">if</span> <span class="n">remove_pseudoknots</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">cak</span><span class="o">.</span><span class="n">k2n_main</span><span class="p">(</span><span class="n">f2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">input_format</span><span class="o">=</span><span class="s1">&#39;bpseq&#39;</span><span class="p">,</span>
                                   <span class="c1">#output_format = &#39;vienna&#39;,</span>
                                   <span class="n">output_format</span> <span class="o">=</span> <span class="s1">&#39;bpseq&#39;</span><span class="p">,</span>
                                   <span class="n">method</span> <span class="o">=</span> <span class="n">cak</span><span class="o">.</span><span class="n">DEFAULT_METHOD</span><span class="p">,</span>
                                   <span class="n">opt_method</span> <span class="o">=</span> <span class="n">cak</span><span class="o">.</span><span class="n">DEFAULT_OPT_METHOD</span><span class="p">,</span>
                                   <span class="n">verbose</span> <span class="o">=</span> <span class="n">cak</span><span class="o">.</span><span class="n">DEFAULT_VERBOSE</span><span class="p">,</span>
                                   <span class="n">removed</span><span class="o">=</span> <span class="n">cak</span><span class="o">.</span><span class="n">DEFAULT_REMOVED</span><span class="p">)</span>

                <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; Nested structure&#39;</span><span class="p">,</span> <span class="n">pdb_base</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">dotplot</span>
            <span class="c1">#(out, residue_map) = add_missing_nucleotides(out, residue_map)</span>

            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            if secondary_structure != &#39;&#39;:</span>
<span class="sd">                lines = out.split(&#39;\n&#39;)</span>

<span class="sd">                if len(secondary_structure) != len(lines[1].strip()):</span>
<span class="sd">                    print &gt;&gt;sys.stderr, &quot;The provided secondary structure \</span>
<span class="sd">                            does not match the length of the 3D structure&quot;</span>
<span class="sd">                    print &gt;&gt;sys.stderr, &quot;Sequence:&quot;, lines[1]</span>
<span class="sd">                    print &gt;&gt;sys.stderr, &quot;ss_struc:&quot;, secondary_structure</span>
<span class="sd">                    sys.exit(1)</span>

<span class="sd">                lines[-1] = secondary_structure</span>
<span class="sd">                out = &quot;\n&quot;.join(lines)</span>
<span class="sd">            &#39;&#39;&#39;</span>

            <span class="c1"># Add the 3D information about the starts and ends of the stems</span>
            <span class="c1"># and loops</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">bpdb</span><span class="o">.</span><span class="n">PDBParser</span><span class="p">()</span><span class="o">.</span><span class="n">get_structure</span><span class="p">(</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">chains</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">get_chains</span><span class="p">())</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chains</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No chains in the PDB file&quot;</span><span class="p">)</span>

                <span class="n">chain</span> <span class="o">=</span> <span class="n">chains</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1">#cg.from_fasta(out, dissolve_length_one_stems=1)</span>
            <span class="n">cg</span><span class="o">.</span><span class="n">from_bpseq_str</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dissolve_length_one_stems</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">cg</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">pdb_base</span>
            <span class="n">cg</span><span class="o">.</span><span class="n">seqids_from_residue_map</span><span class="p">(</span><span class="n">residue_map</span><span class="p">)</span>
            <span class="n">ftug</span><span class="o">.</span><span class="n">add_stem_information_from_pdb_chain</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">chain</span><span class="p">)</span>
            <span class="n">cg</span><span class="o">.</span><span class="n">add_bulge_coords_from_stems</span><span class="p">()</span>
            <span class="n">ftug</span><span class="o">.</span><span class="n">add_loop_information_from_pdb_chain</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">chain</span><span class="p">)</span>

            <span class="n">cg</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="n">chain</span>

            <span class="n">add_longrange_interactions</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;temp.cg&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f3</span><span class="p">:</span>
                <span class="n">f3</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cg</span><span class="o">.</span><span class="n">to_cg_string</span><span class="p">())</span>
                <span class="n">f3</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">cg</span>
    <span class="k">print</span> <span class="p">(</span><span class="s2">&quot;Uh oh... couldn&#39;t generate the coarse-grain structure.&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="k">print</span> <span class="p">(</span><span class="s2">&quot;Prepare for an incoming exception.&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span></div>

<div class="viewcode-block" id="load_cg_from_pdb"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.load_cg_from_pdb">[docs]</a><span class="k">def</span> <span class="nf">load_cg_from_pdb</span><span class="p">(</span><span class="n">pdb_filename</span><span class="p">,</span> <span class="n">secondary_structure</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                     <span class="n">intermediate_file_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">chain_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">remove_pseudoknots</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Load a coarse grain model from a PDB file, by extracing</span>
<span class="sd">    the bulge graph.</span>

<span class="sd">    :param pdb_filename: The filename of the 3D model</span>
<span class="sd">    :param secondary_structure: A dot-bracket string encoding the secondary</span>
<span class="sd">                                structure of this molecule</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">intermediate_file_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">intermediate_file_dir</span>

        <span class="n">cg</span> <span class="o">=</span> <span class="n">load_cg_from_pdb_in_dir</span><span class="p">(</span><span class="n">pdb_filename</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> 
                                     <span class="n">secondary_structure</span><span class="p">,</span> <span class="n">chain_id</span><span class="o">=</span><span class="n">chain_id</span><span class="p">,</span>
                                    <span class="n">remove_pseudoknots</span><span class="o">=</span><span class="n">remove_pseudoknots</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="n">parser</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">fus</span><span class="o">.</span><span class="n">make_temp_directory</span><span class="p">()</span> <span class="k">as</span> <span class="n">output_dir</span><span class="p">:</span>
            <span class="n">cg</span> <span class="o">=</span> <span class="n">load_cg_from_pdb_in_dir</span><span class="p">(</span><span class="n">pdb_filename</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> 
                                         <span class="n">secondary_structure</span><span class="p">,</span> <span class="n">chain_id</span> <span class="o">=</span> <span class="n">chain_id</span><span class="p">,</span>
                                        <span class="n">remove_pseudoknots</span><span class="o">=</span><span class="n">remove_pseudoknots</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="n">parser</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cg</span></div>

<span class="c1"># Deprecated. Use constructor instead</span>
<span class="sd">&quot;&quot;&quot;def from_file(cg_filename):</span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="sd">    Read a coarse-grain structure file.</span>

<span class="sd">    :param cg_filename: The filename.</span>
<span class="sd">    :return: A CoarseGrainRNA from a file.</span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="sd">    with open(cg_filename, &#39;r&#39;) as f:</span>
<span class="sd">        lines = &quot;&quot;.join(f.readlines())</span>

<span class="sd">        cg = CoarseGrainRNA()</span>
<span class="sd">        cg.from_cg_string(lines)</span>

<span class="sd">        return cg&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="from_pdb"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.from_pdb">[docs]</a><span class="k">def</span> <span class="nf">from_pdb</span><span class="p">(</span><span class="n">pdb_filename</span><span class="p">,</span> <span class="n">secondary_structure</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">intermediate_file_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
             <span class="n">chain_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">remove_pseudoknots</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">cg</span> <span class="o">=</span> <span class="n">load_cg_from_pdb</span><span class="p">(</span><span class="n">pdb_filename</span><span class="p">,</span> <span class="n">secondary_structure</span><span class="p">,</span> 
                          <span class="n">intermediate_file_dir</span><span class="p">,</span> <span class="n">chain_id</span><span class="o">=</span><span class="n">chain_id</span><span class="p">,</span>
                         <span class="n">remove_pseudoknots</span><span class="o">=</span><span class="n">remove_pseudoknots</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="n">parser</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cg</span></div>

<div class="viewcode-block" id="RnaMissing3dError"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.RnaMissing3dError">[docs]</a><span class="k">class</span> <span class="nc">RnaMissing3dError</span><span class="p">(</span><span class="ne">LookupError</span><span class="p">):</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="CoarseGrainRNA"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA">[docs]</a><span class="k">class</span> <span class="nc">CoarseGrainRNA</span><span class="p">(</span><span class="n">fgb</span><span class="o">.</span><span class="n">BulgeGraph</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A coarse grain model of RNA structure based on the</span>
<span class="sd">    bulge graph representation.</span>

<span class="sd">    Each stem is represented by four parameters (two endpoints)</span>
<span class="sd">    and two twist vetors pointing towards the centers of the base</span>
<span class="sd">    pairs at each end of the helix.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cg_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotbracket_str</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">seq</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Initialize the new structure.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CoarseGrainRNA</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">cg_file</span><span class="p">,</span> <span class="n">dotbracket_str</span><span class="p">,</span> <span class="n">seq</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_virtual_atom_cache</span><span class="o">=</span><span class="p">{}</span>
        <span class="c1">#: Keys are element identifiers (e.g.: &quot;s1&quot; or &quot;i3&quot;), values are 2-tuples of vectors</span>
        <span class="c1">#: The first value of stem coordinates corresponds to the start of the stem </span>
        <span class="c1">#: (the one with the lowest nucleotide number),</span>
        <span class="c1">#: The second value to the end of the stem.</span>
        <span class="c1">#: If the coordinates for an element change, the virtual atom and virtual residue </span>
        <span class="c1">#: coordinates are automatically invalidated.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">observedDict</span><span class="p">(</span><span class="n">on_change</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reset_vatom_cache</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">twists</span> <span class="o">=</span> <span class="n">observedDict</span><span class="p">(</span><span class="n">on_change</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reset_vatom_cache</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sampled</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        
        <span class="c1">#:The following 5 defaultdicts are cleared when coords or twists change.</span>
        <span class="c1">#: Global (carthesian) position of the virtual residue </span>
        <span class="c1">#: (=offset of the residue&#39;s coordinate-system)</span>
        <span class="c1">#: generated by self.add_all_virtual_residues()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vposs</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span> <span class="nb">dict</span> <span class="p">)</span>    
        <span class="c1">#: The coordinate system specific to each virtual residue </span>
        <span class="c1">#: (3x3 matrix, carthesian coordiantes; each row is one unit vector)</span>
        <span class="c1">#: generated by self.add_all_virtual_residues()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vbases</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span> <span class="nb">dict</span> <span class="p">)</span>
        <span class="c1">#: generated by self.add_all_virtual_residues()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vvecs</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span> <span class="nb">dict</span> <span class="p">)</span>
        <span class="c1">#: generated by self.add_all_virtual_residues()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v3dposs</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span> <span class="nb">dict</span> <span class="p">)</span>
        <span class="c1">#: generated by self.add_all_virtual_residues()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vinvs</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span> <span class="nb">dict</span> <span class="p">)</span>

        <span class="c1">#: A 3D vector. Used as hint, from what direction the Projection2D object </span>
        <span class="c1">#: should be generated in the default case.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_from</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">longrange</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span> <span class="nb">set</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="bp">None</span> <span class="c1">#the PDB chain if loaded from a PDB file</span>

        <span class="k">if</span> <span class="n">cg_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">cg_file</span><span class="p">)</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="CoarseGrainRNA.get_coord_str"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.get_coord_str">[docs]</a>    <span class="k">def</span> <span class="nf">get_coord_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Place the start and end coordinates of each stem into a string.</span>

<span class="sd">        The format is:</span>

<span class="sd">            coord s1 x1 y1 z1 x2 y2 z2</span>

<span class="sd">        Where s1 is the name of the stem, (x1,y1,z1) and (x2,y2,z2) are</span>
<span class="sd">        the two endpoints of the stem.</span>

<span class="sd">        :return: A string containing the coordinates for all of the stems.</span>
<span class="sd">        &#39;&#39;&#39;</span>
            
        <span class="n">out_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">]:</span> <span class="k">continue</span> <span class="c1">#Bulge coordinates are redundant. They can be deduced from the stem coordinates.</span>
            <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">out_str</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;coord {k} {x[0]:.16f} {x[1]:.16f} {x[2]:.16f} &quot;</span>
                        <span class="s2">&quot;{y[0]:.16f} {y[1]:.16f} {y[2]:.16f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">n</span><span class="p">))</span>
            <span class="n">out_str</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">out_str</span></div>
<div class="viewcode-block" id="CoarseGrainRNA.add_bulge_coords_from_stems"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.add_bulge_coords_from_stems">[docs]</a>    <span class="k">def</span> <span class="nf">add_bulge_coords_from_stems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Add the information about the starts and ends of the bulges (i and m elements).</span>
<span class="sd">        The stems have to be created beforehand.</span>

<span class="sd">        This is called during loading of the RNA structure from pdb and from cg files.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defines</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span>                    
                <span class="n">edges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">s1b</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sides</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">)</span>
                    <span class="p">(</span><span class="n">s2b</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sides</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">d</span><span class="p">)</span>

                    <span class="n">mids1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">mids2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

                    <span class="c1">#Save coordinates in direction of the strand.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_link_direction</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">d</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mids1</span><span class="p">[</span><span class="n">s1b</span><span class="p">],</span> <span class="n">mids2</span><span class="p">[</span><span class="n">s2b</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mids2</span><span class="p">[</span><span class="n">s2b</span><span class="p">],</span> <span class="n">mids1</span><span class="p">[</span><span class="n">s1b</span><span class="p">])</span></div>

<div class="viewcode-block" id="CoarseGrainRNA.add_all_virtual_residues"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.add_all_virtual_residues">[docs]</a>    <span class="k">def</span> <span class="nf">add_all_virtual_residues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls ftug.add_virtual_residues() for all stems of this RNA.</span>
<span class="sd">    </span>
<span class="sd">        .. note::</span>
<span class="sd">           Don&#39;t forget to call this again if you changed the structure of the RNA,</span>
<span class="sd">           to avoid leaving it in an inconsistent state.</span>

<span class="sd">        .. warning::</span>
<span class="sd">           Virtual residues are only added to stems, not to loop regions.</span>
<span class="sd">           The position of residues in loops is much more flexible, which is why virtual </span>
<span class="sd">           residue positions for loops usually do not make sense.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">stem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stem_iterator</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ftug</span><span class="o">.</span><span class="n">add_virtual_residues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stem</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">stem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">RnaMissing3dError</span><span class="p">(</span><span class="s2">&quot;No 3D coordinates available for stem {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stem</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">stem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">twists</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">RnaMissing3dError</span><span class="p">(</span><span class="s2">&quot;No twists available for stem {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stem</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="k">raise</span></div>
<div class="viewcode-block" id="CoarseGrainRNA.get_virtual_residue"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.get_virtual_residue">[docs]</a>    <span class="k">def</span> <span class="nf">get_virtual_residue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">allow_single_stranded</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the virtual residue for the nmucleotide at position pos (1-based)</span>

<span class="sd">        :param allow_single_stranded: If True and pos is not in a stem, return a</span>
<span class="sd">              rough estimate for the residue position instead of raising an error.</span>
<span class="sd">              Currenly, for non-stem elements, these positions are on the axis of the cg-element.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_node_from_residue_num</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;s&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">elem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">v3dposs</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">v3dposs</span><span class="p">[</span><span class="n">elem</span><span class="p">]:</span>
                <span class="n">ftug</span><span class="o">.</span><span class="n">add_virtual_residues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stem_length</span><span class="p">(</span><span class="n">elem</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span> <span class="o">==</span> <span class="n">pos</span><span class="p">:</span>
                    <span class="n">vres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v3dposs</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">return</span> <span class="n">vres</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">vres</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span> <span class="o">==</span> <span class="n">pos</span><span class="p">:</span>
                    <span class="n">vres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v3dposs</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">return</span> <span class="n">vres</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">vres</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_single_stranded</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Position {} is not in a stem! It is in {}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">elem</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;h&quot;</span><span class="p">:</span>
                <span class="c1">#We estimate the vres position along the axis of the hairpin.</span>
                <span class="n">h_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element_length</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="n">pos</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">h_length</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">h_length</span> <span class="o">-</span> <span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">perc</span> <span class="o">=</span> <span class="n">l</span> <span class="o">/</span> <span class="n">h_length</span>
            <span class="k">elif</span> <span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;i&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pos</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">perc</span> <span class="o">=</span> <span class="n">l</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">tl</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">perc</span> <span class="o">=</span> <span class="p">(</span><span class="n">tl</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span><span class="o">/</span><span class="n">tl</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">perc</span> <span class="o">=</span> <span class="n">l</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">element_length</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">elem</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">perc</span></div>
    
<div class="viewcode-block" id="CoarseGrainRNA.get_ordered_stem_poss"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.get_ordered_stem_poss">[docs]</a>    <span class="k">def</span> <span class="nf">get_ordered_stem_poss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sorted_stem_iterator</span><span class="p">():</span>
            <span class="n">points</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoarseGrainRNA.get_ordered_virtual_residue_poss"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.get_ordered_virtual_residue_poss">[docs]</a>    <span class="k">def</span> <span class="nf">get_ordered_virtual_residue_poss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the coordinates of all stem&#39;s virtual residues in a consistent order.</span>
<span class="sd">        </span>
<span class="sd">        This is used for RMSD calculation and is ment to replace ftug.bg_virtual_residues</span>
<span class="sd">        If no virtual_residue_positions are known, self.add_all_virtual_residues() is called </span>
<span class="sd">        automatically.</span>
<span class="sd">    </span>
<span class="sd">        :returns: A numpy array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">v3dposs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_all_virtual_residues</span><span class="p">()</span>
        <span class="n">vress</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sorted_stem_iterator</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stem_length</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
                <span class="n">vres</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">v3dposs</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">vress</span> <span class="o">+=</span> <span class="p">[</span><span class="n">vres</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">vres</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">vres</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">vres</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vress</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoarseGrainRNA.get_poss_for_domain"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.get_poss_for_domain">[docs]</a>    <span class="k">def</span> <span class="nf">get_poss_for_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fast&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get an array of coordinates only for the elements specified.</span>

<span class="sd">        ..note::</span>

<span class="sd">            This code is still experimental in the current version of forgi.</span>

<span class="sd">        :param elements: A list of coarse grain element names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">points</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;fast&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">elements</span><span class="p">):</span>
                <span class="n">points</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">e</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;vres&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">v3dposs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_all_virtual_residues</span><span class="p">()</span>
            <span class="n">vress</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">elements</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stem_length</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
                    <span class="n">vres</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">v3dposs</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">vress</span> <span class="o">+=</span> <span class="p">[</span><span class="n">vres</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">vres</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">vres</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">vres</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vress</span><span class="p">)</span></div>



<div class="viewcode-block" id="CoarseGrainRNA.get_twist_str"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.get_twist_str">[docs]</a>    <span class="k">def</span> <span class="nf">get_twist_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Place the twist vectors into a string. </span>

<span class="sd">        The format is:</span>

<span class="sd">            twist s1 x1 y1 z1 x2 y2 z2</span>

<span class="sd">        Where s1 is the name of the stem and (x1,y1,z1) and (x2,y2,z2) are</span>
<span class="sd">        the unit vectors from the start of each end of the stem to the middle</span>
<span class="sd">        of the base pairs.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">out_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">twists</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">twists</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">out_str</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;twist {k} {x[0]:.16f} {x[1]:.16f} {x[2]:.16f} &quot;</span>
                        <span class="s2">&quot;{y[0]:.16f} {y[1]:.16f} {y[2]:.16f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">n</span><span class="p">))</span>
            <span class="n">out_str</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">out_str</span></div>

<div class="viewcode-block" id="CoarseGrainRNA.get_long_range_str"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.get_long_range_str">[docs]</a>    <span class="k">def</span> <span class="nf">get_long_range_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">out_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">printed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">longrange</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">key2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">longrange</span><span class="p">[</span><span class="n">key1</span><span class="p">]:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="p">[</span><span class="n">key1</span><span class="p">,</span> <span class="n">key2</span><span class="p">]</span>
                <span class="n">k</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="n">k</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">printed</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">printed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

                <span class="n">out_str</span> <span class="o">+=</span> <span class="s2">&quot;longrange </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key1</span><span class="p">,</span> <span class="n">key2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out_str</span></div>

<div class="viewcode-block" id="CoarseGrainRNA.get_sampled_stems_str"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.get_sampled_stems_str">[docs]</a>    <span class="k">def</span> <span class="nf">get_sampled_stems_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampled</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">out_str</span> <span class="o">+=</span> <span class="s1">&#39;sampled </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampled</span><span class="p">[</span><span class="n">key</span><span class="p">])))</span>
        <span class="k">return</span> <span class="n">out_str</span></div>

<div class="viewcode-block" id="CoarseGrainRNA.to_cg_string"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.to_cg_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_cg_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Output this structure in string form.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">curr_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_bg_string</span><span class="p">()</span>
        <span class="n">curr_str</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coord_str</span><span class="p">()</span>
        <span class="n">curr_str</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_twist_str</span><span class="p">()</span>
        <span class="n">curr_str</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sampled_stems_str</span><span class="p">()</span>
        <span class="n">curr_str</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_long_range_str</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_from</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">curr_str</span><span class="o">+=</span><span class="s2">&quot;project {} {} {}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">project_from</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">curr_str</span></div>

<div class="viewcode-block" id="CoarseGrainRNA.to_file"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.to_file">[docs]</a>    <span class="k">def</span> <span class="nf">to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">cg_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_cg_string</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cg_str</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoarseGrainRNA.get_bulge_angle_stats_core"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.get_bulge_angle_stats_core">[docs]</a>    <span class="k">def</span> <span class="nf">get_bulge_angle_stats_core</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">define</span><span class="p">,</span> <span class="n">connections</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the angle stats for a particular bulge. These stats describe the</span>
<span class="sd">        relative orientation of the two stems that it connects.</span>

<span class="sd">        :param define: The name of the bulge.</span>
<span class="sd">        :param connections: The two stems that are connected by it.</span>
<span class="sd">        :return: ftms.AngleStat object</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="p">(</span><span class="n">stem1</span><span class="p">,</span> <span class="n">twist1</span><span class="p">,</span> <span class="n">stem2</span><span class="p">,</span> <span class="n">twist2</span><span class="p">,</span> <span class="n">bulge</span><span class="p">)</span> <span class="o">=</span> <span class="n">ftug</span><span class="o">.</span><span class="n">get_stem_twist_and_bulge_vecs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">define</span><span class="p">,</span> <span class="n">connections</span><span class="p">)</span>

        <span class="c1"># Get the orientations for orienting these two stems</span>
        <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">=</span> <span class="n">ftug</span><span class="o">.</span><span class="n">get_stem_orientation_parameters</span><span class="p">(</span><span class="n">stem1</span><span class="p">,</span> <span class="n">twist1</span><span class="p">,</span> 
                                                            <span class="n">stem2</span><span class="p">,</span> <span class="n">twist2</span><span class="p">)</span>
        <span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">u1</span><span class="p">,</span> <span class="n">v1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ftug</span><span class="o">.</span><span class="n">get_stem_separation_parameters</span><span class="p">(</span><span class="n">stem1</span><span class="p">,</span> <span class="n">twist1</span><span class="p">,</span> <span class="n">bulge</span><span class="p">)</span>

        <span class="n">dims</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bulge_dimensions</span><span class="p">(</span><span class="n">define</span><span class="p">)</span>
        <span class="n">ang_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_type</span><span class="p">(</span><span class="n">define</span><span class="p">,</span> <span class="n">connections</span><span class="p">)</span>
        <span class="n">seqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_define_seq_str</span><span class="p">(</span><span class="n">define</span><span class="p">,</span> <span class="n">adjacent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">angle_stat</span> <span class="o">=</span> <span class="n">ftms</span><span class="o">.</span><span class="n">AngleStat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> 
                                    <span class="n">u1</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">ang_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">define</span><span class="p">],</span> 
                                    <span class="n">seqs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">angle_stat</span></div>

<div class="viewcode-block" id="CoarseGrainRNA.get_loop_stat"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.get_loop_stat">[docs]</a>    <span class="k">def</span> <span class="nf">get_loop_stat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the statistics for this loop.</span>

<span class="sd">        These stats describe the relative orientation of the loop to the stem</span>
<span class="sd">        to which it is attached.</span>

<span class="sd">        :param d: The name of the loop</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">loop_stat</span> <span class="o">=</span> <span class="n">ftms</span><span class="o">.</span><span class="n">LoopStat</span><span class="p">()</span>
        <span class="n">loop_stat</span><span class="o">.</span><span class="n">pdb_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="n">loop_stat</span><span class="o">.</span><span class="n">bp_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_length</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">loop_stat</span><span class="o">.</span><span class="n">phys_length</span> <span class="o">=</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">stem1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">d</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">(</span><span class="n">s1b</span><span class="p">,</span> <span class="n">s1e</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sides</span><span class="p">(</span><span class="n">stem1</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

        <span class="n">stem1_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem1</span><span class="p">][</span><span class="n">s1b</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem1</span><span class="p">][</span><span class="n">s1e</span><span class="p">]</span>
        <span class="n">twist1_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">twists</span><span class="p">[</span><span class="n">stem1</span><span class="p">][</span><span class="n">s1b</span><span class="p">]</span>
        <span class="n">bulge_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 
        
        <span class="k">if</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">bulge_vec</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">10</span><span class="o">**-</span><span class="mi">3</span><span class="p">:</span> <span class="c1">#To avoid loops with 0 physical length. (If disconnects in the structure are modelled as loop)</span>
            <span class="n">bulge_vec</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">stem1_vec</span> <span class="o">/</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="n">stem1_vec</span><span class="p">))</span>

        <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="n">ftug</span><span class="o">.</span><span class="n">get_stem_separation_parameters</span><span class="p">(</span><span class="n">stem1_vec</span><span class="p">,</span> <span class="n">twist1_vec</span><span class="p">,</span> 
                                                      <span class="n">bulge_vec</span><span class="p">)</span>
        <span class="p">(</span><span class="n">loop_stat</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">loop_stat</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="n">loop_stat</span><span class="o">.</span><span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">loop_stat</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">loop_stat</span><span class="o">.</span><span class="n">phys_length</span> <span class="c1"># Will this cause problems in other parts of the code base???</span>
        <span class="k">return</span> <span class="n">loop_stat</span></div>

<div class="viewcode-block" id="CoarseGrainRNA.get_bulge_angle_stats"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.get_bulge_angle_stats">[docs]</a>    <span class="k">def</span> <span class="nf">get_bulge_angle_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bulge</span><span class="p">):</span>               
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the angle stats for a particular bulge. These stats describe </span>
<span class="sd">        the relative orientation of the two stems that it connects.</span>

<span class="sd">        :param bulge: The name of the bulge.</span>
<span class="sd">        :param connections: The two stems that are connected by it.</span>
<span class="sd">        :return: The angle statistics in one direction and angle statistics in</span>
<span class="sd">                 the other direction                    </span>
<span class="sd">        &#39;&#39;&#39;</span>  
        <span class="k">if</span> <span class="n">bulge</span> <span class="o">==</span> <span class="s1">&#39;start&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">ftms</span><span class="o">.</span><span class="n">AngleStat</span><span class="p">(),</span> <span class="n">ftms</span><span class="o">.</span><span class="n">AngleStat</span><span class="p">())</span>

        <span class="n">connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">(</span><span class="n">bulge</span><span class="p">)</span>

        <span class="n">angle_stat1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bulge_angle_stats_core</span><span class="p">(</span><span class="n">bulge</span><span class="p">,</span> <span class="n">connections</span><span class="p">)</span>
        <span class="n">angle_stat2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bulge_angle_stats_core</span><span class="p">(</span><span class="n">bulge</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">connections</span><span class="p">)))</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">angle_stat1</span><span class="p">,</span> <span class="n">angle_stat2</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoarseGrainRNA.get_stem_stats"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.get_stem_stats">[docs]</a>    <span class="k">def</span> <span class="nf">get_stem_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stem</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculate the statistics for a stem and return them. These statistics will describe the</span>
<span class="sd">        length of the stem as well as how much it twists.</span>

<span class="sd">        :param stem: The name of the stem.</span>

<span class="sd">        :return: A StemStat structure containing the above information.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="n">ftms</span><span class="o">.</span><span class="n">StemStat</span><span class="p">()</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">pdb_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="c1">#ss.bp_length = abs(self.defines[stem][0] - self.defines[stem][1])                                            </span>
        <span class="n">ss</span><span class="o">.</span><span class="n">bp_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stem_length</span><span class="p">(</span><span class="n">stem</span><span class="p">)</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">phys_length</span> <span class="o">=</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">magnitude</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">twist_angle</span> <span class="o">=</span> <span class="n">ftug</span><span class="o">.</span><span class="n">get_twist_angle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">twists</span><span class="p">[</span><span class="n">stem</span><span class="p">])</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">define</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">stem</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">ss</span></div>

    <span class="c1">#def get_loop_from_residue(self, residue) -&gt;  use BulgeGraph.get_node_from_residue_num()!</span>

<div class="viewcode-block" id="CoarseGrainRNA.from_file"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.from_file">[docs]</a>    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cg_filename</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Load this data structure from a file.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cg_filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">())</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">from_cg_string</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoarseGrainRNA.from_cg_string"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.from_cg_string">[docs]</a>    <span class="k">def</span> <span class="nf">from_cg_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cg_string</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Populate this structure from the string</span>
<span class="sd">        representation of a graph.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Reading the bulge_graph-part of the file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">from_bg_string</span><span class="p">(</span><span class="n">cg_string</span><span class="p">)</span>

        <span class="c1">#Reading the part of the file responsible for 3D information</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">cg_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;coord&#39;</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">])),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">]))])</span>
            <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;twist&#39;</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">twists</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">])),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">]))])</span>
            <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;longrange&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">longrange</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">longrange</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sampled&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sampled</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">:]))</span>
            <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;project&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project_from</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_bulge_coords_from_stems</span><span class="p">()</span> <span class="c1">#Old versions of the file may contain bulge coordinates in the wrong order.</span></div>

    
<div class="viewcode-block" id="CoarseGrainRNA.to_cg_file"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.to_cg_file">[docs]</a>    <span class="k">def</span> <span class="nf">to_cg_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Save this structure as a string in a file.</span>

<span class="sd">        :param filename: The filename to save it to.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;to_cg_file is deprecated. Use to_file!&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_cg_string</span><span class="p">()</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoarseGrainRNA.radius_of_gyration"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.radius_of_gyration">[docs]</a>    <span class="k">def</span> <span class="nf">radius_of_gyration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;fast&quot;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculate the radius of gyration of this structure.</span>

<span class="sd">        :param method: A STRING. one of </span>
<span class="sd">                       &quot;fast&quot; (use only coordinates of coarse grained stems) or</span>
<span class="sd">                       &quot;vres&quot; (use virtual residue coordinates of stems)</span>

<span class="sd">        :return: A number with the radius of gyration of this structure.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;fast&quot;</span><span class="p">:</span>
            <span class="n">coords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ordered_stem_poss</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;vres&quot;</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ordered_virtual_residue_poss</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong method {}. Choose one of &#39;fast&#39; and &#39;vres&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>

        <span class="n">rog</span> <span class="o">=</span> <span class="n">ftud</span><span class="o">.</span><span class="n">radius_of_gyration</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rog</span></div>

<div class="viewcode-block" id="CoarseGrainRNA.get_coordinates_list"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.get_coordinates_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_coordinates_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;CoarseGrainRNA.get_coordinates_list is deprecated and being &quot;</span>
                      <span class="s2">&quot;replaced by get_coordinates_array!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinates_array</span><span class="p">()</span></div>

<div class="viewcode-block" id="CoarseGrainRNA.get_coordinates_array"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.get_coordinates_array">[docs]</a>    <span class="k">def</span> <span class="nf">get_coordinates_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get all of the coordinates in one large array.</span>

<span class="sd">        The coordinates are sorted in the order of the keys</span>
<span class="sd">        in coordinates dictionary.</span>

<span class="sd">        :return: A 2D numpy array containing all coordinates</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">all_coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">key</span><span class="p">])):</span>
                <span class="n">all_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_coords</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoarseGrainRNA.load_coordinates_array"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.load_coordinates_array">[docs]</a>    <span class="k">def</span> <span class="nf">load_coordinates_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Read in an array of coordinates (as may be produced by get_coordinates_array)</span>
<span class="sd">        and replace the coordinates of this structure with it.</span>

<span class="sd">        :param coords: A 2D array of coordinates</span>
<span class="sd">        :return: self</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span> <span class="mi">2</span><span class="o">*</span><span class="n">j</span> <span class="p">],</span> <span class="n">coords</span><span class="p">[</span> <span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span> <span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="CoarseGrainRNA.get_twists"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.get_twists">[docs]</a>    <span class="k">def</span> <span class="nf">get_twists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; </span>
<span class="sd">        Get the array of twists for this node. If the node is a stem,</span>
<span class="sd">        then the twists will simply those stored in the array. </span>
<span class="sd">        If the node is an interior loop or a junction segment, </span>
<span class="sd">        then the twists will be the ones that are adjacent to it. </span>
<span class="sd">        If the node is a hairpin loop or a free end, then the same twist</span>
<span class="sd">        will be duplicated and returned twice.</span>

<span class="sd">        :param node: The name of the node</span>
<span class="sd">        &#39;&#39;&#39;</span>                                                                                                           
        <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">twists</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>                                                                                  

        <span class="n">connections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
        <span class="p">(</span><span class="n">s1b</span><span class="p">,</span> <span class="n">s1e</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sides</span><span class="p">(</span><span class="n">connections</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">connections</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">ftuv</span><span class="o">.</span><span class="n">vector_rejection</span><span class="p">(</span> 
                                  <span class="bp">self</span><span class="o">.</span><span class="n">twists</span><span class="p">[</span><span class="n">connections</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">s1b</span><span class="p">],</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">connections</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span>  
                                  <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">connections</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">vec</span><span class="p">,</span><span class="n">vec</span><span class="p">)</span>                                                  

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">connections</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> 
            <span class="c1"># interior loop or junction segment                                                                  </span>
            <span class="p">(</span><span class="n">s2b</span><span class="p">,</span> <span class="n">s2e</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sides</span><span class="p">(</span><span class="n">connections</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">node</span><span class="p">)</span> 
            <span class="n">bulge_vec</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">connections</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">s1b</span><span class="p">]</span> <span class="o">-</span> 
                         <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">connections</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">s2b</span><span class="p">])</span>                                                            
            <span class="k">return</span> <span class="p">(</span><span class="n">ftuv</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">ftuv</span><span class="o">.</span><span class="n">vector_rejection</span><span class="p">(</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">twists</span><span class="p">[</span><span class="n">connections</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">s1b</span><span class="p">],</span> <span class="n">bulge_vec</span><span class="p">)),</span>
                    <span class="n">ftuv</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">ftuv</span><span class="o">.</span><span class="n">vector_rejection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">twists</span><span class="p">[</span><span class="n">connections</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">s2b</span><span class="p">],</span> <span class="n">bulge_vec</span><span class="p">)))</span>  

        <span class="c1"># uh oh, this shouldn&#39;t happen since every node                 </span>
        <span class="c1"># should have either one or two edges </span>
        <span class="k">assert</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="CoarseGrainRNA.element_physical_distance"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.element_physical_distance">[docs]</a>    <span class="k">def</span> <span class="nf">element_physical_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element1</span><span class="p">,</span> <span class="n">element2</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculate the physical distance between two coarse grain elements.</span>

<span class="sd">        :param element1: The name of the first element (e.g. &#39;s1&#39;)</span>
<span class="sd">        :param element2: The name of the first element (e.g. &#39;s2&#39;)</span>
<span class="sd">        :return: The closest distance between the two elements.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">line_segment_distance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">element1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">element1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">element2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">element2</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">ftuv</span><span class="o">.</span><span class="n">vec_distance</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">)</span></div>
    

<div class="viewcode-block" id="CoarseGrainRNA.longrange_iterator"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.longrange_iterator">[docs]</a>    <span class="k">def</span> <span class="nf">longrange_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_connected</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Iterate over all long range interactions in this molecule.</span>
<span class="sd">        </span>
<span class="sd">        :param filter_connected: Filter interactions that are between elements</span>
<span class="sd">                                 which are connected (mostly meaning multiloops</span>
<span class="sd">                                 which connect to the same end of the same stem)</span>
<span class="sd">        :return: A generator yielding long-range interaction tuples (i.e. (&#39;s7&#39;, &#39;i2&#39;))</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">partner1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">longrange</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">partner2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">longrange</span><span class="p">[</span><span class="n">partner1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">filter_connected</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">(</span><span class="n">partner1</span><span class="p">,</span> <span class="n">partner2</span><span class="p">):</span>
                        <span class="k">continue</span>

                <span class="n">interaction</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">partner1</span><span class="p">,</span> <span class="n">partner2</span><span class="p">]))</span>

                <span class="c1"># check if we&#39;ve already seen this interaction</span>
                <span class="k">if</span> <span class="n">interaction</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">interaction</span><span class="p">)</span>

                <span class="k">yield</span> <span class="n">interaction</span></div>

<div class="viewcode-block" id="CoarseGrainRNA.total_length"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.total_length">[docs]</a>    <span class="k">def</span> <span class="nf">total_length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculate the combined length of all the elements.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">define_residue_num_iterator</span><span class="p">(</span><span class="n">d</span><span class="p">)))</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defines</span><span class="p">])</span></div>

<div class="viewcode-block" id="CoarseGrainRNA.sorted_edges_for_mst"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.sorted_edges_for_mst">[docs]</a>    <span class="k">def</span> <span class="nf">sorted_edges_for_mst</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Keep track of all linked nodes. Used for the generation of the minimal spanning tree.</span>

<span class="sd">        This overrides the function in bulge graph and adds an additional sorting criterion </span>
<span class="sd">        with lowest priority.</span>
<span class="sd">        Elements that have no entry in self.sampled should be preferedly broken.</span>
<span class="sd">        This should ensure that the minimal spanning tree is the same after saving </span>
<span class="sd">        and loading an RNA to/from a file, if changes of the minimal spanning tree </span>
<span class="sd">        were performed by ernwin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">priority</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mloop_iterator</span><span class="p">(),</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">iloop_iterator</span><span class="p">()),</span>
                       <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">priority</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_node_dimensions</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span><span class="ow">not</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampled</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">edges</span></div>
  
<div class="viewcode-block" id="CoarseGrainRNA.coords_to_directions"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.coords_to_directions">[docs]</a>    <span class="k">def</span> <span class="nf">coords_to_directions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The directions of each coarse grain element. One line per cg-element.</span>

<span class="sd">        The array is sorted by the corresponding element names alphabetically (`sorted(defines.keys()`)</span>
<span class="sd">        The directions usually point away from the elemnt&#39;s lowest nucleotide.</span>
<span class="sd">        However h,t and f elements always point away from the connected stem.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinates_array</span><span class="p">()</span>
        <span class="n">directions</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">directions</span></div>
<div class="viewcode-block" id="CoarseGrainRNA.coords_from_directions"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.coords_from_directions">[docs]</a>    <span class="k">def</span> <span class="nf">coords_from_directions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate coordinates from direction vectors (using also their lengths)</span>

<span class="sd">        Currently ignores the twists!</span>

<span class="sd">        :param directions: An array of vectors from the side of a cg-element with lower nucleotide number to the side with higher number</span>
<span class="sd">                           The array is sorted by the corresponding element names alphabetically (`sorted(defines.keys()`)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sorted_defines</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defines</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_defines</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">directions</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_order</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traverse_graph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;s0&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">directions</span><span class="p">[</span><span class="n">sorted_defines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;s0&quot;</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">stem1</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">stem2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_order</span><span class="p">:</span> <span class="c1">#Bulges and stems</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_ends</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_type</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="p">[</span><span class="n">stem1</span><span class="p">,</span><span class="n">stem2</span><span class="p">]))</span>            
            <span class="n">link_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_link_direction</span><span class="p">(</span><span class="n">stem1</span><span class="p">,</span> <span class="n">stem2</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">link_dir</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">link</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem1</span><span class="p">][</span><span class="n">conn</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem1</span><span class="p">][</span><span class="n">conn</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">+</span><span class="n">directions</span><span class="p">[</span><span class="n">sorted_defines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">link</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">conn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">link</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">link</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">directions</span><span class="p">[</span><span class="n">sorted_defines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">stem2</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">link</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">directions</span><span class="p">[</span><span class="n">sorted_defines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">stem2</span><span class="p">)],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">link</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">link</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem1</span><span class="p">][</span><span class="n">conn</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">directions</span><span class="p">[</span><span class="n">sorted_defines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">link</span><span class="p">)],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem1</span><span class="p">][</span><span class="n">conn</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">conn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">link</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">link</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">directions</span><span class="p">[</span><span class="n">sorted_defines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">stem2</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">link</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">directions</span><span class="p">[</span><span class="n">sorted_defines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">stem2</span><span class="p">)],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">link</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;m&quot;</span> <span class="ow">and</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mst</span><span class="p">:</span>
                <span class="n">edges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>
                <span class="p">(</span><span class="n">s1b</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sides</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">)</span>
                <span class="p">(</span><span class="n">s2b</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sides</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">d</span><span class="p">)</span>
                <span class="n">mids1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">mids2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="c1">#Save coordinates in direction of the strand.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_link_direction</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">d</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mids1</span><span class="p">[</span><span class="n">s1b</span><span class="p">],</span> <span class="n">mids2</span><span class="p">[</span><span class="n">s2b</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mids2</span><span class="p">[</span><span class="n">s2b</span><span class="p">],</span> <span class="n">mids1</span><span class="p">[</span><span class="n">s1b</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="s2">&quot;hft&quot;</span><span class="p">:</span> <span class="c1">#Loops</span>
                <span class="n">stem</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
                <span class="p">(</span><span class="n">s1b</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sides</span><span class="p">(</span><span class="n">stem</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem</span><span class="p">][</span><span class="n">s1b</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">stem</span><span class="p">][</span><span class="n">s1b</span><span class="p">]</span> <span class="o">+</span> <span class="n">directions</span><span class="p">[</span><span class="n">sorted_defines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span></div>

<div class="viewcode-block" id="CoarseGrainRNA.virtual_atoms"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.virtual_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">virtual_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get virtual atoms for a key.</span>

<span class="sd">        :param key: An INTEGER: The number of the base in the RNA. </span>
<span class="sd">                    Returns a dict {&quot;C8&quot;:np.array([x,y,z]), ...}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
             <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_virtual_atom_cache</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_virtual_atom_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">ftug</span><span class="o">.</span><span class="n">virtual_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">)[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_all_virtual_residues</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_virtual_atom_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">ftug</span><span class="o">.</span><span class="n">virtual_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">)[</span><span class="n">key</span><span class="p">]</span>
             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_virtual_atom_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected an int, found {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span></div>

<div class="viewcode-block" id="CoarseGrainRNA.reset_vatom_cache"><a class="viewcode-back" href="../../../../apidoc/forgi.threedee.model.coarse_grain.html#forgi.threedee.model.coarse_grain.CoarseGrainRNA.reset_vatom_cache">[docs]</a>    <span class="k">def</span> <span class="nf">reset_vatom_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Used as on_call function for the observing of the self.coords dictionary.</span>

<span class="sd">        :param key: A coarse grain element name, e.g. &quot;s1&quot; or &quot;m15&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_virtual_atom_cache</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> <span class="c1">#Happens during deepcopy</span>
            <span class="k">return</span> 

        <span class="n">define</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">defines</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1">#Delete virtual residues</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">vposs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">vbases</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">vvecs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">v3dposs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">vinvs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="k">pass</span>

        <span class="c1">#Delete virtual atoms</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">define</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">define</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">define</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_virtual_atom_cache</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_virtual_atom_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">define</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">define</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">define</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_virtual_atom_cache</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_virtual_atom_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div></div>
    <span class="c1">#def __deepcopy__(self, memo):</span>

<span class="sd">&quot;&quot;&quot;        </span>
<span class="sd">def cg_from_sg(cg, sg):</span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="sd">    Create a coarse-grain structure from a subgraph.</span>
<span class="sd">    </span>
<span class="sd">    ..warning::</span>

<span class="sd">        If the list of elements in sg is inconsistent (e.g. contains only parts of a multiloop)</span>
<span class="sd">        this will currently proceed without an error but return an </span>
<span class="sd">        inconsistent CoarseGrainRNA object!</span>
<span class="sd">  </span>
<span class="sd">    :param cg: The original structure</span>
<span class="sd">    :param sg: The list of elements that are in the subgraph</span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="sd">    new_cg = CoarseGrainRNA()</span>
<span class="sd">    </span>
<span class="sd">    for d in sg:</span>
<span class="sd">        new_cg.defines[d] = cg.defines[d]</span>
<span class="sd">        new_cg.coords[d] = cg.coords[d]</span>
<span class="sd">        if d in cg.twists:</span>
<span class="sd">            new_cg.twists[d] = cg.twists[d]</span>
<span class="sd">        new_cg.longrange[d] = cg.longrange[d]</span>
<span class="sd">        </span>
<span class="sd">        for x in cg.edges[d]:</span>
<span class="sd">            if x in new_cg.defines.keys():</span>
<span class="sd">                new_cg.edges[d].add(x)</span>
<span class="sd">                new_cg.edges[x].add(d)</span>
<span class="sd">    </span>
<span class="sd">    return new_cg&quot;&quot;&quot;</span>

</pre></div>

      </div>
      <div class="bottomnav">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2012-2016 Peter Kerpedjiev &lt;pkerp@tbi.univie.ac.at&gt;; 2015,2016 Bernhard Thiel &lt;thiel@tbi.univie.ac.at&gt;.
      Last updated on Sep 05, 2016.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.
    </div>
  </body>
</html>